"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SigaaHTTPSession = void 0;

require("source-map-support/register");

var _lodash = require("lodash");

var _url = require("url");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * @category Internal
 */
class SigaaHTTPSession {
  /**
   */
  constructor(institutionController, cookiesController, pageCache, requestStack) {
    this.institutionController = institutionController;
    this.cookiesController = cookiesController;
    this.pageCache = pageCache;
    this.requestStack = requestStack;

    _defineProperty(this, "requestPromises", []);
  }
  /**
   * @inheritdoc
   */


  async afterDownloadRequest(url, downloadPath, sessionHttpOptions, finalPath) {
    return finalPath;
  }
  /**
   * @inheritdoc
   */


  async beforeDownloadRequest() {
    return null;
  }

  get requestStacks() {
    return this.requestStack.getStacksByDomain(this.institutionController.url.href);
  }

  /**
   * @inheritdoc
   */
  getURL(path) {
    return new _url.URL(path, this.institutionController.url.href);
  }
  /**
   * @inheritdoc
   */


  async afterUnsuccessfulRequest(err, httpOptions, body) {
    const requestPromise = this.findAndRemovePromiseRequest({
      httpOptions,
      body
    });

    if (requestPromise) {
      requestPromise.reject(err);
    }

    throw err;
  }
  /**
   * @inheritdoc
   */


  findAndRemovePromiseRequest(request) {
    const index = this.requestPromises.findIndex(requestPromise => (0, _lodash.isEqual)(request.httpOptions, requestPromise.request.httpOptions) && requestPromise.request.body === request.body);

    if (index !== -1) {
      return this.requestPromises.splice(index, 1)[0];
    }

    return null;
  }
  /**
   * @inheritdoc
   */


  async afterSuccessfulRequest(page) {
    const requestPromise = this.findAndRemovePromiseRequest({
      body: page.requestBody,
      httpOptions: page.requestOptions
    });
    const setCookie = page.headers['set-cookie'];

    if (setCookie) {
      const cookies = typeof setCookie === 'string' ? [setCookie] : setCookie;
      this.cookiesController.storeCookies(page.requestOptions.hostname, cookies);
    }

    if (page.statusCode === 200) {
      if (page.requestBody === undefined || typeof page.requestBody === 'string') this.pageCache.storePage(page);
    }

    if (requestPromise) {
      requestPromise.resolve(page);
    }

    return page;
  }
  /**
   * @inheritdoc
   */


  async afterHTTPOptions(link, httpOptions) {
    const cookie = this.cookiesController.getCookieHeader(link.hostname, link.pathname);

    if (cookie) {
      httpOptions.headers.Cookie = cookie;
    }

    return httpOptions;
  }
  /**
   * @inheritdoc
   */


  async beforeRequest(url, httpOptions, requestBody, options) {
    if (!(options !== null && options !== void 0 && options.noCache)) {
      const page = this.pageCache.getPage(httpOptions, requestBody);
      if (page) return page;
    }

    const stack = !httpOptions.headers.Cookie ? this.requestStacks.noCookie : httpOptions.method === 'POST' ? this.requestStacks.post : this.requestStacks.get;
    const request = {
      httpOptions,
      body: requestBody
    };

    if ((requestBody === undefined || typeof requestBody == 'string') && options !== null && options !== void 0 && options.shareSameRequest) {
      const runningRequest = stack.promises.find(request => request.key.body === requestBody && (0, _lodash.isEqual)(httpOptions, request.key.httpOptions));

      if (runningRequest !== null && runningRequest !== void 0 && runningRequest.promise) {
        return runningRequest.promise;
      }
    }

    await new Promise(awaitResolve => {
      stack.addPromise(request, () => {
        awaitResolve();
        return new Promise((resolve, reject) => {
          this.requestPromises.push({
            request,
            resolve,
            reject
          });
        });
      });
    });
    return null;
  }
  /**
   * @inheritdoc
   */


  close() {
    this.cookiesController.clearCookies();
    this.pageCache.clearCachePage();
  }

}

exports.SigaaHTTPSession = SigaaHTTPSession;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXNzaW9uL3NpZ2FhLWh0dHAtc2Vzc2lvbi50cyJdLCJuYW1lcyI6WyJTaWdhYUhUVFBTZXNzaW9uIiwiY29uc3RydWN0b3IiLCJpbnN0aXR1dGlvbkNvbnRyb2xsZXIiLCJjb29raWVzQ29udHJvbGxlciIsInBhZ2VDYWNoZSIsInJlcXVlc3RTdGFjayIsImFmdGVyRG93bmxvYWRSZXF1ZXN0IiwidXJsIiwiZG93bmxvYWRQYXRoIiwic2Vzc2lvbkh0dHBPcHRpb25zIiwiZmluYWxQYXRoIiwiYmVmb3JlRG93bmxvYWRSZXF1ZXN0IiwicmVxdWVzdFN0YWNrcyIsImdldFN0YWNrc0J5RG9tYWluIiwiaHJlZiIsImdldFVSTCIsInBhdGgiLCJVUkwiLCJhZnRlclVuc3VjY2Vzc2Z1bFJlcXVlc3QiLCJlcnIiLCJodHRwT3B0aW9ucyIsImJvZHkiLCJyZXF1ZXN0UHJvbWlzZSIsImZpbmRBbmRSZW1vdmVQcm9taXNlUmVxdWVzdCIsInJlamVjdCIsInJlcXVlc3QiLCJpbmRleCIsInJlcXVlc3RQcm9taXNlcyIsImZpbmRJbmRleCIsInNwbGljZSIsImFmdGVyU3VjY2Vzc2Z1bFJlcXVlc3QiLCJwYWdlIiwicmVxdWVzdEJvZHkiLCJyZXF1ZXN0T3B0aW9ucyIsInNldENvb2tpZSIsImhlYWRlcnMiLCJjb29raWVzIiwic3RvcmVDb29raWVzIiwiaG9zdG5hbWUiLCJzdGF0dXNDb2RlIiwidW5kZWZpbmVkIiwic3RvcmVQYWdlIiwicmVzb2x2ZSIsImFmdGVySFRUUE9wdGlvbnMiLCJsaW5rIiwiY29va2llIiwiZ2V0Q29va2llSGVhZGVyIiwicGF0aG5hbWUiLCJDb29raWUiLCJiZWZvcmVSZXF1ZXN0Iiwib3B0aW9ucyIsIm5vQ2FjaGUiLCJnZXRQYWdlIiwic3RhY2siLCJub0Nvb2tpZSIsIm1ldGhvZCIsInBvc3QiLCJnZXQiLCJzaGFyZVNhbWVSZXF1ZXN0IiwicnVubmluZ1JlcXVlc3QiLCJwcm9taXNlcyIsImZpbmQiLCJrZXkiLCJwcm9taXNlIiwiUHJvbWlzZSIsImF3YWl0UmVzb2x2ZSIsImFkZFByb21pc2UiLCJwdXNoIiwiY2xvc2UiLCJjbGVhckNvb2tpZXMiLCJjbGVhckNhY2hlUGFnZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBRUE7Ozs7QUE0SEE7QUFDQTtBQUNBO0FBQ08sTUFBTUEsZ0JBQU4sQ0FBOEM7QUFDbkQ7QUFDRjtBQUVFQyxFQUFBQSxXQUFXLENBQ0ZDLHFCQURFLEVBRURDLGlCQUZDLEVBR0RDLFNBSEMsRUFJREMsWUFKQyxFQUtUO0FBQUEsU0FKT0gscUJBSVAsR0FKT0EscUJBSVA7QUFBQSxTQUhRQyxpQkFHUixHQUhRQSxpQkFHUjtBQUFBLFNBRlFDLFNBRVIsR0FGUUEsU0FFUjtBQUFBLFNBRFFDLFlBQ1IsR0FEUUEsWUFDUjs7QUFBQSw2Q0EyQmlELEVBM0JqRDtBQUFFO0FBRUo7QUFDRjtBQUNBOzs7QUFDNEIsUUFBcEJDLG9CQUFvQixDQUN4QkMsR0FEd0IsRUFFeEJDLFlBRndCLEVBR3hCQyxrQkFId0IsRUFJeEJDLFNBSndCLEVBS1A7QUFDakIsV0FBT0EsU0FBUDtBQUNEO0FBRUQ7QUFDRjtBQUNBOzs7QUFDNkIsUUFBckJDLHFCQUFxQixHQUFrQjtBQUMzQyxXQUFPLElBQVA7QUFDRDs7QUFFZ0IsTUFBYkMsYUFBYSxHQUFpQztBQUNoRCxXQUFPLEtBQUtQLFlBQUwsQ0FBa0JRLGlCQUFsQixDQUNMLEtBQUtYLHFCQUFMLENBQTJCSyxHQUEzQixDQUErQk8sSUFEMUIsQ0FBUDtBQUdEOztBQUlEO0FBQ0Y7QUFDQTtBQUNFQyxFQUFBQSxNQUFNLENBQUNDLElBQUQsRUFBb0I7QUFDeEIsV0FBTyxJQUFJQyxRQUFKLENBQVFELElBQVIsRUFBYyxLQUFLZCxxQkFBTCxDQUEyQkssR0FBM0IsQ0FBK0JPLElBQTdDLENBQVA7QUFDRDtBQUVEO0FBQ0Y7QUFDQTs7O0FBQ2dDLFFBQXhCSSx3QkFBd0IsQ0FDNUJDLEdBRDRCLEVBRTVCQyxXQUY0QixFQUc1QkMsSUFINEIsRUFJYjtB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QW9CbEIsWUFBQUE7QUFBcEIsV0FBMUI7QUFDRCxTQUZNLENBQVA7QUFHRCxPQUxEO0FBTUQsS0FQSyxDQUFOO0FBU0EsV0FBTyxJQUFQO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7OztBQUNFNEMsRUFBQUEsS0FBSyxHQUFTO0FBQ1osU0FBS2pFLGlCQUFMLENBQXVCa0UsWUFBdkI7QUFDQSxTQUFLakUsU0FBTCxDQUFla0UsY0FBZjtBQUNEOztBQXhMa0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc0VxdWFsIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IFJlcXVlc3RTdGFja3MgfSBmcm9tICdAaGVscGVycy9zaWdhYS1yZXF1ZXN0LXN0YWNrJztcbmltcG9ydCB7IFVSTCB9IGZyb20gJ3VybCc7XG5pbXBvcnQge1xuICBIVFRQUmVxdWVzdE9wdGlvbnMsXG4gIFByb2dyZXNzQ2FsbGJhY2ssXG4gIFNpZ2FhUmVxdWVzdE9wdGlvbnNcbn0gZnJvbSAnLi9zaWdhYS1odHRwJztcbmltcG9ydCB7IFBhZ2UsIFNpZ2FhUGFnZSB9IGZyb20gJy4vc2lnYWEtcGFnZSc7XG5pbXBvcnQgeyBQYWdlQ2FjaGUgfSBmcm9tICcuL3NpZ2FhLXBhZ2UtY2FjaGUnO1xuaW1wb3J0IHsgQ29va2llc0NvbnRyb2xsZXIgfSBmcm9tICcuL3NpZ2FhLWNvb2tpZXMtY29udHJvbGxlcic7XG5pbXBvcnQgeyBSZXF1ZXN0U3RhY2tDb250cm9sbGVyIH0gZnJvbSAnLi4vaGVscGVycy9zaWdhYS1yZXF1ZXN0LXN0YWNrJztcbmltcG9ydCB7IEluc3RpdHV0aW9uQ29udHJvbGxlciB9IGZyb20gJy4vc2lnYWEtaW5zdGl0dXRpb24tY29udHJvbGxlcic7XG5cbi8qKlxuICogTWFuYWdlIGEgaHR0cCBzZXNzaW9uXG4gKiBAY2F0ZWdvcnkgSW50ZXJuYWxcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBIVFRQU2Vzc2lvbiB7XG4gIGluc3RpdHV0aW9uQ29udHJvbGxlcjogSW5zdGl0dXRpb25Db250cm9sbGVyO1xuICAvKipcbiAgICogaWYgcmV0dXJucyBzdHJpbmcgdGhlIGRvd25sb2FkIGlzIHN1c3BlbmRlZFxuICAgKiBAcGFyYW0gdXJsXG4gICAqIEBwYXJhbSBzZXNzaW9uSHR0cE9wdGlvbnNcbiAgICogQHBhcmFtIHJlcXVlc3RCb2R5XG4gICAqL1xuICBiZWZvcmVEb3dubG9hZFJlcXVlc3QoXG4gICAgdXJsOiBVUkwsXG4gICAgZG93bmxvYWRQYXRoOiBzdHJpbmcsXG4gICAgc2Vzc2lvbkh0dHBPcHRpb25zOiBIVFRQUmVxdWVzdE9wdGlvbnMsXG4gICAgYm9keVJlcXVlc3Q/OiBzdHJpbmcsXG4gICAgY2FsbGJhY2s/OiBQcm9ncmVzc0NhbGxiYWNrXG4gICk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD47XG5cbiAgYWZ0ZXJEb3dubG9hZFJlcXVlc3QoXG4gICAgdXJsOiBVUkwsXG4gICAgZG93bmxvYWRQYXRoOiBzdHJpbmcsXG4gICAgc2Vzc2lvbkh0dHBPcHRpb25zOiBIVFRQUmVxdWVzdE9wdGlvbnMsXG4gICAgZmluYWxQYXRoOiBzdHJpbmcsXG4gICAgYm9keVJlcXVlc3Q/OiBzdHJpbmcsXG4gICAgY2FsbGJhY2s/OiBQcm9ncmVzc0NhbGxiYWNrXG4gICk6IFByb21pc2U8c3RyaW5nPjtcblxuICAvKipcbiAgICogaXQgaXMgY2FsbGVkIGFmdGVyIGEgc2lnYWEgcmVzcG9uc2UsIG9ubHkgaWYgc3VjY2Vzc2Z1bC4gU2hvdWxkIHJldHVybiBhIHBhZ2Ugb3IgdGhyb3cgYW4gZXJyb3IuXG4gICAqIEBwYXJhbSBwYWdlIFNpZ2FhIHBhZ2VcbiAgICogQHBhcmFtIG9wdGlvbnMgUmVxdWVzdCBPcHRpb25zXG4gICAqL1xuICBhZnRlclN1Y2Nlc3NmdWxSZXF1ZXN0KFxuICAgIHBhZ2U6IFBhZ2UsXG4gICAgb3B0aW9ucz86IFNpZ2FhUmVxdWVzdE9wdGlvbnNcbiAgKTogUHJvbWlzZTxQYWdlPjtcblxuICAvKipcbiAgICogSXQgaXMgY2FsbGVkIGFmdGVyIGEgZXJyb3IgaW4gcmVxdWVzdC4gWW91IG11c3QgcmV0dXJuIGEgcGFnZSBvciB0aHJvdyBhbiBlcnJvci5cbiAgICogQHBhcmFtIHBhZ2UgU2lnYWEgcGFnZVxuICAgKiBAcGFyYW0gb3B0aW9ucyBSZXF1ZXN0IE9wdGlvbnNcbiAgICovXG4gIGFmdGVyVW5zdWNjZXNzZnVsUmVxdWVzdChcbiAgICBlcnI6IEVycm9yLFxuICAgIGh0dHBPcHRpb25zOiBIVFRQUmVxdWVzdE9wdGlvbnMsXG4gICAgYm9keT86IHN0cmluZyB8IEJ1ZmZlclxuICApOiBQcm9taXNlPFBhZ2U+O1xuXG4gIC8qKlxuICAgKiBUcmFuc2Zvcm1zIGEgcGF0aCBpbiBVUkxcbiAgICogQHBhcmFtIHBhdGhcbiAgICovXG4gIGdldFVSTChwYXRoOiBzdHJpbmcpOiBVUkw7XG5cbiAgLyoqXG4gICAqIEl0IGlzIGNhbGxlZCBiZWZvcmUgdGhlIHJlcXVlc3QsIGl0IG1heSBiZSB1c2VmdWwgdG8gZGVsYXkuXG4gICAqIElmIHlvdSByZXR1cm4gYSBwYWdlLCB0aGUgYW5zd2VyIHdpbGwgYmUgdGhlIHBhZ2UgYW5kIHRoZXJlIHdpbGwgYmUgbm8gaHR0cCByZXF1ZXN0XG4gICAqIElmIGl0IHJldHVybnMgbnVsbCwgdGhlIHJlcXVlc3Qgd2lsbCBjb250aW51ZSBhcyBub3JtYWwgYW5kIGlmIHlvdSB3YW50IHRvIHN1c3BlbmQgdGhlIHJlcXVlc3QsIGl0IG1heSBnZW5lcmF0ZSBhbiBlcnJvci5cbiAgICogQHBhcmFtIGxpbmtcbiAgICogQHBhcmFtIGh0dHBPcHRpb25zXG4gICAqIEBwYXJhbSBib2R5XG4gICAqIEBwYXJhbSBvcHRpb25zXG4gICAqL1xuICBiZWZvcmVSZXF1ZXN0KFxuICAgIGxpbms6IFVSTCxcbiAgICBodHRwT3B0aW9uczogSFRUUFJlcXVlc3RPcHRpb25zLFxuICAgIGJvZHk/OiBzdHJpbmcgfCBCdWZmZXIsXG4gICAgb3B0aW9ucz86IFNpZ2FhUmVxdWVzdE9wdGlvbnNcbiAgKTogUHJvbWlzZTxQYWdlIHwgbnVsbD47XG5cbiAgLyoqXG4gICAqIFRoaXMgaXMgY2FsbGVkIHRvIG1vZGlmeSB0aGUgcmVxdWVzdCBvcHRpb25zXG4gICAqIFRJUDogWW91IG11c3QgYXQgbGVhc3QgaW5zZXJ0IHRoZSBjb29raWVzLlxuICAgKiBAcGFyYW0gbGlua1xuICAgKiBAcGFyYW0gaHR0cE9wdGlvbnNcbiAgICogQHBhcmFtIGJvZHlcbiAgICogQHBhcmFtIG9wdGlvbnNcbiAgICovXG4gIGFmdGVySFRUUE9wdGlvbnMoXG4gICAgbGluazogVVJMLFxuICAgIGh0dHBPcHRpb25zOiBIVFRQUmVxdWVzdE9wdGlvbnMsXG4gICAgYm9keT86IHN0cmluZyB8IEJ1ZmZlcixcbiAgICBvcHRpb25zPzogU2lnYWFSZXF1ZXN0T3B0aW9uc1xuICApOiBQcm9taXNlPEhUVFBSZXF1ZXN0T3B0aW9ucz47XG5cbiAgLyoqXG4gICAqICBGbHVzaCBhbGwgY29va2llcyBhbmQgY2FjaGUgb2Ygc2Vzc2lvblxuICAgKi9cbiAgY2xvc2UoKTogdm9pZDtcbn1cblxuLyoqXG4gKiBJbnRlcmZhY2UgZm9yIHJlcXVlc3QgcGFyYW1zXG4gKiBAY2F0ZWdvcnkgSW50ZXJuYWxcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBSZXF1ZXN0IHtcbiAgaHR0cE9wdGlvbnM6IEhUVFBSZXF1ZXN0T3B0aW9ucztcbiAgYm9keT86IHN0cmluZyB8IEJ1ZmZlcjtcbn1cblxuLyoqXG4gKiBJbnRlcmZhY2UgdG8gam9pbiBiZWZvcmVSZXF1ZXN0IGFuZCBhZnRlclJlcXVlc3RcbiAqIEBjYXRlZ29yeSBJbnRlcm5hbFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJlcXVlc3RQcm9taXNlVHJhY2tlciB7XG4gIHJlcXVlc3Q6IFJlcXVlc3Q7XG4gIHJlc29sdmUocGFnZTogUGFnZSk6IHZvaWQ7XG4gIHJlamVjdChlcnI6IEVycm9yKTogdm9pZDtcbn1cblxuLyoqXG4gKiBAY2F0ZWdvcnkgSW50ZXJuYWxcbiAqL1xuZXhwb3J0IGNsYXNzIFNpZ2FhSFRUUFNlc3Npb24gaW1wbGVtZW50cyBIVFRQU2Vzc2lvbiB7XG4gIC8qKlxuICAgKi9cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgaW5zdGl0dXRpb25Db250cm9sbGVyOiBJbnN0aXR1dGlvbkNvbnRyb2xsZXIsXG4gICAgcHJpdmF0ZSBjb29raWVzQ29udHJvbGxlcjogQ29va2llc0NvbnRyb2xsZXIsXG4gICAgcHJpdmF0ZSBwYWdlQ2FjaGU6IFBhZ2VDYWNoZSxcbiAgICBwcml2YXRlIHJlcXVlc3RTdGFjazogUmVxdWVzdFN0YWNrQ29udHJvbGxlcjxSZXF1ZXN0LCBQYWdlPlxuICApIHt9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqL1xuICBhc3luYyBhZnRlckRvd25sb2FkUmVxdWVzdChcbiAgICB1cmw6IFVSTCxcbiAgICBkb3dubG9hZFBhdGg6IHN0cmluZyxcbiAgICBzZXNzaW9uSHR0cE9wdGlvbnM6IEhUVFBSZXF1ZXN0T3B0aW9ucyxcbiAgICBmaW5hbFBhdGg6IHN0cmluZ1xuICApOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBmaW5hbFBhdGg7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICovXG4gIGFzeW5jIGJlZm9yZURvd25sb2FkUmVxdWVzdCgpOiBQcm9taXNlPG51bGw+IHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGdldCByZXF1ZXN0U3RhY2tzKCk6IFJlcXVlc3RTdGFja3M8UmVxdWVzdCwgUGFnZT4ge1xuICAgIHJldHVybiB0aGlzLnJlcXVlc3RTdGFjay5nZXRTdGFja3NCeURvbWFpbihcbiAgICAgIHRoaXMuaW5zdGl0dXRpb25Db250cm9sbGVyLnVybC5ocmVmXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVxdWVzdFByb21pc2VzOiBSZXF1ZXN0UHJvbWlzZVRyYWNrZXJbXSA9IFtdO1xuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKi9cbiAgZ2V0VVJMKHBhdGg6IHN0cmluZyk6IFVSTCB7XG4gICAgcmV0dXJuIG5ldyBVUkwocGF0aCwgdGhpcy5pbnN0aXR1dGlvbkNvbnRyb2xsZXIudXJsLmhyZWYpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqL1xuICBhc3luYyBhZnRlclVuc3VjY2Vzc2Z1bFJlcXVlc3QoXG4gICAgZXJyOiBFcnJvcixcbiAgICBodHRwT3B0aW9uczogSFRUUFJlcXVlc3RPcHRpb25zLFxuICAgIGJvZHk/OiBzdHJpbmcgfCBCdWZmZXJcbiAgKTogUHJvbWlzZTxQYWdlPiB7XG4gICAgY29uc3QgcmVxdWVzdFByb21pc2UgPSB0aGlzLmZpbmRBbmRSZW1vdmVQcm9taXNlUmVxdWVzdCh7XG4gICAgICBodHRwT3B0aW9ucyxcbiAgICAgIGJvZHlcbiAgICB9KTtcbiAgICBpZiAocmVxdWVzdFByb21pc2UpIHtcbiAgICAgIHJlcXVlc3RQcm9taXNlLnJlamVjdChlcnIpO1xuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICovXG4gIHByaXZhdGUgZmluZEFuZFJlbW92ZVByb21pc2VSZXF1ZXN0KFxuICAgIHJlcXVlc3Q6IFJlcXVlc3RcbiAgKTogUmVxdWVzdFByb21pc2VUcmFja2VyIHwgbnVsbCB7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLnJlcXVlc3RQcm9taXNlcy5maW5kSW5kZXgoXG4gICAgICAocmVxdWVzdFByb21pc2UpID0+XG4gICAgICAgIGlzRXF1YWwocmVxdWVzdC5odHRwT3B0aW9ucywgcmVxdWVzdFByb21pc2UucmVxdWVzdC5odHRwT3B0aW9ucykgJiZcbiAgICAgICAgcmVxdWVzdFByb21pc2UucmVxdWVzdC5ib2R5ID09PSByZXF1ZXN0LmJvZHlcbiAgICApO1xuICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgIHJldHVybiB0aGlzLnJlcXVlc3RQcm9taXNlcy5zcGxpY2UoaW5kZXgsIDEpWzBdO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKi9cbiAgYXN5bmMgYWZ0ZXJTdWNjZXNzZnVsUmVxdWVzdChwYWdlOiBTaWdhYVBhZ2UpOiBQcm9taXNlPFBhZ2U+IHtcbiAgICBjb25zdCByZXF1ZXN0UHJvbWlzZSA9IHRoaXMuZmluZEFuZFJlbW92ZVByb21pc2VSZXF1ZXN0KHtcbiAgICAgIGJvZHk6IHBhZ2UucmVxdWVzdEJvZHksXG4gICAgICBodHRwT3B0aW9uczogcGFnZS5yZXF1ZXN0T3B0aW9uc1xuICAgIH0pO1xuICAgIGNvbnN0IHNldENvb2tpZSA9IHBhZ2UuaGVhZGVyc1snc2V0LWNvb2tpZSddO1xuICAgIGlmIChzZXRDb29raWUpIHtcbiAgICAgIGNvbnN0IGNvb2tpZXMgPSB0eXBlb2Ygc2V0Q29va2llID09PSAnc3RyaW5nJyA/IFtzZXRDb29raWVdIDogc2V0Q29va2llO1xuXG4gICAgICB0aGlzLmNvb2tpZXNDb250cm9sbGVyLnN0b3JlQ29va2llcyhcbiAgICAgICAgcGFnZS5yZXF1ZXN0T3B0aW9ucy5ob3N0bmFtZSxcbiAgICAgICAgY29va2llc1xuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKHBhZ2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICBpZiAoXG4gICAgICAgIHBhZ2UucmVxdWVzdEJvZHkgPT09IHVuZGVmaW5lZCB8fFxuICAgICAgICB0eXBlb2YgcGFnZS5yZXF1ZXN0Qm9keSA9PT0gJ3N0cmluZydcbiAgICAgIClcbiAgICAgICAgdGhpcy5wYWdlQ2FjaGUuc3RvcmVQYWdlKHBhZ2UpO1xuICAgIH1cblxuICAgIGlmIChyZXF1ZXN0UHJvbWlzZSkge1xuICAgICAgcmVxdWVzdFByb21pc2UucmVzb2x2ZShwYWdlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcGFnZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKi9cbiAgYXN5bmMgYWZ0ZXJIVFRQT3B0aW9ucyhcbiAgICBsaW5rOiBVUkwsXG4gICAgaHR0cE9wdGlvbnM6IEhUVFBSZXF1ZXN0T3B0aW9uc1xuICApOiBQcm9taXNlPEhUVFBSZXF1ZXN0T3B0aW9ucz4ge1xuICAgIGNvbnN0IGNvb2tpZSA9IHRoaXMuY29va2llc0NvbnRyb2xsZXIuZ2V0Q29va2llSGVhZGVyKFxuICAgICAgbGluay5ob3N0bmFtZSxcbiAgICAgIGxpbmsucGF0aG5hbWVcbiAgICApO1xuICAgIGlmIChjb29raWUpIHtcbiAgICAgIGh0dHBPcHRpb25zLmhlYWRlcnMuQ29va2llID0gY29va2llO1xuICAgIH1cbiAgICByZXR1cm4gaHR0cE9wdGlvbnM7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICovXG4gIGFzeW5jIGJlZm9yZVJlcXVlc3QoXG4gICAgdXJsOiBVUkwsXG4gICAgaHR0cE9wdGlvbnM6IEhUVFBSZXF1ZXN0T3B0aW9ucyxcbiAgICByZXF1ZXN0Qm9keT86IHN0cmluZyB8IEJ1ZmZlcixcbiAgICBvcHRpb25zPzogU2lnYWFSZXF1ZXN0T3B0aW9uc1xuICApOiBQcm9taXNlPFBhZ2UgfCBudWxsPiB7XG4gICAgaWYgKCFvcHRpb25zPy5ub0NhY2hlKSB7XG4gICAgICBjb25zdCBwYWdlID0gdGhpcy5wYWdlQ2FjaGUuZ2V0UGFnZShodHRwT3B0aW9ucywgcmVxdWVzdEJvZHkpO1xuICAgICAgaWYgKHBhZ2UpIHJldHVybiBwYWdlO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YWNrID0gIWh0dHBPcHRpb25zLmhlYWRlcnMuQ29va2llXG4gICAgICA/IHRoaXMucmVxdWVzdFN0YWNrcy5ub0Nvb2tpZVxuICAgICAgOiBodHRwT3B0aW9ucy5tZXRob2QgPT09ICdQT1NUJ1xuICAgICAgPyB0aGlzLnJlcXVlc3RTdGFja3MucG9zdFxuICAgICAgOiB0aGlzLnJlcXVlc3RTdGFja3MuZ2V0O1xuXG4gICAgY29uc3QgcmVxdWVzdDogUmVxdWVzdCA9IHtcbiAgICAgIGh0dHBPcHRpb25zLFxuICAgICAgYm9keTogcmVxdWVzdEJvZHlcbiAgICB9O1xuICAgIGlmIChcbiAgICAgIChyZXF1ZXN0Qm9keSA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiByZXF1ZXN0Qm9keSA9PSAnc3RyaW5nJykgJiZcbiAgICAgIG9wdGlvbnM/LnNoYXJlU2FtZVJlcXVlc3RcbiAgICApIHtcbiAgICAgIGNvbnN0IHJ1bm5pbmdSZXF1ZXN0ID0gc3RhY2sucHJvbWlzZXMuZmluZChcbiAgICAgICAgKHJlcXVlc3QpID0+XG4gICAgICAgICAgcmVxdWVzdC5rZXkuYm9keSA9PT0gcmVxdWVzdEJvZHkgJiZcbiAgICAgICAgICBpc0VxdWFsKGh0dHBPcHRpb25zLCByZXF1ZXN0LmtleS5odHRwT3B0aW9ucylcbiAgICAgICk7XG4gICAgICBpZiAocnVubmluZ1JlcXVlc3Q/LnByb21pc2UpIHtcbiAgICAgICAgcmV0dXJuIHJ1bm5pbmdSZXF1ZXN0LnByb21pc2U7XG4gICAgICB9XG4gICAgfVxuICAgIGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KChhd2FpdFJlc29sdmUpID0+IHtcbiAgICAgIHN0YWNrLmFkZFByb21pc2UocmVxdWVzdCwgKCkgPT4ge1xuICAgICAgICBhd2FpdFJlc29sdmUoKTtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPFBhZ2U+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICB0aGlzLnJlcXVlc3RQcm9taXNlcy5wdXNoKHsgcmVxdWVzdCwgcmVzb2x2ZSwgcmVqZWN0IH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICovXG4gIGNsb3NlKCk6IHZvaWQge1xuICAgIHRoaXMuY29va2llc0NvbnRyb2xsZXIuY2xlYXJDb29raWVzKCk7XG4gICAgdGhpcy5wYWdlQ2FjaGUuY2xlYXJDYWNoZVBhZ2UoKTtcbiAgfVxufVxuIl19
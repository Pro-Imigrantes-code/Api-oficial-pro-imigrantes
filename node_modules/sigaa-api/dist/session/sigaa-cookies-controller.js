"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SigaaCookiesController = void 0;

require("source-map-support/register");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Store cookies.
 * @category Internal
 */
class SigaaCookiesController {
  constructor() {
    _defineProperty(this, "cookies", []);
  }

  /**
   * @inheritdoc
   */
  storeCookies(domain, cookies) {
    for (let setCookie of cookies) {
      const cookieName = (setCookie.match(/^[^()<>@,;:\\" \t\n/[\]?={}]+/) || [])[0];

      if (!cookieName) {
        continue;
      }

      setCookie = setCookie.substr(cookieName.length); //if cookie value start with double-quotes

      let cookieValue;

      if (setCookie.charAt(1) == '"') {
        cookieValue = (setCookie.substr(2).match(/^[^" \t\n,;\\]+/) || [])[0];
      } else {
        cookieValue = (setCookie.substr(1).match(/^[^" \t\n,;\\]+/) || [])[0];
      }

      if (!cookieValue) {
        break;
      }

      const cookie = {
        name: cookieName,
        value: cookieValue,
        domain
      };

      if (setCookie.includes(' ')) {
        setCookie = setCookie.substr(setCookie.indexOf(' ') + 1);
      } else {
        setCookie = '';
      }

      let maxAgeFlagFound = false;
      let invalidCookie = false; //parse cookies flags

      const flags = setCookie.split('; ');

      for (const flag of flags) {
        if (flag.match(/^Path=/)) {
          cookie.path = flag.replace(/^Path=/, '');
        } else if (flag.match(/^Domain=/)) {
          const cookieDomainFlag = flag.replace(/^Domain=\.?/, '');

          if (('.' + domain).endsWith('.' + cookieDomainFlag)) {
            cookie.domainFlag = flag.replace(/^Domain=\.?/, '');
          } else {
            invalidCookie = true;
            break;
          }
        } else if (flag.match(/^Max-Age=/)) {
          maxAgeFlagFound = true;
          const maxAge = Number(flag.replace(/^Max-Age=/, ''));
          cookie.expires = new Date(Date.now() + maxAge * 1000);
        } else if (!maxAgeFlagFound && flag.match(/^Expires=/)) {
          const expires = flag.replace(/^Expires=/, '');
          cookie.expires = new Date(expires);
        }
      }

      if (!invalidCookie) this.cookies.unshift(cookie);
    }
  }
  /**
   * @inheritdoc
   */


  getCookieHeader(domain, path) {
    const dateNow = Date.now();
    const validCookies = this.cookies.filter(cookie => !cookie.path || path.startsWith(cookie.path)).filter(cookie => ('.' + domain).endsWith('.' + (cookie.domainFlag || cookie.domain))).filter(cookie => !cookie.expires || cookie.expires.valueOf() >= dateNow);
    if (validCookies.length === 0) return null;
    const cookies = validCookies.filter( //Filter duplicated cookie
    (cookie, index) => index === validCookies.findIndex(findCookie => findCookie.name === cookie.name)).map(cookie => `${cookie.name}=${cookie.value}`).reverse().join('; ');

    if (!cookies) {
      return null;
    }

    return cookies;
  }
  /**
   * @inheritdoc
   */


  clearCookies() {
    this.cookies = [];
  }

}

exports.SigaaCookiesController = SigaaCookiesController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXNzaW9uL3NpZ2FhLWNvb2tpZXMtY29udHJvbGxlci50cyJdLCJuYW1lcyI6WyJTaWdhYUNvb2tpZXNDb250cm9sbGVyIiwic3RvcmVDb29raWVzIiwiZG9tYWluIiwiY29va2llcyIsInNldENvb2tpZSIsImNvb2tpZU5hbWUiLCJtYXRjaCIsInN1YnN0ciIsImxlbmd0aCIsImNvb2tpZVZhbHVlIiwiY2hhckF0IiwiY29va2llIiwibmFtZSIsInZhbHVlIiwiaW5jbHVkZXMiLCJpbmRleE9mIiwibWF4QWdlRmxhZ0ZvdW5kIiwiaW52YWxpZENvb2tpZSIsImZsYWdzIiwic3BsaXQiLCJmbGFnIiwicGF0aCIsInJlcGxhY2UiLCJjb29raWVEb21haW5GbGFnIiwiZW5kc1dpdGgiLCJkb21haW5GbGFnIiwibWF4QWdlIiwiTnVtYmVyIiwiZXhwaXJlcyIsIkRhdGUiLCJub3ciLCJ1bnNoaWZ0IiwiZ2V0Q29va2llSGVhZGVyIiwiZGF0ZU5vdyIsInZhbGlkQ29va2llcyIsImZpbHRlciIsInN0YXJ0c1dpdGgiLCJ2YWx1ZU9mIiwiaW5kZXgiLCJmaW5kSW5kZXgiLCJmaW5kQ29va2llIiwibWFwIiwicmV2ZXJzZSIsImpvaW4iLCJjbGVhckNvb2tpZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBbUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ08sTUFBTUEsc0JBQU4sQ0FBMEQ7QUFBQTtBQUFBLHFDQW1HbkMsRUFuR21DO0FBQUE7O0FBQy9EO0FBQ0Y7QUFDQTtBQUNFQyxFQUFBQSxZQUFZLENBQUNDLE1BQUQsRUFBaUJDLE9BQWpCLEVBQTBDO0FBQ3BELFNBQUssSUFBSUMsU0FBVCxJQUFzQkQsT0FBdEIsRUFBK0I7QUFDN0IsWUFBTUUsVUFBVSxHQUFHLENBQUNELFNBQVMsQ0FBQ0UsS0FBVixDQUFnQiwrQkFBaEIsS0FDbEIsRUFEaUIsRUFDYixDQURhLENBQW5COztBQUVBLFVBQUksQ0FBQ0QsVUFBTCxFQUFpQjtBQUNmO0FBQ0Q7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S0FBTSxFQVRsQyxFQVViNkIsT0FWYSxHQVdiQyxJQVhhLENBV1IsSUFYUSxDQUFoQjs7QUFZQSxRQUFJLENBQUN4QyxPQUFMLEVBQWM7QUFDWixhQUFPLElBQVA7QUFDRDs7QUFDRCxXQUFPQSxPQUFQO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7OztBQUNFeUMsRUFBQUEsWUFBWSxHQUFTO0FBQ25CLFNBQUt6QyxPQUFMLEdBQWUsRUFBZjtBQUNEOztBQWpHOEQiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFN0b3JlIGNvb2tpZXMuXG4gKiBAY2F0ZWdvcnkgSW50ZXJuYWxcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDb29raWVzQ29udHJvbGxlciB7XG4gIC8qKlxuICAgKiBSZXR1cm5zIGRvbWFpbiBjb29raWVzIG9yIG51bGwgaWYgbm90aGluZy5cbiAgICogQHBhcmFtIGRvbWFpbiBkb21haW4gb2YgcmVxdWVzdFxuICAgKiBAcGFyYW0gcGF0aCBwYXRoIG9mIHJlcXVlc3RcbiAgICogQHJldHVybnMgaGVhZGVyIGNvb2tpZSB2YWx1ZSBvciBudWxsIGlmIG5vdCBoYXZlIGNvb2tpZXMuXG4gICAqL1xuICBnZXRDb29raWVIZWFkZXIoZG9tYWluOiBzdHJpbmcsIHBhdGg6IHN0cmluZyk6IHN0cmluZyB8IG51bGw7XG5cbiAgLyoqXG4gICAqIFN0b3JlIGNvb2tpZXNcbiAgICogQHBhcmFtIGRvbWFpbiBwYWdlIGRvbWFpbiB3aXRob3V0IGh0dHBzOi8vXG4gICAqIEBwYXJhbSBjb29raWVzIGNvb2tpZXMgdG8gc3RvcmUgKGFycmF5IG9mIFNldC1Db29raWUgaGVhZGVyKVxuICAgKi9cbiAgc3RvcmVDb29raWVzKGRvbWFpbjogc3RyaW5nLCBjb29raWVzOiBzdHJpbmdbXSk6IHZvaWQ7XG5cbiAgLyoqXG4gICAqIGZsdXNoIGFsbCBjb29raWVzXG4gICAqL1xuICBjbGVhckNvb2tpZXMoKTogdm9pZDtcbn1cblxuaW50ZXJmYWNlIENvb2tpZSB7XG4gIG5hbWU6IHN0cmluZztcbiAgdmFsdWU6IHN0cmluZztcbiAgcGF0aD86IHN0cmluZztcbiAgZXhwaXJlcz86IERhdGU7XG4gIGRvbWFpbjogc3RyaW5nO1xuICBkb21haW5GbGFnPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIFN0b3JlIGNvb2tpZXMuXG4gKiBAY2F0ZWdvcnkgSW50ZXJuYWxcbiAqL1xuZXhwb3J0IGNsYXNzIFNpZ2FhQ29va2llc0NvbnRyb2xsZXIgaW1wbGVtZW50cyBDb29raWVzQ29udHJvbGxlciB7XG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKi9cbiAgc3RvcmVDb29raWVzKGRvbWFpbjogc3RyaW5nLCBjb29raWVzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgIGZvciAobGV0IHNldENvb2tpZSBvZiBjb29raWVzKSB7XG4gICAgICBjb25zdCBjb29raWVOYW1lID0gKHNldENvb2tpZS5tYXRjaCgvXlteKCk8PkAsOzpcXFxcXCIgXFx0XFxuL1tcXF0/PXt9XSsvKSB8fFxuICAgICAgICBbXSlbMF07XG4gICAgICBpZiAoIWNvb2tpZU5hbWUpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBzZXRDb29raWUgPSBzZXRDb29raWUuc3Vic3RyKGNvb2tpZU5hbWUubGVuZ3RoKTtcbiAgICAgIC8vaWYgY29va2llIHZhbHVlIHN0YXJ0IHdpdGggZG91YmxlLXF1b3Rlc1xuICAgICAgbGV0IGNvb2tpZVZhbHVlO1xuICAgICAgaWYgKHNldENvb2tpZS5jaGFyQXQoMSkgPT0gJ1wiJykge1xuICAgICAgICBjb29raWVWYWx1ZSA9IChzZXRDb29raWUuc3Vic3RyKDIpLm1hdGNoKC9eW15cIiBcXHRcXG4sO1xcXFxdKy8pIHx8IFtdKVswXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvb2tpZVZhbHVlID0gKHNldENvb2tpZS5zdWJzdHIoMSkubWF0Y2goL15bXlwiIFxcdFxcbiw7XFxcXF0rLykgfHwgW10pWzBdO1xuICAgICAgfVxuICAgICAgaWYgKCFjb29raWVWYWx1ZSkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNvbnN0IGNvb2tpZTogQ29va2llID0ge1xuICAgICAgICBuYW1lOiBjb29raWVOYW1lLFxuICAgICAgICB2YWx1ZTogY29va2llVmFsdWUsXG4gICAgICAgIGRvbWFpblxuICAgICAgfTtcbiAgICAgIGlmIChzZXRDb29raWUuaW5jbHVkZXMoJyAnKSkge1xuICAgICAgICBzZXRDb29raWUgPSBzZXRDb29raWUuc3Vic3RyKHNldENvb2tpZS5pbmRleE9mKCcgJykgKyAxKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNldENvb2tpZSA9ICcnO1xuICAgICAgfVxuICAgICAgbGV0IG1heEFnZUZsYWdGb3VuZCA9IGZhbHNlO1xuICAgICAgbGV0IGludmFsaWRDb29raWUgPSBmYWxzZTtcbiAgICAgIC8vcGFyc2UgY29va2llcyBmbGFnc1xuICAgICAgY29uc3QgZmxhZ3MgPSBzZXRDb29raWUuc3BsaXQoJzsgJyk7XG4gICAgICBmb3IgKGNvbnN0IGZsYWcgb2YgZmxhZ3MpIHtcbiAgICAgICAgaWYgKGZsYWcubWF0Y2goL15QYXRoPS8pKSB7XG4gICAgICAgICAgY29va2llLnBhdGggPSBmbGFnLnJlcGxhY2UoL15QYXRoPS8sICcnKTtcbiAgICAgICAgfSBlbHNlIGlmIChmbGFnLm1hdGNoKC9eRG9tYWluPS8pKSB7XG4gICAgICAgICAgY29uc3QgY29va2llRG9tYWluRmxhZyA9IGZsYWcucmVwbGFjZSgvXkRvbWFpbj1cXC4/LywgJycpO1xuICAgICAgICAgIGlmICgoJy4nICsgZG9tYWluKS5lbmRzV2l0aCgnLicgKyBjb29raWVEb21haW5GbGFnKSkge1xuICAgICAgICAgICAgY29va2llLmRvbWFpbkZsYWcgPSBmbGFnLnJlcGxhY2UoL15Eb21haW49XFwuPy8sICcnKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaW52YWxpZENvb2tpZSA9IHRydWU7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoZmxhZy5tYXRjaCgvXk1heC1BZ2U9LykpIHtcbiAgICAgICAgICBtYXhBZ2VGbGFnRm91bmQgPSB0cnVlO1xuICAgICAgICAgIGNvbnN0IG1heEFnZSA9IE51bWJlcihmbGFnLnJlcGxhY2UoL15NYXgtQWdlPS8sICcnKSk7XG4gICAgICAgICAgY29va2llLmV4cGlyZXMgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgbWF4QWdlICogMTAwMCk7XG4gICAgICAgIH0gZWxzZSBpZiAoIW1heEFnZUZsYWdGb3VuZCAmJiBmbGFnLm1hdGNoKC9eRXhwaXJlcz0vKSkge1xuICAgICAgICAgIGNvbnN0IGV4cGlyZXMgPSBmbGFnLnJlcGxhY2UoL15FeHBpcmVzPS8sICcnKTtcbiAgICAgICAgICBjb29raWUuZXhwaXJlcyA9IG5ldyBEYXRlKGV4cGlyZXMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoIWludmFsaWRDb29raWUpIHRoaXMuY29va2llcy51bnNoaWZ0KGNvb2tpZSk7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKi9cbiAgZ2V0Q29va2llSGVhZGVyKGRvbWFpbjogc3RyaW5nLCBwYXRoOiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcbiAgICBjb25zdCBkYXRlTm93ID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCB2YWxpZENvb2tpZXM6IENvb2tpZVtdID0gdGhpcy5jb29raWVzXG4gICAgICAuZmlsdGVyKChjb29raWUpID0+ICFjb29raWUucGF0aCB8fCBwYXRoLnN0YXJ0c1dpdGgoY29va2llLnBhdGgpKVxuICAgICAgLmZpbHRlcigoY29va2llKSA9PlxuICAgICAgICAoJy4nICsgZG9tYWluKS5lbmRzV2l0aCgnLicgKyAoY29va2llLmRvbWFpbkZsYWcgfHwgY29va2llLmRvbWFpbikpXG4gICAgICApXG4gICAgICAuZmlsdGVyKFxuICAgICAgICAoY29va2llKSA9PiAhY29va2llLmV4cGlyZXMgfHwgY29va2llLmV4cGlyZXMudmFsdWVPZigpID49IGRhdGVOb3dcbiAgICAgICk7XG5cbiAgICBpZiAodmFsaWRDb29raWVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7XG4gICAgY29uc3QgY29va2llcyA9IHZhbGlkQ29va2llc1xuICAgICAgLmZpbHRlcihcbiAgICAgICAgLy9GaWx0ZXIgZHVwbGljYXRlZCBjb29raWVcbiAgICAgICAgKGNvb2tpZSwgaW5kZXgpID0+XG4gICAgICAgICAgaW5kZXggPT09XG4gICAgICAgICAgdmFsaWRDb29raWVzLmZpbmRJbmRleChcbiAgICAgICAgICAgIChmaW5kQ29va2llKSA9PiBmaW5kQ29va2llLm5hbWUgPT09IGNvb2tpZS5uYW1lXG4gICAgICAgICAgKVxuICAgICAgKVxuICAgICAgLm1hcCgoY29va2llKSA9PiBgJHtjb29raWUubmFtZX09JHtjb29raWUudmFsdWV9YClcbiAgICAgIC5yZXZlcnNlKClcbiAgICAgIC5qb2luKCc7ICcpO1xuICAgIGlmICghY29va2llcykge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiBjb29raWVzO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqL1xuICBjbGVhckNvb2tpZXMoKTogdm9pZCB7XG4gICAgdGhpcy5jb29raWVzID0gW107XG4gIH1cblxuICBwcml2YXRlIGNvb2tpZXM6IENvb2tpZVtdID0gW107XG59XG4iXX0=
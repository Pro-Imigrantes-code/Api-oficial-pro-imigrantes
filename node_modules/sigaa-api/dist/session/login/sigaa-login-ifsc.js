"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SigaaLoginIFSC = void 0;

require("source-map-support/register");

var _sigaaTypes = require("../../sigaa-types");

var _url = require("url");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Responsible for logging in IFSC.
 * @category Internal
 */
class SigaaLoginIFSC {
  constructor(http, session) {
    this.http = http;
    this.session = session;

    _defineProperty(this, "errorInvalidCredentials", 'SIGAA: Invalid credentials.');

    _defineProperty(this, "form", void 0);
  }

  parseLoginForm(page) {
    const formElement = page.$("form[name='loginForm']");
    const actionUrl = formElement.attr('action');
    if (!actionUrl) throw new Error('SIGAA: No action form on login page.');
    const action = new _url.URL(actionUrl, page.url.href);
    const postValues = {};
    formElement.find('input').each((index, element) => {
      const name = page.$(element).attr('name');
      if (name) postValues[name] = page.$(element).val();
    });
    return {
      action,
      postValues
    };
  }
  /**
   * Current login form.
   */


  /**
   * Retuns HTML form
   */
  async getLoginForm() {
    if (this.form) {
      return this.form;
    } else {
      const page = await this.http.get('/sigaa/verTelaLogin.do');
      return this.parseLoginForm(page);
    }
  }
  /**
   * Start a session on desktop
   * @param username
   * @param password
   */


  async desktopLogin(username, password) {
    const {
      action,
      postValues
    } = await this.getLoginForm();
    postValues['user.login'] = username;
    postValues['user.senha'] = password;
    const page = await this.http.post(action.href, postValues);
    return await this.parseDesktopLoginResult(page);
  }
  /**
   * Start a session on Sigaa, return login reponse page
   * @param username
   * @param password
   */


  async login(username, password, retry = true) {
    if (this.session.loginStatus === _sigaaTypes.LoginStatus.Authenticated) throw new Error('SIGAA: This session already has a user logged in.');

    try {
      const page = await this.desktopLogin(username, password);
      return this.http.followAllRedirect(page);
    } catch (error) {
      if (!retry || error.message === this.errorInvalidCredentials) {
        throw error;
      } else {
        return this.login(username, password, false);
      }
    }
  }

  async parseDesktopLoginResult(page) {
    const accountPage = await this.http.followAllRedirect(page);

    if (accountPage.bodyDecoded.includes('Entrar no Sistema')) {
      if (accountPage.bodyDecoded.includes('Usuário e/ou senha inválidos')) {
        this.form = await this.parseLoginForm(accountPage);
        throw new Error(this.errorInvalidCredentials);
      } else {
        throw new Error('SIGAA: Invalid response after login attempt.');
      }
    } else {
      this.session.loginStatus = _sigaaTypes.LoginStatus.Authenticated;
      return accountPage;
    }
  }

}

exports.SigaaLoginIFSC = SigaaLoginIFSC;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXNzaW9uL2xvZ2luL3NpZ2FhLWxvZ2luLWlmc2MudHMiXSwibmFtZXMiOlsiU2lnYWFMb2dpbklGU0MiLCJjb25zdHJ1Y3RvciIsImh0dHAiLCJzZXNzaW9uIiwicGFyc2VMb2dpbkZvcm0iLCJwYWdlIiwiZm9ybUVsZW1lbnQiLCIkIiwiYWN0aW9uVXJsIiwiYXR0ciIsIkVycm9yIiwiYWN0aW9uIiwiVVJMIiwidXJsIiwiaHJlZiIsInBvc3RWYWx1ZXMiLCJmaW5kIiwiZWFjaCIsImluZGV4IiwiZWxlbWVudCIsIm5hbWUiLCJ2YWwiLCJnZXRMb2dpbkZvcm0iLCJmb3JtIiwiZ2V0IiwiZGVza3RvcExvZ2luIiwidXNlcm5hbWUiLCJwYXNzd29yZCIsInBvc3QiLCJwYXJzZURlc2t0b3BMb2dpblJlc3VsdCIsImxvZ2luIiwicmV0cnkiLCJsb2dpblN0YXR1cyIsIkxvZ2luU3RhdHVzIiwiQXV0aGVudGljYXRlZCIsImZvbGxvd0FsbFJlZGlyZWN0IiwiZXJyb3IiLCJtZXNzYWdlIiwiZXJyb3JJbnZhbGlkQ3JlZGVudGlhbHMiLCJhY2NvdW50UGFnZSIsImJvZHlEZWNvZGVkIiwiaW5jbHVkZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOzs7O0FBT0E7QUFDQTtBQUNBO0FBQ0E7QUFDTyxNQUFNQSxjQUFOLENBQXNDO0FBQzNDQyxFQUFBQSxXQUFXLENBQVdDLElBQVgsRUFBaUNDLE9BQWpDLEVBQW1EO0FBQUEsU0FBeENELElBQXdDLEdBQXhDQSxJQUF3QztBQUFBLFNBQWxCQyxPQUFrQixHQUFsQkEsT0FBa0I7O0FBQUEscURBQzNCLDZCQUQyQjs7QUFBQTtBQUFFOztBQUd0REMsRUFBQUEsY0FBYyxDQUFDQyxJQUFELEVBQTRCO0FBQ2xELFVBQU1DLFdBQVcsR0FBR0QsSUFBSSxDQUFDRSxDQUFMLENBQU8sd0JBQVAsQ0FBcEI7QUFFQSxVQUFNQyxTQUFTLEdBQUdGLFdBQVcsQ0FBQ0csSUFBWixDQUFp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LENBQXdCQyxRQUF4QixDQUFpQyxtQkFBakMsQ0FBSixFQUEyRDtBQUN6RCxVQUFJRixXQUFXLENBQUNDLFdBQVosQ0FBd0JDLFFBQXhCLENBQWlDLDhCQUFqQyxDQUFKLEVBQXNFO0FBQ3BFLGFBQUtsQixJQUFMLEdBQVksTUFBTSxLQUFLbkIsY0FBTCxDQUFvQm1DLFdBQXBCLENBQWxCO0FBQ0EsY0FBTSxJQUFJN0IsS0FBSixDQUFVLEtBQUs0Qix1QkFBZixDQUFOO0FBQ0QsT0FIRCxNQUdPO0FBQ0wsY0FBTSxJQUFJNUIsS0FBSixDQUFVLDhDQUFWLENBQU47QUFDRDtBQUNGLEtBUEQsTUFPTztBQUNMLFdBQUtQLE9BQUwsQ0FBYTZCLFdBQWIsR0FBMkJDLHdCQUFZQyxhQUF2QztBQUNBLGFBQU9LLFdBQVA7QUFDRDtBQUNGOztBQTdGMEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2dpblN0YXR1cyB9IGZyb20gJy4uLy4uL3NpZ2FhLXR5cGVzJztcbmltcG9ydCB7IFVSTCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgeyBIVFRQIH0gZnJvbSAnLi4vc2lnYWEtaHR0cCc7XG5pbXBvcnQgeyBTZXNzaW9uIH0gZnJvbSAnLi4vc2lnYWEtc2Vzc2lvbic7XG5pbXBvcnQgeyBMb2dpbiB9IGZyb20gJy4vc2lnYWEtbG9naW4nO1xuaW1wb3J0IHsgSUZTQ1BhZ2UgfSBmcm9tICdAc2Vzc2lvbi9wYWdlL3NpZ2FhLXBhZ2UtaWZzYyc7XG5pbXBvcnQgeyBTaWdhYUZvcm0gfSBmcm9tICdAc2Vzc2lvbi9zaWdhYS1wYWdlJztcblxuLyoqXG4gKiBSZXNwb25zaWJsZSBmb3IgbG9nZ2luZyBpbiBJRlNDLlxuICogQGNhdGVnb3J5IEludGVybmFsXG4gKi9cbmV4cG9ydCBjbGFzcyBTaWdhYUxvZ2luSUZTQyBpbXBsZW1lbnRzIExvZ2luIHtcbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGh0dHA6IEhUVFAsIHByb3RlY3RlZCBzZXNzaW9uOiBTZXNzaW9uKSB7fVxuICByZWFkb25seSBlcnJvckludmFsaWRDcmVkZW50aWFscyA9ICdTSUdBQTogSW52YWxpZCBjcmVkZW50aWFscy4nO1xuXG4gIHByb3RlY3RlZCBwYXJzZUxvZ2luRm9ybShwYWdlOiBJRlNDUGFnZSk6IFNpZ2FhRm9ybSB7XG4gICAgY29uc3QgZm9ybUVsZW1lbnQgPSBwYWdlLiQoXCJmb3JtW25hbWU9J2xvZ2luRm9ybSddXCIpO1xuXG4gICAgY29uc3QgYWN0aW9uVXJsID0gZm9ybUVsZW1lbnQuYXR0cignYWN0aW9uJyk7XG4gICAgaWYgKCFhY3Rpb25VcmwpIHRocm93IG5ldyBFcnJvcignU0lHQUE6IE5vIGFjdGlvbiBmb3JtIG9uIGxvZ2luIHBhZ2UuJyk7XG5cbiAgICBjb25zdCBhY3Rpb24gPSBuZXcgVVJMKGFjdGlvblVybCwgcGFnZS51cmwuaHJlZik7XG5cbiAgICBjb25zdCBwb3N0VmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG5cbiAgICBmb3JtRWxlbWVudC5maW5kKCdpbnB1dCcpLmVhY2goKGluZGV4LCBlbGVtZW50KSA9PiB7XG4gICAgICBjb25zdCBuYW1lID0gcGFnZS4kKGVsZW1lbnQpLmF0dHIoJ25hbWUnKTtcbiAgICAgIGlmIChuYW1lKSBwb3N0VmFsdWVzW25hbWVdID0gcGFnZS4kKGVsZW1lbnQpLnZhbCgpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHsgYWN0aW9uLCBwb3N0VmFsdWVzIH07XG4gIH1cblxuICAvKipcbiAgICogQ3VycmVudCBsb2dpbiBmb3JtLlxuICAgKi9cbiAgcHJvdGVjdGVkIGZvcm0/OiBTaWdhYUZvcm07XG5cbiAgLyoqXG4gICAqIFJldHVucyBIVE1MIGZvcm1cbiAgICovXG4gIGFzeW5jIGdldExvZ2luRm9ybSgpOiBQcm9taXNlPFNpZ2FhRm9ybT4ge1xuICAgIGlmICh0aGlzLmZvcm0pIHtcbiAgICAgIHJldHVybiB0aGlzLmZvcm07XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHBhZ2UgPSBhd2FpdCB0aGlzLmh0dHAuZ2V0KCcvc2lnYWEvdmVyVGVsYUxvZ2luLmRvJyk7XG4gICAgICByZXR1cm4gdGhpcy5wYXJzZUxvZ2luRm9ybShwYWdlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU3RhcnQgYSBzZXNzaW9uIG9uIGRlc2t0b3BcbiAgICogQHBhcmFtIHVzZXJuYW1lXG4gICAqIEBwYXJhbSBwYXNzd29yZFxuICAgKi9cbiAgcHJvdGVjdGVkIGFzeW5jIGRlc2t0b3BMb2dpbihcbiAgICB1c2VybmFtZTogc3RyaW5nLFxuICAgIHBhc3N3b3JkOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxJRlNDUGFnZT4ge1xuICAgIGNvbnN0IHsgYWN0aW9uLCBwb3N0VmFsdWVzIH0gPSBhd2FpdCB0aGlzLmdldExvZ2luRm9ybSgpO1xuXG4gICAgcG9zdFZhbHVlc1sndXNlci5sb2dpbiddID0gdXNlcm5hbWU7XG4gICAgcG9zdFZhbHVlc1sndXNlci5zZW5oYSddID0gcGFzc3dvcmQ7XG4gICAgY29uc3QgcGFnZSA9IGF3YWl0IHRoaXMuaHR0cC5wb3N0KGFjdGlvbi5ocmVmLCBwb3N0VmFsdWVzKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wYXJzZURlc2t0b3BMb2dpblJlc3VsdChwYWdlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCBhIHNlc3Npb24gb24gU2lnYWEsIHJldHVybiBsb2dpbiByZXBvbnNlIHBhZ2VcbiAgICogQHBhcmFtIHVzZXJuYW1lXG4gICAqIEBwYXJhbSBwYXNzd29yZFxuICAgKi9cbiAgYXN5bmMgbG9naW4oXG4gICAgdXNlcm5hbWU6IHN0cmluZyxcbiAgICBwYXNzd29yZDogc3RyaW5nLFxuICAgIHJldHJ5ID0gdHJ1ZVxuICApOiBQcm9taXNlPElGU0NQYWdlPiB7XG4gICAgaWYgKHRoaXMuc2Vzc2lvbi5sb2dpblN0YXR1cyA9PT0gTG9naW5TdGF0dXMuQXV0aGVudGljYXRlZClcbiAgICAgIHRocm93IG5ldyBFcnJvcignU0lHQUE6IFRoaXMgc2Vzc2lvbiBhbHJlYWR5IGhhcyBhIHVzZXIgbG9nZ2VkIGluLicpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwYWdlID0gYXdhaXQgdGhpcy5kZXNrdG9wTG9naW4odXNlcm5hbWUsIHBhc3N3b3JkKTtcbiAgICAgIHJldHVybiB0aGlzLmh0dHAuZm9sbG93QWxsUmVkaXJlY3QocGFnZSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmICghcmV0cnkgfHwgZXJyb3IubWVzc2FnZSA9PT0gdGhpcy5lcnJvckludmFsaWRDcmVkZW50aWFscykge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvZ2luKHVzZXJuYW1lLCBwYXNzd29yZCwgZmFsc2UpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBwYXJzZURlc2t0b3BMb2dpblJlc3VsdChwYWdlOiBJRlNDUGFnZSk6IFByb21pc2U8SUZTQ1BhZ2U+IHtcbiAgICBjb25zdCBhY2NvdW50UGFnZSA9IGF3YWl0IHRoaXMuaHR0cC5mb2xsb3dBbGxSZWRpcmVjdChwYWdlKTtcbiAgICBpZiAoYWNjb3VudFBhZ2UuYm9keURlY29kZWQuaW5jbHVkZXMoJ0VudHJhciBubyBTaXN0ZW1hJykpIHtcbiAgICAgIGlmIChhY2NvdW50UGFnZS5ib2R5RGVjb2RlZC5pbmNsdWRlcygnVXN1w6FyaW8gZS9vdSBzZW5oYSBpbnbDoWxpZG9zJykpIHtcbiAgICAgICAgdGhpcy5mb3JtID0gYXdhaXQgdGhpcy5wYXJzZUxvZ2luRm9ybShhY2NvdW50UGFnZSk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcih0aGlzLmVycm9ySW52YWxpZENyZWRlbnRpYWxzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignU0lHQUE6IEludmFsaWQgcmVzcG9uc2UgYWZ0ZXIgbG9naW4gYXR0ZW1wdC4nKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZXNzaW9uLmxvZ2luU3RhdHVzID0gTG9naW5TdGF0dXMuQXV0aGVudGljYXRlZDtcbiAgICAgIHJldHVybiBhY2NvdW50UGFnZTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==
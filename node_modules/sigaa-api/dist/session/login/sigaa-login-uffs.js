"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SigaaLoginUFFS = void 0;

require("source-map-support/register");

var _sigaaTypes = require("../../sigaa-types");

var _url = require("url");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Responsible for logging in UFFS.
 * @category Internal
 */
class SigaaLoginUFFS {
  constructor(http, session) {
    this.http = http;
    this.session = session;

    _defineProperty(this, "errorInvalidCredentials", 'SIGAA: Invalid credentials.');

    _defineProperty(this, "form", void 0);
  }

  parseLoginForm(page) {
    const formElement = page.$("form[name='loginForm']");
    const actionUrl = formElement.attr('action');
    if (!actionUrl) throw new Error('SIGAA: No action form on login page.');
    const action = new _url.URL(actionUrl, page.url.href);
    const postValues = {};
    formElement.find('input').each((index, element) => {
      const name = page.$(element).attr('name');
      if (name) postValues[name] = page.$(element).val();
    });
    return {
      action,
      postValues
    };
  }
  /**
   * Current login form.
   */


  /**
   * Returns HTML form
   */
  async getLoginForm() {
    if (this.form) {
      return this.form;
    } else {
      const page = await this.http.get('/sigaa/verTelaLogin.do');
      return this.parseLoginForm(page);
    }
  }
  /**
   * Start a session on desktop
   * @param username
   * @param password
   */


  async desktopLogin(username, password) {
    const {
      action,
      postValues
    } = await this.getLoginForm();
    postValues['user.login'] = username;
    postValues['user.senha'] = password;
    const page = await this.http.post(action.href, postValues);
    return await this.parseDesktopLoginResult(page);
  }
  /**
   * Start a session on Sigaa, return login response page
   * @param username
   * @param password
   */


  async login(username, password, retry = true) {
    if (this.session.loginStatus === _sigaaTypes.LoginStatus.Authenticated) throw new Error('SIGAA: This session already has a user logged in.');

    try {
      const page = await this.desktopLogin(username, password);
      return this.http.followAllRedirect(page);
    } catch (error) {
      if (!retry || error.message === this.errorInvalidCredentials) {
        throw error;
      } else {
        return this.login(username, password, false);
      }
    }
  }

  async parseDesktopLoginResult(page) {
    const accountPage = await this.http.followAllRedirect(page);

    if (accountPage.bodyDecoded.includes('Entrar no Sistema')) {
      if (accountPage.bodyDecoded.includes('Usuário e/ou senha inválidos')) {
        this.form = await this.parseLoginForm(accountPage);
        throw new Error(this.errorInvalidCredentials);
      } else {
        throw new Error('SIGAA: Invalid response after login attempt.');
      }
    } else {
      this.session.loginStatus = _sigaaTypes.LoginStatus.Authenticated;
      return accountPage;
    }
  }

}

exports.SigaaLoginUFFS = SigaaLoginUFFS;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXNzaW9uL2xvZ2luL3NpZ2FhLWxvZ2luLXVmZnMudHMiXSwibmFtZXMiOlsiU2lnYWFMb2dpblVGRlMiLCJjb25zdHJ1Y3RvciIsImh0dHAiLCJzZXNzaW9uIiwicGFyc2VMb2dpbkZvcm0iLCJwYWdlIiwiZm9ybUVsZW1lbnQiLCIkIiwiYWN0aW9uVXJsIiwiYXR0ciIsIkVycm9yIiwiYWN0aW9uIiwiVVJMIiwidXJsIiwiaHJlZiIsInBvc3RWYWx1ZXMiLCJmaW5kIiwiZWFjaCIsImluZGV4IiwiZWxlbWVudCIsIm5hbWUiLCJ2YWwiLCJnZXRMb2dpbkZvcm0iLCJmb3JtIiwiZ2V0IiwiZGVza3RvcExvZ2luIiwidXNlcm5hbWUiLCJwYXNzd29yZCIsInBvc3QiLCJwYXJzZURlc2t0b3BMb2dpblJlc3VsdCIsImxvZ2luIiwicmV0cnkiLCJsb2dpblN0YXR1cyIsIkxvZ2luU3RhdHVzIiwiQXV0aGVudGljYXRlZCIsImZvbGxvd0FsbFJlZGlyZWN0IiwiZXJyb3IiLCJtZXNzYWdlIiwiZXJyb3JJbnZhbGlkQ3JlZGVudGlhbHMiLCJhY2NvdW50UGFnZSIsImJvZHlEZWNvZGVkIiwiaW5jbHVkZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOzs7O0FBT0E7QUFDQTtBQUNBO0FBQ0E7QUFDTyxNQUFNQSxjQUFOLENBQXNDO0FBQzNDQyxFQUFBQSxXQUFXLENBQVdDLElBQVgsRUFBaUNDLE9BQWpDLEVBQW1EO0FBQUEsU0FBeENELElBQXdDLEdBQXhDQSxJQUF3QztBQUFBLFNBQWxCQyxPQUFrQixHQUFsQkEsT0FBa0I7O0FBQUEscURBQzNCLDZCQUQyQjs7QUFBQTtBQUFFOztBQUd0REMsRUFBQUEsY0FBYyxDQUFDQyxJQUFELEVBQTRCO0FBQ2xELFVBQU1DLFdBQVcsR0FBR0QsSUFBSSxDQUFDRSxDQUFMLENBQU8sd0JBQVAsQ0FBcEI7QUFFQSxVQUFNQyxTQUFTLEdBQUdGLFdBQVcsQ0FBQ0csSUFBWixDQUFpQixRQUFqQixDQUFsQjtBQUNBLFFBQUksQ0FBQ0QsU0FBTCxFQUFnQixNQUFNLElBQUlFLEtBQUosQ0FBVSxzQ0FBVixDQUFOO0FBRWhCLFVBQU1DLE1BQU0sR0FBRyxJQUFJQyxRQUFKLENBQVFKLFNBQVIsRUFBbUJILElBQUksQ0FBQ1EsR0FBTCxDQUFTQyxJQUE1QixDQUFmO0FBRUEsVUFBTUMsVUFBa0MsR0FBRyxFQUEzQztBQUVBVCxJQUFBQSxXQUFXLENBQUNVLElBQVosQ0FBaUIsT0FBakIsRUFBMEJDLElBQTFCLENBQStCLENBQUNDLEtBQUQsRUFBUUMsT0FBUixLQUFvQjtBQUNqRCxZQUFNQyxJQUFJLEdBQUdmLElBQUksQ0FBQ0UsQ0FBTCxDQUFPWSxPQUFQLEVBQWdCVixJQUFoQixDQUFxQixNQUFyQixDQUFiO0FBQ0EsVUFBSVcsSUFBSixFQUFVTCxVQUFVLENBQUNLLElBQUQsQ0FBVixHQUFtQmYsSUFBSSxDQUFDRSxDQUFMLENBQU9ZLE9BQVAsRUFBZ0JFLEdBQWhCLEVBQW5CO0FBQ1gsS0FIRDtBQUtBLFdBQU87QUFBRVYsTUFBQUEsTUFBRjtBQUFVSSxNQUFBQTtBQUFWLEtBQVA7QUFDRDtBQUVEO0FBQ0Y7QUFDQTs7O0FBR0U7QUFDRjtBQUNBO0FBQ29CLFFBQVpPLFlBQVksR0FBdUI7QUFDdkMsUUFBSSxLQUFLQyxJQUFULEVBQWU7QUFDYixhQUFPLEtBQUtBLElBQVo7QUFDRCxLQUZELE1BRU87QUFDTCxZQUFNbEIsSUFBSSxHQUFHLE1BQU0sS0FBS0gsSUFBTCxDQUFVc0IsR0FBVixDQUFjLHdCQUFkLENBQW5CO0FBQ0EsYUFBTyxLQUFLcEIsY0FBTCxDQUFvQkMsSUFBcEIsQ0FBUDtBQUNEO0FBQ0Y7QUFFRDtBQUNGO0FBQ0E7QUFDQTtBQUNBOzs7QUFDOEIsUUFBWm9CLFlBQVksQ0FDMUJDLFFBRDBCLEVBRTFCQyxRQUYwQixFQUdQO0FBQ25CLFVBQU07QUFBRWhCLE1BQUFBLE1BQUY7QUFBVUksTUFBQUE7QUFBVixRQUF5QixNQUFNLEtBQUtPLFlBQUwsRUFBckM7QUFFQVAsSUFBQUEsVUFBVSxDQUFDLFlBQUQsQ0FBVixHQUEyQlcsUUFBM0I7QUFDQVgsSUFBQUEsVUFBVSxDQUFDLFlBQUQsQ0FBVixHQUEyQlksUUFBM0I7QUFDQSxVQUFNdEIsSUFBSSxHQUFHLE1BQU0sS0FBS0gsSUFBTCxDQUFVMEIsSUFBVixDQUFlakIsTUFBTSxDQUFDRyxJQUF0QixFQUE0QkMsVUFBNUIsQ0FBbkI7QUFDQSxXQUFPLE1BQU0sS0FBS2MsdUJBQUwsQ0FBNkJ4QixJQUE3QixDQUFiO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTtBQUNBOzs7QUFDYSxRQUFMeUIsS0FBSyxDQUNUSixRQURTLEVBRVRDLFFBRlMsRUFHVEksS0FBSyxHQUFHLElBSEMsRUFJVTtBQUNuQixRQUFJLEtBQUs1QixPQUFMLENBQWE2QixXQUFiLEtBQTZCQyx3QkFBWUMsYUFBN0MsRUFDRSxNQUFNLElBQUl4QixLQUFKLENBQVUsbURBQVYsQ0FBTjs7QUFDRixRQUFJO0FBQ0YsWUFBTUwsSUFBSSxHQUFHLE1BQU0sS0FBS29CLFlBQUwsQ0FBa0JDLFFBQWxCLEVBQTRCQyxRQUE1QixDQUFuQjtBQUNBLGFBQU8sS0FBS3pCLElBQUwsQ0FBVWlDLGlCQUFWLENBQTRCOUIsSUFBNUIsQ0FBUDtBQUNELEtBSEQsQ0FHRSxPQUFPK0IsS0FBUCxFQUFjO0FBQ2QsVUFBSSxDQUFDTCxLQUFELElBQVVLLEtBQUssQ0FBQ0MsT0FBTixLQUFrQixLQUFLQyx1QkFBckMsRUFBOEQ7QUFDNUQsY0FBTUYsS0FBTjtBQUNELE9BRkQsTUFFTztBQUNMLGVBQU8sS0FBS04sS0FBTCxDQUFXSixRQUFYLEVBQXFCQyxRQUFyQixFQUErQixLQUEvQixDQUFQO0FBQ0Q7QUFDRjtBQUNGOztBQUVzQyxRQUF2QkUsdUJBQXVCLENBQUN4QixJQUFELEVBQW9DO0FBQ3pFLFVBQU1rQyxXQUFXLEdBQUcsTUFBTSxLQUFLckMsSUFBTCxDQUFVaUMsaUJBQVYsQ0FBNEI5QixJQUE1QixDQUExQjs7QUFDQSxRQUFJa0MsV0FBVyxDQUFDQyxXQUFaLENBQXdCQyxRQUF4QixDQUFpQyxtQkFBakMsQ0FBSixFQUEyRDtBQUN6RCxVQUFJRixXQUFXLENBQUNDLFdBQVosQ0FBd0JDLFFBQXhCLENBQWlDLDhCQUFqQyxDQUFKLEVBQXNFO0FBQ3BFLGFBQUtsQixJQUFMLEdBQVksTUFBTSxLQUFLbkIsY0FBTCxDQUFvQm1DLFdBQXBCLENBQWxCO0FBQ0EsY0FBTSxJQUFJN0IsS0FBSixDQUFVLEtBQUs0Qix1QkFBZixDQUFOO0FBQ0QsT0FIRCxNQUdPO0FBQ0wsY0FBTSxJQUFJNUIsS0FBSixDQUFVLDhDQUFWLENBQU47QUFDRDtBQUNGLEtBUEQsTUFPTztBQUNMLFdBQUtQLE9BQUwsQ0FBYTZCLFdBQWIsR0FBMkJDLHdCQUFZQyxhQUF2QztBQUNBLGFBQU9LLFdBQVA7QUFDRDtBQUNGOztBQTdGMEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2dpblN0YXR1cyB9IGZyb20gJy4uLy4uL3NpZ2FhLXR5cGVzJztcbmltcG9ydCB7IFVSTCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgeyBIVFRQIH0gZnJvbSAnLi4vc2lnYWEtaHR0cCc7XG5pbXBvcnQgeyBTZXNzaW9uIH0gZnJvbSAnLi4vc2lnYWEtc2Vzc2lvbic7XG5pbXBvcnQgeyBMb2dpbiB9IGZyb20gJy4vc2lnYWEtbG9naW4nO1xuaW1wb3J0IHsgVUZGU1BhZ2UgfSBmcm9tICdAc2Vzc2lvbi9wYWdlL3NpZ2FhLXBhZ2UtdWZmcyc7IC8vIENlcnRpZmlxdWUtc2UgZGUgdGVyIG8gbcOzZHVsbyBVRkZTUGFnZSBkaXNwb27DrXZlbFxuaW1wb3J0IHsgU2lnYWFGb3JtIH0gZnJvbSAnQHNlc3Npb24vc2lnYWEtcGFnZSc7XG5cbi8qKlxuICogUmVzcG9uc2libGUgZm9yIGxvZ2dpbmcgaW4gVUZGUy5cbiAqIEBjYXRlZ29yeSBJbnRlcm5hbFxuICovXG5leHBvcnQgY2xhc3MgU2lnYWFMb2dpblVGRlMgaW1wbGVtZW50cyBMb2dpbiB7XG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBodHRwOiBIVFRQLCBwcm90ZWN0ZWQgc2Vzc2lvbjogU2Vzc2lvbikge31cbiAgcmVhZG9ubHkgZXJyb3JJbnZhbGlkQ3JlZGVudGlhbHMgPSAnU0lHQUE6IEludmFsaWQgY3JlZGVudGlhbHMuJztcblxuICBwcm90ZWN0ZWQgcGFyc2VMb2dpbkZvcm0ocGFnZTogVUZGU1BhZ2UpOiBTaWdhYUZvcm0ge1xuICAgIGNvbnN0IGZvcm1FbGVtZW50ID0gcGFnZS4kKFwiZm9ybVtuYW1lPSdsb2dpbkZvcm0nXVwiKTtcblxuICAgIGNvbnN0IGFjdGlvblVybCA9IGZvcm1FbGVtZW50LmF0dHIoJ2FjdGlvbicpO1xuICAgIGlmICghYWN0aW9uVXJsKSB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBObyBhY3Rpb24gZm9ybSBvbiBsb2dpbiBwYWdlLicpO1xuXG4gICAgY29uc3QgYWN0aW9uID0gbmV3IFVSTChhY3Rpb25VcmwsIHBhZ2UudXJsLmhyZWYpO1xuXG4gICAgY29uc3QgcG9zdFZhbHVlczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuXG4gICAgZm9ybUVsZW1lbnQuZmluZCgnaW5wdXQnKS5lYWNoKChpbmRleCwgZWxlbWVudCkgPT4ge1xuICAgICAgY29uc3QgbmFtZSA9IHBhZ2UuJChlbGVtZW50KS5hdHRyKCduYW1lJyk7XG4gICAgICBpZiAobmFtZSkgcG9zdFZhbHVlc1tuYW1lXSA9IHBhZ2UuJChlbGVtZW50KS52YWwoKTtcbiAgICB9KTtcblxuICAgIHJldHVybiB7IGFjdGlvbiwgcG9zdFZhbHVlcyB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEN1cnJlbnQgbG9naW4gZm9ybS5cbiAgICovXG4gIHByb3RlY3RlZCBmb3JtPzogU2lnYWFGb3JtO1xuXG4gIC8qKlxuICAgKiBSZXR1cm5zIEhUTUwgZm9ybVxuICAgKi9cbiAgYXN5bmMgZ2V0TG9naW5Gb3JtKCk6IFByb21pc2U8U2lnYWFGb3JtPiB7XG4gICAgaWYgKHRoaXMuZm9ybSkge1xuICAgICAgcmV0dXJuIHRoaXMuZm9ybTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgcGFnZSA9IGF3YWl0IHRoaXMuaHR0cC5nZXQoJy9zaWdhYS92ZXJUZWxhTG9naW4uZG8nKTtcbiAgICAgIHJldHVybiB0aGlzLnBhcnNlTG9naW5Gb3JtKHBhZ2UpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCBhIHNlc3Npb24gb24gZGVza3RvcFxuICAgKiBAcGFyYW0gdXNlcm5hbWVcbiAgICogQHBhcmFtIHBhc3N3b3JkXG4gICAqL1xuICBwcm90ZWN0ZWQgYXN5bmMgZGVza3RvcExvZ2luKFxuICAgIHVzZXJuYW1lOiBzdHJpbmcsXG4gICAgcGFzc3dvcmQ6IHN0cmluZ1xuICApOiBQcm9taXNlPFVGRlNQYWdlPiB7XG4gICAgY29uc3QgeyBhY3Rpb24sIHBvc3RWYWx1ZXMgfSA9IGF3YWl0IHRoaXMuZ2V0TG9naW5Gb3JtKCk7XG5cbiAgICBwb3N0VmFsdWVzWyd1c2VyLmxvZ2luJ10gPSB1c2VybmFtZTtcbiAgICBwb3N0VmFsdWVzWyd1c2VyLnNlbmhhJ10gPSBwYXNzd29yZDtcbiAgICBjb25zdCBwYWdlID0gYXdhaXQgdGhpcy5odHRwLnBvc3QoYWN0aW9uLmhyZWYsIHBvc3RWYWx1ZXMpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnBhcnNlRGVza3RvcExvZ2luUmVzdWx0KHBhZ2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0YXJ0IGEgc2Vzc2lvbiBvbiBTaWdhYSwgcmV0dXJuIGxvZ2luIHJlc3BvbnNlIHBhZ2VcbiAgICogQHBhcmFtIHVzZXJuYW1lXG4gICAqIEBwYXJhbSBwYXNzd29yZFxuICAgKi9cbiAgYXN5bmMgbG9naW4oXG4gICAgdXNlcm5hbWU6IHN0cmluZyxcbiAgICBwYXNzd29yZDogc3RyaW5nLFxuICAgIHJldHJ5ID0gdHJ1ZVxuICApOiBQcm9taXNlPFVGRlNQYWdlPiB7XG4gICAgaWYgKHRoaXMuc2Vzc2lvbi5sb2dpblN0YXR1cyA9PT0gTG9naW5TdGF0dXMuQXV0aGVudGljYXRlZClcbiAgICAgIHRocm93IG5ldyBFcnJvcignU0lHQUE6IFRoaXMgc2Vzc2lvbiBhbHJlYWR5IGhhcyBhIHVzZXIgbG9nZ2VkIGluLicpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwYWdlID0gYXdhaXQgdGhpcy5kZXNrdG9wTG9naW4odXNlcm5hbWUsIHBhc3N3b3JkKTtcbiAgICAgIHJldHVybiB0aGlzLmh0dHAuZm9sbG93QWxsUmVkaXJlY3QocGFnZSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmICghcmV0cnkgfHwgZXJyb3IubWVzc2FnZSA9PT0gdGhpcy5lcnJvckludmFsaWRDcmVkZW50aWFscykge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvZ2luKHVzZXJuYW1lLCBwYXNzd29yZCwgZmFsc2UpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBwYXJzZURlc2t0b3BMb2dpblJlc3VsdChwYWdlOiBVRkZTUGFnZSk6IFByb21pc2U8VUZGU1BhZ2U+IHtcbiAgICBjb25zdCBhY2NvdW50UGFnZSA9IGF3YWl0IHRoaXMuaHR0cC5mb2xsb3dBbGxSZWRpcmVjdChwYWdlKTtcbiAgICBpZiAoYWNjb3VudFBhZ2UuYm9keURlY29kZWQuaW5jbHVkZXMoJ0VudHJhciBubyBTaXN0ZW1hJykpIHtcbiAgICAgIGlmIChhY2NvdW50UGFnZS5ib2R5RGVjb2RlZC5pbmNsdWRlcygnVXN1w6FyaW8gZS9vdSBzZW5oYSBpbnbDoWxpZG9zJykpIHtcbiAgICAgICAgdGhpcy5mb3JtID0gYXdhaXQgdGhpcy5wYXJzZUxvZ2luRm9ybShhY2NvdW50UGFnZSk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcih0aGlzLmVycm9ySW52YWxpZENyZWRlbnRpYWxzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignU0lHQUE6IEludmFsaWQgcmVzcG9uc2UgYWZ0ZXIgbG9naW4gYXR0ZW1wdC4nKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZXNzaW9uLmxvZ2luU3RhdHVzID0gTG9naW5TdGF0dXMuQXV0aGVudGljYXRlZDtcbiAgICAgIHJldHVybiBhY2NvdW50UGFnZTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==
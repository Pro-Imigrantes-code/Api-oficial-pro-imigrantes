"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SigaaLoginUNB = void 0;

require("source-map-support/register");

var _sigaaTypes = require("../../sigaa-types");

var _url = require("url");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Responsible for logging in UNB.
 * @category Internal
 */
class SigaaLoginUNB {
  constructor(http, session) {
    this.http = http;
    this.session = session;

    _defineProperty(this, "errorInvalidCredentials", 'SIGAA: Invalid credentials.');

    _defineProperty(this, "form", void 0);
  }

  parseLoginForm(page) {
    const formElement = page.$("form[name='loginForm']");
    const actionUrl = formElement.attr('action');
    if (!actionUrl) throw new Error('SIGAA: No action form on login page.');
    const action = new _url.URL(actionUrl, page.url.href);
    const postValues = {};
    formElement.find('input').each((index, element) => {
      const name = page.$(element).attr('name');
      if (name) postValues[name] = page.$(element).val();
    });
    return {
      action,
      postValues
    };
  }
  /**
   * Current login form.
   */


  /**
   * Retuns HTML form
   */
  async getLoginForm() {
    if (this.form) {
      return this.form;
    } else {
      const page = await this.http.get('/sigaa/verTelaLogin.do');
      return this.parseLoginForm(page);
    }
  }
  /**
   * Start a session on desktop
   * @param username
   * @param password
   */


  async desktopLogin(username, password) {
    const {
      action,
      postValues
    } = await this.getLoginForm();
    postValues['user.login'] = username;
    postValues['user.senha'] = password;
    const page = await this.http.post(action.href, postValues);
    return await this.parseDesktopLoginResult(page);
  }
  /**
   * Start a session on Sigaa, return login reponse page
   * @param username
   * @param password
   */


  async login(username, password, retry = true) {
    if (this.session.loginStatus === _sigaaTypes.LoginStatus.Authenticated) throw new Error('SIGAA: This session already has a user logged in.');

    try {
      const page = await this.desktopLogin(username, password);
      return this.http.followAllRedirect(page);
    } catch (error) {
      if (!retry || error.message === this.errorInvalidCredentials) {
        throw error;
      } else {
        return this.login(username, password, false);
      }
    }
  }

  async parseDesktopLoginResult(page) {
    const accountPage = await this.http.followAllRedirect(page);

    if (accountPage.bodyDecoded.includes('Entrar no Sistema')) {
      if (accountPage.bodyDecoded.includes('Usuário e/ou senha inválidos')) {
        this.form = await this.parseLoginForm(accountPage);
        throw new Error(this.errorInvalidCredentials);
      } else {
        throw new Error('SIGAA: Invalid response after login attempt.');
      }
    } else {
      this.session.loginStatus = _sigaaTypes.LoginStatus.Authenticated;
      return accountPage;
    }
  }

}

exports.SigaaLoginUNB = SigaaLoginUNB;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXNzaW9uL2xvZ2luL3NpZ2FhLWxvZ2luLXVuYi50cyJdLCJuYW1lcyI6WyJTaWdhYUxvZ2luVU5CIiwiY29uc3RydWN0b3IiLCJodHRwIiwic2Vzc2lvbiIsInBhcnNlTG9naW5Gb3JtIiwicGFnZSIsImZvcm1FbGVtZW50IiwiJCIsImFjdGlvblVybCIsImF0dHIiLCJFcnJvciIsImFjdGlvbiIsIlVSTCIsInVybCIsImhyZWYiLCJwb3N0VmFsdWVzIiwiZmluZCIsImVhY2giLCJpbmRleCIsImVsZW1lbnQiLCJuYW1lIiwidmFsIiwiZ2V0TG9naW5Gb3JtIiwiZm9ybSIsImdldCIsImRlc2t0b3BMb2dpbiIsInVzZXJuYW1lIiwicGFzc3dvcmQiLCJwb3N0IiwicGFyc2VEZXNrdG9wTG9naW5SZXN1bHQiLCJsb2dpbiIsInJldHJ5IiwibG9naW5TdGF0dXMiLCJMb2dpblN0YXR1cyIsIkF1dGhlbnRpY2F0ZWQiLCJmb2xsb3dBbGxSZWRpcmVjdCIsImVycm9yIiwibWVzc2FnZSIsImVycm9ySW52YWxpZENyZWRlbnRpYWxzIiwiYWNjb3VudFBhZ2UiLCJib2R5RGVjb2RlZCIsImluY2x1ZGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQU9BO0FBQ0E7QUFDQTtBQUNBO0FBQ08sTUFBTUEsYUFBTixDQUFxQztBQUMxQ0MsRUFBQUEsV0FBVyxDQUFXQyxJQUFYLEVBQWlDQyxPQUFqQyxFQUFtRDtBQUFBLFNBQXhDRCxJQUF3QyxHQUF4Q0EsSUFBd0M7QUFBQSxTQUFsQkMsT0FBa0IsR0FBbEJBLE9BQWtCOztBQUFBLHFEQUMzQiw2QkFEMkI7O0FBQUE7QUFBRTs7QUFHdERDLEVBQUFBLGNBQWMsQ0FBQ0MsSUFBRCxFQUEyQjtBQUNqRCxVQUFNQyxXQUFXLEdBQUdELElBQUksQ0FBQ0UsQ0FBTCxDQUFPLHdCQUFQLENBQXBCO0FBRUEsVUFBTUMsU0FBUyxHQUFHRixXQUFXLENBQUNHLElBQVosQ0FBaUIs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QUF3QkMsUUFBeEIsQ0FBaUMsbUJBQWpDLENBQUosRUFBMkQ7QUFDekQsVUFBSUYsV0FBVyxDQUFDQyxXQUFaLENBQXdCQyxRQUF4QixDQUFpQyw4QkFBakMsQ0FBSixFQUFzRTtBQUNwRSxhQUFLbEIsSUFBTCxHQUFZLE1BQU0sS0FBS25CLGNBQUwsQ0FBb0JtQyxXQUFwQixDQUFsQjtBQUNBLGNBQU0sSUFBSTdCLEtBQUosQ0FBVSxLQUFLNEIsdUJBQWYsQ0FBTjtBQUNELE9BSEQsTUFHTztBQUNMLGNBQU0sSUFBSTVCLEtBQUosQ0FBVSw4Q0FBVixDQUFOO0FBQ0Q7QUFDRixLQVBELE1BT087QUFDTCxXQUFLUCxPQUFMLENBQWE2QixXQUFiLEdBQTJCQyx3QkFBWUMsYUFBdkM7QUFDQSxhQUFPSyxXQUFQO0FBQ0Q7QUFDRjs7QUE3RnlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9naW5TdGF0dXMgfSBmcm9tICcuLi8uLi9zaWdhYS10eXBlcyc7XG5pbXBvcnQgeyBVUkwgfSBmcm9tICd1cmwnO1xuaW1wb3J0IHsgSFRUUCB9IGZyb20gJy4uL3NpZ2FhLWh0dHAnO1xuaW1wb3J0IHsgU2Vzc2lvbiB9IGZyb20gJy4uL3NpZ2FhLXNlc3Npb24nO1xuaW1wb3J0IHsgTG9naW4gfSBmcm9tICcuL3NpZ2FhLWxvZ2luJztcbmltcG9ydCB7IFVOQlBhZ2UgfSBmcm9tICdAc2Vzc2lvbi9wYWdlL3NpZ2FhLXBhZ2UtdW5iJztcbmltcG9ydCB7IFNpZ2FhRm9ybSB9IGZyb20gJ0BzZXNzaW9uL3NpZ2FhLXBhZ2UnO1xuXG4vKipcbiAqIFJlc3BvbnNpYmxlIGZvciBsb2dnaW5nIGluIFVOQi5cbiAqIEBjYXRlZ29yeSBJbnRlcm5hbFxuICovXG5leHBvcnQgY2xhc3MgU2lnYWFMb2dpblVOQiBpbXBsZW1lbnRzIExvZ2luIHtcbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGh0dHA6IEhUVFAsIHByb3RlY3RlZCBzZXNzaW9uOiBTZXNzaW9uKSB7fVxuICByZWFkb25seSBlcnJvckludmFsaWRDcmVkZW50aWFscyA9ICdTSUdBQTogSW52YWxpZCBjcmVkZW50aWFscy4nO1xuXG4gIHByb3RlY3RlZCBwYXJzZUxvZ2luRm9ybShwYWdlOiBVTkJQYWdlKTogU2lnYWFGb3JtIHtcbiAgICBjb25zdCBmb3JtRWxlbWVudCA9IHBhZ2UuJChcImZvcm1bbmFtZT0nbG9naW5Gb3JtJ11cIik7XG5cbiAgICBjb25zdCBhY3Rpb25VcmwgPSBmb3JtRWxlbWVudC5hdHRyKCdhY3Rpb24nKTtcbiAgICBpZiAoIWFjdGlvblVybCkgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogTm8gYWN0aW9uIGZvcm0gb24gbG9naW4gcGFnZS4nKTtcblxuICAgIGNvbnN0IGFjdGlvbiA9IG5ldyBVUkwoYWN0aW9uVXJsLCBwYWdlLnVybC5ocmVmKTtcblxuICAgIGNvbnN0IHBvc3RWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcblxuICAgIGZvcm1FbGVtZW50LmZpbmQoJ2lucHV0JykuZWFjaCgoaW5kZXgsIGVsZW1lbnQpID0+IHtcbiAgICAgIGNvbnN0IG5hbWUgPSBwYWdlLiQoZWxlbWVudCkuYXR0cignbmFtZScpO1xuICAgICAgaWYgKG5hbWUpIHBvc3RWYWx1ZXNbbmFtZV0gPSBwYWdlLiQoZWxlbWVudCkudmFsKCk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4geyBhY3Rpb24sIHBvc3RWYWx1ZXMgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDdXJyZW50IGxvZ2luIGZvcm0uXG4gICAqL1xuICBwcm90ZWN0ZWQgZm9ybT86IFNpZ2FhRm9ybTtcblxuICAvKipcbiAgICogUmV0dW5zIEhUTUwgZm9ybVxuICAgKi9cbiAgYXN5bmMgZ2V0TG9naW5Gb3JtKCk6IFByb21pc2U8U2lnYWFGb3JtPiB7XG4gICAgaWYgKHRoaXMuZm9ybSkge1xuICAgICAgcmV0dXJuIHRoaXMuZm9ybTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgcGFnZSA9IGF3YWl0IHRoaXMuaHR0cC5nZXQoJy9zaWdhYS92ZXJUZWxhTG9naW4uZG8nKTtcbiAgICAgIHJldHVybiB0aGlzLnBhcnNlTG9naW5Gb3JtKHBhZ2UpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCBhIHNlc3Npb24gb24gZGVza3RvcFxuICAgKiBAcGFyYW0gdXNlcm5hbWVcbiAgICogQHBhcmFtIHBhc3N3b3JkXG4gICAqL1xuICBwcm90ZWN0ZWQgYXN5bmMgZGVza3RvcExvZ2luKFxuICAgIHVzZXJuYW1lOiBzdHJpbmcsXG4gICAgcGFzc3dvcmQ6IHN0cmluZ1xuICApOiBQcm9taXNlPFVOQlBhZ2U+IHtcbiAgICBjb25zdCB7IGFjdGlvbiwgcG9zdFZhbHVlcyB9ID0gYXdhaXQgdGhpcy5nZXRMb2dpbkZvcm0oKTtcblxuICAgIHBvc3RWYWx1ZXNbJ3VzZXIubG9naW4nXSA9IHVzZXJuYW1lO1xuICAgIHBvc3RWYWx1ZXNbJ3VzZXIuc2VuaGEnXSA9IHBhc3N3b3JkO1xuICAgIGNvbnN0IHBhZ2UgPSBhd2FpdCB0aGlzLmh0dHAucG9zdChhY3Rpb24uaHJlZiwgcG9zdFZhbHVlcyk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucGFyc2VEZXNrdG9wTG9naW5SZXN1bHQocGFnZSk7XG4gIH1cblxuICAvKipcbiAgICogU3RhcnQgYSBzZXNzaW9uIG9uIFNpZ2FhLCByZXR1cm4gbG9naW4gcmVwb25zZSBwYWdlXG4gICAqIEBwYXJhbSB1c2VybmFtZVxuICAgKiBAcGFyYW0gcGFzc3dvcmRcbiAgICovXG4gIGFzeW5jIGxvZ2luKFxuICAgIHVzZXJuYW1lOiBzdHJpbmcsXG4gICAgcGFzc3dvcmQ6IHN0cmluZyxcbiAgICByZXRyeSA9IHRydWVcbiAgKTogUHJvbWlzZTxVTkJQYWdlPiB7XG4gICAgaWYgKHRoaXMuc2Vzc2lvbi5sb2dpblN0YXR1cyA9PT0gTG9naW5TdGF0dXMuQXV0aGVudGljYXRlZClcbiAgICAgIHRocm93IG5ldyBFcnJvcignU0lHQUE6IFRoaXMgc2Vzc2lvbiBhbHJlYWR5IGhhcyBhIHVzZXIgbG9nZ2VkIGluLicpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwYWdlID0gYXdhaXQgdGhpcy5kZXNrdG9wTG9naW4odXNlcm5hbWUsIHBhc3N3b3JkKTtcbiAgICAgIHJldHVybiB0aGlzLmh0dHAuZm9sbG93QWxsUmVkaXJlY3QocGFnZSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmICghcmV0cnkgfHwgZXJyb3IubWVzc2FnZSA9PT0gdGhpcy5lcnJvckludmFsaWRDcmVkZW50aWFscykge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvZ2luKHVzZXJuYW1lLCBwYXNzd29yZCwgZmFsc2UpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBwYXJzZURlc2t0b3BMb2dpblJlc3VsdChwYWdlOiBVTkJQYWdlKTogUHJvbWlzZTxVTkJQYWdlPiB7XG4gICAgY29uc3QgYWNjb3VudFBhZ2UgPSBhd2FpdCB0aGlzLmh0dHAuZm9sbG93QWxsUmVkaXJlY3QocGFnZSk7XG4gICAgaWYgKGFjY291bnRQYWdlLmJvZHlEZWNvZGVkLmluY2x1ZGVzKCdFbnRyYXIgbm8gU2lzdGVtYScpKSB7XG4gICAgICBpZiAoYWNjb3VudFBhZ2UuYm9keURlY29kZWQuaW5jbHVkZXMoJ1VzdcOhcmlvIGUvb3Ugc2VuaGEgaW52w6FsaWRvcycpKSB7XG4gICAgICAgIHRoaXMuZm9ybSA9IGF3YWl0IHRoaXMucGFyc2VMb2dpbkZvcm0oYWNjb3VudFBhZ2UpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IodGhpcy5lcnJvckludmFsaWRDcmVkZW50aWFscyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBJbnZhbGlkIHJlc3BvbnNlIGFmdGVyIGxvZ2luIGF0dGVtcHQuJyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2Vzc2lvbi5sb2dpblN0YXR1cyA9IExvZ2luU3RhdHVzLkF1dGhlbnRpY2F0ZWQ7XG4gICAgICByZXR1cm4gYWNjb3VudFBhZ2U7XG4gICAgfVxuICB9XG59XG4iXX0=
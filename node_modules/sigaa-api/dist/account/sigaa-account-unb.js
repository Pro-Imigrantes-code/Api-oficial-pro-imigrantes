"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SigaaAccountUNB = void 0;

require("source-map-support/register");

var _sigaaTypes = require("../sigaa-types");

var _url = require("url");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Responsible for representing the user account.
 * @category Internal
 */
class SigaaAccountUNB {
  /**
   * @param homepage homepage (page after login) of user.
   */
  constructor(homepage, http, parser, session, bondFactory) {
    this.http = http;
    this.parser = parser;
    this.session = session;
    this.bondFactory = bondFactory;

    _defineProperty(this, "errorInvalidCredentials", 'SIGAA: Invalid credentials.');

    _defineProperty(this, "errorInsufficientPasswordComplexity", 'SIGAA: Insufficent password complexity.');

    _defineProperty(this, "_name", void 0);

    _defineProperty(this, "_emails", void 0);

    _defineProperty(this, "activeBonds", []);

    _defineProperty(this, "inactiveBonds", []);

    _defineProperty(this, "pagehomeParsePromise", void 0);

    this.parseHomepage(homepage);
  }
  /**
   * Error message when the new password chosen does not meet the security requirements of SIGAA.
   * It is thrown by the changePassword() method
   */


  /**
   * Parse login result page to fill the instance.
   *
   * @param homepage home page to parse.
   */
  parseHomepage(homepage) {
    //Since the login page can vary, we should check the type of page.
    if (homepage.bodyDecoded.includes('O sistema comportou-se de forma inesperada')) {
      throw new Error('SIGAA: Invalid homepage, the system behaved unexpectedly.');
    }

    if (homepage.url.href.includes('/portais/discente/discente.jsf')) {
      //If it is home page student of desktop version.
      this.pagehomeParsePromise = this.parseStudentHomePage(homepage);
    } else if (homepage.url.href.includes('/sigaa/vinculos.jsf') || homepage.url.href.includes('/sigaa/escolhaVinculo.do')) {
      //If it is bond page.
      this.pagehomeParsePromise = this.parseBondPage(homepage);
    } else if (homepage.url.href.includes('/sigaa/telasPosSelecaoVinculos.jsf')) {
      this.pagehomeParsePromise = this.http.get(homepage.url.href, {
        noCache: true
      }).then(page => this.parseBondPage(page));
    } else if (homepage.url.href.includes('/sigaa/telaAvisoLogon.jsf')) {
      this.pagehomeParsePromise = this.http.get('/sigaa/vinculos.jsf').then(page => this.parseBondPage(page));
    } else {
      throw new Error('SIGAA: Unknown homepage format.');
    }
  }
  /**
   * Parse bond page.
   * @param page page to parse.
   */


  async parseBondPage(page) {
    const rows = page.$('table.subFormulario tbody tr').toArray();

    for (const row of rows) {
      const cells = page.$(row).find('td').toArray();
      if (cells.length === 0) continue;
      const bondType = this.parser.removeTagsHtml(page.$(row).find('#tdTipo').html());
      const status = this.parser.removeTagsHtml(page.$(cells[3]).html());
      let bond;

      switch (bondType) {
        case 'Discente':
          {
            const registration = this.parser.removeTagsHtml(page.$(cells[2]).html());
            const url = page.$(row).find('a[href]').attr('href');
            if (!url) throw new Error('SIGAA: Bond switch url could not be found.');
            const bondSwitchUrl = new _url.URL(url, page.url);
            const program = this.parser.removeTagsHtml(page.$(cells[4]).html()).replace(/^Curso: /g, '');
            bond = this.bondFactory.createStudentBond(registration, program, bondSwitchUrl);
            break;
          }

        case 'Docente':
          {
            bond = this.bondFactory.createTeacherBond();
            break;
          }
      }

      if (bond) if (status === 'Sim') {
        this.activeBonds.push(bond);
      } else if (status === 'Não') {
        this.inactiveBonds.push(bond);
      } else {
        console.log('SIGAA: WARNING invalid status: ' + status);
      }
    }
  }
  /**
   * @inheritdoc
   */


  async getActiveBonds() {
    await this.pagehomeParsePromise;
    return this.activeBonds;
  }
  /**
   * @inheritdoc
   */


  async getInactiveBonds() {
    await this.pagehomeParsePromise;
    return this.inactiveBonds;
  }
  /**
   * Parse desktop version of student home page page.
   */


  async parseStudentHomePage(homepage) {
    const rows = homepage.$('#perfil-docente table').eq(0).find('tr').toArray();
    let registration;
    let program;
    let status;
    const buttonSwitchBond = this.parser.removeTagsHtml(homepage.$('#info-usuario p i small a').html());

    if (buttonSwitchBond === 'Alterar vínculo') {
      const bondPage = await this.http.get('/sigaa/vinculos.jsf');
      return this.parseBondPage(bondPage);
    }

    for (const row of rows) {
      const cells = homepage.$(row).find('td');

      if (cells.length !== 2) {
        throw new Error('SIGAA: Invalid student details page.');
      }

      const rowName = this.parser.removeTagsHtml(cells.eq(0).html());

      switch (rowName) {
        case 'Matrícula:':
          registration = this.parser.removeTagsHtml(cells.eq(1).html());
          break;

        case 'Curso:':
          program = this.parser.removeTagsHtml(cells.eq(1).html()).replace(/ - (M|T|N)$/g, ''); // Remove schedule letter

          break;

        case 'Status:':
          status = this.parser.removeTagsHtml(cells.eq(1).html());
      }

      if (registration && program && status) break;
    }

    if (!registration) throw new Error('SIGAA: Student bond without registration code.');
    if (!program) throw new Error('SIGAA: Student bond program not found.');
    if (!status) throw new Error('SIGAA: Student bond status not found.');
    if (status === 'CURSANDO' || status === 'CONCLUINTE') this.activeBonds.push(this.bondFactory.createStudentBond(registration, program, null));else this.inactiveBonds.push(this.bondFactory.createStudentBond(registration, program, null));
  }
  /**
   * @inheritdoc
   */


  logoff() {
    return this.http.get('/sigaa/logar.do?dispatch=logOff').then(page => {
      return this.http.followAllRedirect(page);
    }).then(page => {
      if (page.statusCode !== 200) {
        throw new Error('SIGAA: Invalid status code in logoff page.');
      }

      this.session.loginStatus = _sigaaTypes.LoginStatus.Unauthenticated;
      this.http.closeSession();
    });
  }
  /**
   * Get profile picture URL.
   * @retuns Picture url or null if the user has no photo.
   */


  async getProfilePictureURL() {
    const page = await this.http.get('/sigaa/portais/discente/discente.jsf');
    const pictureElement = page.$('div[class="foto"] img');
    if (pictureElement.length === 0) return null;
    const pictureSrc = pictureElement.attr('src');
    if (!pictureSrc || pictureSrc.includes('/sigaa/img/no_picture.png')) return null;
    return new _url.URL(pictureSrc, page.url);
  }
  /**
   * Download profile url and save in basepath.
   * @param destpath It can be a folder or a file name, if it is a directory then it will be saved inside the folder, if it is a file name it will be saved exactly in this place, but if the folder does not exist it will throw an error.
   * @param callback To know the progress of the download, each downloaded part will be called informing how much has already been downloaded.
   * @retuns Full path of the downloaded file, useful if the destpath is a directory, or null if the user has no photo.
   */


  async downloadProfilePicture(destpath, callback) {
    const pictureURL = await this.getProfilePictureURL();
    if (!pictureURL) return null;
    return this.http.downloadFileByGet(pictureURL.href, destpath, callback);
  }
  /**
   * @inheritdoc
   */


  async getName() {
    if (this._name) return this._name;
    const page = await this.http.get('/sigaa/portais/discente/discente.jsf');

    if (page.statusCode === 200) {
      const username = this.parser.removeTagsHtml(page.$('p.usuario > span').html());
      this._name = username;
      return username;
    } else {
      throw new Error('SIGAA: Unexpected status code at student profile page.');
    }
  }
  /**
   * @inheritdoc
   */


  async getEmails() {
    if (this._emails) return this._emails;
    const page = await this.http.get('/sigaa/portais/discente/discente.jsf');

    if (page.statusCode === 200) {
      const buttons = page.$('#perfil-docente .pessoal-docente').find('a[onclick]').toArray();

      for (const button of buttons) {
        const buttonName = this.parser.removeTagsHtml(page.$(button).html());

        if (buttonName === 'Meus Dados Pessoais') {
          const buttonOnClick = page.$(button).attr('onclick');

          if (buttonOnClick) {
            const form = page.parseJSFCLJS(buttonOnClick);
            const myPersonalDataPage = await this.http.post(form.action.href, form.postValues);
            const rows = myPersonalDataPage.$('td[colspan="3"] table tbody tr').toArray();
            this._emails = [];

            for (const row of rows) {
              const email = this.parser.removeTagsHtml(page.$(row).html());

              this._emails.push(email);
            }
          }

          break;
        }
      }

      if (this._emails) return this._emails;
      return [];
    } else {
      throw new Error('SIGAA: Unexpected status code at student profile page.');
    }
  }
  /**
   * Change the password of account.
   * @param oldPassword current password.
   * @param newPassword new password.
   * @throws {errorInvalidCredentials} If current password is not correct.
   * @throws {errorInsufficientPasswordComplexity} If the new password does not have the complexity requirement.
   */


  async changePassword(oldPassword, newPassword) {
    const formPage = await this.http.get('/sigaa/alterar_dados.jsf');
    if (formPage.statusCode !== 302) throw new Error('SIGAA: Unexpected status code at change password form.');
    const prePage = await this.http.followAllRedirect(formPage);
    if (prePage.statusCode !== 200 || !prePage.url.href.includes('usuario/alterar_dados.jsf')) throw new Error('SIGAA: Invalid pre page at change password.');
    const preFormElement = prePage.$('form[name="form"]');
    const preAction = preFormElement.attr('action');
    if (!preAction) throw new Error('SIGAA: Form without action at change password pre page.');
    const preActionUrl = new _url.URL(preAction, prePage.url.href);
    const prePostValues = {};
    const preInputs = preFormElement.find("input[name]:not([type='submit'])").toArray();

    for (const input of preInputs) {
      const name = prePage.$(input).attr('name');

      if (name) {
        prePostValues[name] = prePage.$(input).val();
      }
    }

    prePostValues['form:alterarSenha'] = 'form:alterarSenha';
    const page = await this.http.post(preActionUrl.href, prePostValues);
    const formElement = page.$('form[name="form"]');
    const action = formElement.attr('action');
    if (!action) throw new Error('SIGAA: Form without action at change password page.');
    const formAction = new _url.URL(action, page.url.href);
    const postValues = {};
    const inputs = formElement.find("input[name]:not([type='submit'])").toArray();

    for (const input of inputs) {
      const name = page.$(input).attr('name');

      if (name) {
        postValues[name] = prePage.$(input).val();
      }
    }

    postValues['form:senhaAtual'] = oldPassword;
    postValues['form:novaSenha'] = newPassword;
    postValues['form:repetnNovaSenha'] = newPassword;
    postValues['form:alterarDados'] = 'Alterar Dados';
    const resultPage = await this.http.post(formAction.href, postValues);

    if (resultPage.statusCode === 200) {
      const errorMsg = this.parser.removeTagsHtml(resultPage.$('.erros li').html());

      if (errorMsg.includes('A senha digitada é muito simples.')) {
        throw new Error(this.errorInsufficientPasswordComplexity);
      }

      if (errorMsg.includes('Senha Atual digitada não confere')) {
        throw new Error(this.errorInvalidCredentials);
      }
    }

    if (resultPage.statusCode !== 302) {
      throw new Error('SIGAA: The change password page status code is different than expected.');
    }
  }

}

exports.SigaaAccountUNB = SigaaAccountUNB;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hY2NvdW50L3NpZ2FhLWFjY291bnQtdW5iLnRzIl0sIm5hbWVzIjpbIlNpZ2FhQWNjb3VudFVOQiIsImNvbnN0cnVjdG9yIiwiaG9tZXBhZ2UiLCJodHRwIiwicGFyc2VyIiwic2Vzc2lvbiIsImJvbmRGYWN0b3J5IiwicGFyc2VIb21lcGFnZSIsImJvZHlEZWNvZGVkIiwiaW5jbHVkZXMiLCJFcnJvciIsInVybCIsImhyZWYiLCJwYWdlaG9tZVBhcnNlUHJvbWlzZSIsInBhcnNlU3R1ZGVudEhvbWVQYWdlIiwicGFyc2VCb25kUGFnZSIsImdldCIsIm5vQ2FjaGUiLCJ0aGVuIiwicGFnZSIsInJvd3MiLCIkIiwidG9BcnJheSIsInJvdyIsImNlbGxzIiwiZmluZCIsImxlbmd0aCIsImJvbmRUeXBlIiwicmVtb3ZlVGFnc0h0bWwiLCJodG1sIiwic3RhdHVzIiwiYm9uZCIsInJlZ2lzdHJhdGlvbiIsImF0dHIiLCJib25kU3dpdGNoVXJsIiwiVVJMIiwicHJvZ3JhbSIsInJlcGxhY2UiLCJjcmVhdGVTdHVkZW50Qm9uZCIsImNyZWF0ZVRlYWNoZXJCb25kIiwiYWN0aXZlQm9uZHMiLCJwdXNoIiwiaW5hY3RpdmVCb25kcyIsImNvbnNvbGUiLCJsb2ciLCJnZXRBY3RpdmVCb25kcyIsImdldEluYWN0aXZlQm9uZHMiLCJlcSIsImJ1dHRvblN3aXRjaEJvbmQiLCJib25kUGFnZSIsInJvd05hbWUiLCJsb2dvZmYiLCJmb2xsb3dBbGxSZWRpcmVjdCIsInN0YXR1c0NvZGUiLCJsb2dpblN0YXR1cyIsIkxvZ2luU3RhdHVzIiwiVW5hdXRoZW50aWNhdGVkIiwiY2xvc2VTZXNzaW9uIiwiZ2V0UHJvZmlsZVBpY3R1cmVVUkwiLCJwaWN0dXJlRWxlbWVudCIsInBpY3R1cmVTcmMiLCJkb3dubG9hZFByb2ZpbGVQaWN0dXJlIiwiZGVzdHBhdGgiLCJjYWxsYmFjayIsInBpY3R1cmVVUkwiLCJkb3dubG9hZEZpbGVCeUdldCIsImdldE5hbWUiLCJfbmFtZSIsInVzZXJuYW1lIiwiZ2V0RW1haWxzIiwiX2VtYWlscyIsImJ1dHRvbnMiLCJidXR0b24iLCJidXR0b25OYW1lIiwiYnV0dG9uT25DbGljayIsImZvcm0iLCJwYXJzZUpTRkNMSlMiLCJteVBlcnNvbmFsRGF0YVBhZ2UiLCJwb3N0IiwiYWN0aW9uIiwicG9zdFZhbHVlcyIsImVtYWlsIiwiY2hhbmdlUGFzc3dvcmQiLCJvbGRQYXNzd29yZCIsIm5ld1Bhc3N3b3JkIiwiZm9ybVBhZ2UiLCJwcmVQYWdlIiwicHJlRm9ybUVsZW1lbnQiLCJwcmVBY3Rpb24iLCJwcmVBY3Rpb25VcmwiLCJwcmVQb3N0VmFsdWVzIiwicHJlSW5wdXRzIiwiaW5wdXQiLCJuYW1lIiwidmFsIiwiZm9ybUVsZW1lbnQiLCJmb3JtQWN0aW9uIiwiaW5wdXRzIiwicmVzdWx0UGFnZSIsImVycm9yTXNnIiwiZXJyb3JJbnN1ZmZpY2llbnRQYXNzd29yZENvbXBsZXhpdHkiLCJlcnJvckludmFsaWRDcmVkZW50aWFscyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBR0E7O0FBSUE7Ozs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNPLE1BQU1BLGVBQU4sQ0FBeUM7QUFDOUM7QUFDRjtBQUNBO0FBQ0VDLEVBQUFBLFdBQVcsQ0FDVEMsUUFEUyxFQUVEQyxJQUZDLEVBR0RDLE1BSEMsRUFJREMsT0FKQyxFQUtEQyxXQUxDLEVBTVQ7QUFBQSxTQUpRSCxJQUlSLEdBSlFBLElBSVI7QUFBQSxTQUhRQyxNQUdSLEdBSFFBLE1BR1I7QUFBQSxTQUZRQyxPQUVSLEdBRlFBLE9BRVI7QUFBQSxTQURRQyxXQUNSLEdBRFFBLFdBQ1I7O0FBQUEscURBUWlDLDZCQVJqQzs7QUFBQSxpRUFlQSx5Q0FmQTs7QUFBQTs7QUFBQTs7QUFBQSx5Q0E4QmdDLEVBOUJoQzs7QUFBQSwyQ0FtQ2tDLEVBbkNsQzs7QUFBQTs7QUFDQSxTQUFLQyxhQUFMLENBQW1CTCxRQUFuQjtBQUNEO0FBRUQ7QUFDRjtBQUNBO0FBQ0E7OztBQW1DRTtBQUNGO0FBQ0E7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bkI7QUFDRDtBQUNGOztBQUVEZCxJQUFBQSxVQUFVLENBQUMsaUJBQUQsQ0FBVixHQUFnQ0csV0FBaEM7QUFDQUgsSUFBQUEsVUFBVSxDQUFDLGdCQUFELENBQVYsR0FBK0JJLFdBQS9CO0FBQ0FKLElBQUFBLFVBQVUsQ0FBQyxzQkFBRCxDQUFWLEdBQXFDSSxXQUFyQztBQUNBSixJQUFBQSxVQUFVLENBQUMsbUJBQUQsQ0FBVixHQUFrQyxlQUFsQztBQUVBLFVBQU1rQixVQUFVLEdBQUcsTUFBTSxLQUFLL0YsSUFBTCxDQUFVMkUsSUFBVixDQUFla0IsVUFBVSxDQUFDcEYsSUFBMUIsRUFBZ0NvRSxVQUFoQyxDQUF6Qjs7QUFFQSxRQUFJa0IsVUFBVSxDQUFDN0MsVUFBWCxLQUEwQixHQUE5QixFQUFtQztBQUNqQyxZQUFNOEMsUUFBUSxHQUFHLEtBQUsvRixNQUFMLENBQVl3QixjQUFaLENBQ2ZzRSxVQUFVLENBQUM3RSxDQUFYLENBQWEsV0FBYixFQUEwQlEsSUFBMUIsRUFEZSxDQUFqQjs7QUFHQSxVQUFJc0UsUUFBUSxDQUFDMUYsUUFBVCxDQUFrQixtQ0FBbEIsQ0FBSixFQUE0RDtBQUMxRCxjQUFNLElBQUlDLEtBQUosQ0FBVSxLQUFLMEYsbUNBQWYsQ0FBTjtBQUNEOztBQUNELFVBQUlELFFBQVEsQ0FBQzFGLFFBQVQsQ0FBa0Isa0NBQWxCLENBQUosRUFBMkQ7QUFDekQsY0FBTSxJQUFJQyxLQUFKLENBQVUsS0FBSzJGLHVCQUFmLENBQU47QUFDRDtBQUNGOztBQUVELFFBQUlILFVBQVUsQ0FBQzdDLFVBQVgsS0FBMEIsR0FBOUIsRUFBbUM7QUFDakMsWUFBTSxJQUFJM0MsS0FBSixDQUNKLHlFQURJLENBQU47QUFHRDtBQUNGOztBQXhaNkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYXJzZXIgfSBmcm9tICdAaGVscGVycy9zaWdhYS1wYXJzZXInO1xuaW1wb3J0IHsgSFRUUCwgUHJvZ3Jlc3NDYWxsYmFjayB9IGZyb20gJ0BzZXNzaW9uL3NpZ2FhLWh0dHAnO1xuaW1wb3J0IHsgU2Vzc2lvbiB9IGZyb20gJ0BzZXNzaW9uL3NpZ2FhLXNlc3Npb24nO1xuaW1wb3J0IHsgTG9naW5TdGF0dXMgfSBmcm9tICcuLi9zaWdhYS10eXBlcyc7XG5pbXBvcnQgeyBCb25kRmFjdG9yeSwgQm9uZFR5cGUgfSBmcm9tICdAYm9uZHMvc2lnYWEtYm9uZC1mYWN0b3J5JztcbmltcG9ydCB7IFBhZ2UgfSBmcm9tICdAc2Vzc2lvbi9zaWdhYS1wYWdlJztcbmltcG9ydCB7IEFjY291bnQgfSBmcm9tICcuL3NpZ2FhLWFjY291bnQnO1xuaW1wb3J0IHsgVVJMIH0gZnJvbSAndXJsJztcblxuLyoqXG4gKiBSZXNwb25zaWJsZSBmb3IgcmVwcmVzZW50aW5nIHRoZSB1c2VyIGFjY291bnQuXG4gKiBAY2F0ZWdvcnkgSW50ZXJuYWxcbiAqL1xuZXhwb3J0IGNsYXNzIFNpZ2FhQWNjb3VudFVOQiBpbXBsZW1lbnRzIEFjY291bnQge1xuICAvKipcbiAgICogQHBhcmFtIGhvbWVwYWdlIGhvbWVwYWdlIChwYWdlIGFmdGVyIGxvZ2luKSBvZiB1c2VyLlxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgaG9tZXBhZ2U6IFBhZ2UsXG4gICAgcHJpdmF0ZSBodHRwOiBIVFRQLFxuICAgIHByaXZhdGUgcGFyc2VyOiBQYXJzZXIsXG4gICAgcHJpdmF0ZSBzZXNzaW9uOiBTZXNzaW9uLFxuICAgIHByaXZhdGUgYm9uZEZhY3Rvcnk6IEJvbmRGYWN0b3J5XG4gICkge1xuICAgIHRoaXMucGFyc2VIb21lcGFnZShob21lcGFnZSk7XG4gIH1cblxuICAvKipcbiAgICogRXJyb3IgbWVzc2FnZSB3aGVuIHRoZSBuZXcgcGFzc3dvcmQgY2hvc2VuIGRvZXMgbm90IG1lZXQgdGhlIHNlY3VyaXR5IHJlcXVpcmVtZW50cyBvZiBTSUdBQS5cbiAgICogSXQgaXMgdGhyb3duIGJ5IHRoZSBjaGFuZ2VQYXNzd29yZCgpIG1ldGhvZFxuICAgKi9cbiAgcmVhZG9ubHkgZXJyb3JJbnZhbGlkQ3JlZGVudGlhbHMgPSAnU0lHQUE6IEludmFsaWQgY3JlZGVudGlhbHMuJztcblxuICAvKipcbiAgICogRXJyb3IgbWVzc2FnZSB3aGVuIHRoZSBvbGQgcGFzc3dvcmQgaXMgbm90IHRoZSBjdXJyZW50IHBhc3N3b3JkLlxuICAgKiBJdCBpcyB0aHJvd24gYnkgdGhlIGNoYW5nZVBhc3N3b3JkKCkgbWV0aG9kLlxuICAgKi9cbiAgcmVhZG9ubHkgZXJyb3JJbnN1ZmZpY2llbnRQYXNzd29yZENvbXBsZXhpdHkgPVxuICAgICdTSUdBQTogSW5zdWZmaWNlbnQgcGFzc3dvcmQgY29tcGxleGl0eS4nO1xuXG4gIC8qKlxuICAgKiBTdHVkZW50IG5hbWUgY2FjaGVcbiAgICovXG4gIHByaXZhdGUgX25hbWU/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFN0dWRlbnQgZS1tYWlsIGNhY2hlXG4gICAqL1xuICBwcml2YXRlIF9lbWFpbHM/OiBzdHJpbmdbXTtcblxuICAvKipcbiAgICogQXJyYXkgb2YgYWN0aXZlIGJvbmRzLlxuICAgKi9cbiAgcHJpdmF0ZSBhY3RpdmVCb25kczogQm9uZFR5cGVbXSA9IFtdO1xuXG4gIC8qKlxuICAgKiBBcnJheSBvZiBpbmFjdGl2ZSBib25kcy5cbiAgICovXG4gIHByaXZhdGUgaW5hY3RpdmVCb25kczogQm9uZFR5cGVbXSA9IFtdO1xuXG4gIC8qKlxuICAgKiBJdCBpcyBhIHByb21pc2UgdGhhdCBzdG9yZXMgaWYgdGhlIHBhZ2UgcGFyc2VyIGhhcyBhbHJlYWR5IGNvbXBsZXRlZFxuICAgKi9cbiAgcHJpdmF0ZSBwYWdlaG9tZVBhcnNlUHJvbWlzZT86IFByb21pc2U8dm9pZD47XG5cbiAgLyoqXG4gICAqIFBhcnNlIGxvZ2luIHJlc3VsdCBwYWdlIHRvIGZpbGwgdGhlIGluc3RhbmNlLlxuICAgKlxuICAgKiBAcGFyYW0gaG9tZXBhZ2UgaG9tZSBwYWdlIHRvIHBhcnNlLlxuICAgKi9cbiAgcHJpdmF0ZSBwYXJzZUhvbWVwYWdlKGhvbWVwYWdlOiBQYWdlKTogdm9pZCB7XG4gICAgLy9TaW5jZSB0aGUgbG9naW4gcGFnZSBjYW4gdmFyeSwgd2Ugc2hvdWxkIGNoZWNrIHRoZSB0eXBlIG9mIHBhZ2UuXG4gICAgaWYgKFxuICAgICAgaG9tZXBhZ2UuYm9keURlY29kZWQuaW5jbHVkZXMoXG4gICAgICAgICdPIHNpc3RlbWEgY29tcG9ydG91LXNlIGRlIGZvcm1hIGluZXNwZXJhZGEnXG4gICAgICApXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdTSUdBQTogSW52YWxpZCBob21lcGFnZSwgdGhlIHN5c3RlbSBiZWhhdmVkIHVuZXhwZWN0ZWRseS4nXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoaG9tZXBhZ2UudXJsLmhyZWYuaW5jbHVkZXMoJy9wb3J0YWlzL2Rpc2NlbnRlL2Rpc2NlbnRlLmpzZicpKSB7XG4gICAgICAvL0lmIGl0IGlzIGhvbWUgcGFnZSBzdHVkZW50IG9mIGRlc2t0b3AgdmVyc2lvbi5cbiAgICAgIHRoaXMucGFnZWhvbWVQYXJzZVByb21pc2UgPSB0aGlzLnBhcnNlU3R1ZGVudEhvbWVQYWdlKGhvbWVwYWdlKTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgaG9tZXBhZ2UudXJsLmhyZWYuaW5jbHVkZXMoJy9zaWdhYS92aW5jdWxvcy5qc2YnKSB8fFxuICAgICAgaG9tZXBhZ2UudXJsLmhyZWYuaW5jbHVkZXMoJy9zaWdhYS9lc2NvbGhhVmluY3Vsby5kbycpXG4gICAgKSB7XG4gICAgICAvL0lmIGl0IGlzIGJvbmQgcGFnZS5cbiAgICAgIHRoaXMucGFnZWhvbWVQYXJzZVByb21pc2UgPSB0aGlzLnBhcnNlQm9uZFBhZ2UoaG9tZXBhZ2UpO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICBob21lcGFnZS51cmwuaHJlZi5pbmNsdWRlcygnL3NpZ2FhL3RlbGFzUG9zU2VsZWNhb1ZpbmN1bG9zLmpzZicpXG4gICAgKSB7XG4gICAgICB0aGlzLnBhZ2Vob21lUGFyc2VQcm9taXNlID0gdGhpcy5odHRwXG4gICAgICAgIC5nZXQoaG9tZXBhZ2UudXJsLmhyZWYsIHsgbm9DYWNoZTogdHJ1ZSB9KVxuICAgICAgICAudGhlbigocGFnZSkgPT4gdGhpcy5wYXJzZUJvbmRQYWdlKHBhZ2UpKTtcbiAgICB9IGVsc2UgaWYgKGhvbWVwYWdlLnVybC5ocmVmLmluY2x1ZGVzKCcvc2lnYWEvdGVsYUF2aXNvTG9nb24uanNmJykpIHtcbiAgICAgIHRoaXMucGFnZWhvbWVQYXJzZVByb21pc2UgPSB0aGlzLmh0dHBcbiAgICAgICAgLmdldCgnL3NpZ2FhL3ZpbmN1bG9zLmpzZicpXG4gICAgICAgIC50aGVuKChwYWdlKSA9PiB0aGlzLnBhcnNlQm9uZFBhZ2UocGFnZSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBVbmtub3duIGhvbWVwYWdlIGZvcm1hdC4nKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUGFyc2UgYm9uZCBwYWdlLlxuICAgKiBAcGFyYW0gcGFnZSBwYWdlIHRvIHBhcnNlLlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBwYXJzZUJvbmRQYWdlKHBhZ2U6IFBhZ2UpIHtcbiAgICBjb25zdCByb3dzID0gcGFnZS4kKCd0YWJsZS5zdWJGb3JtdWxhcmlvIHRib2R5IHRyJykudG9BcnJheSgpO1xuICAgIGZvciAoY29uc3Qgcm93IG9mIHJvd3MpIHtcbiAgICAgIGNvbnN0IGNlbGxzID0gcGFnZS4kKHJvdykuZmluZCgndGQnKS50b0FycmF5KCk7XG4gICAgICBpZiAoY2VsbHMubGVuZ3RoID09PSAwKSBjb250aW51ZTtcblxuICAgICAgY29uc3QgYm9uZFR5cGUgPSB0aGlzLnBhcnNlci5yZW1vdmVUYWdzSHRtbChcbiAgICAgICAgcGFnZS4kKHJvdykuZmluZCgnI3RkVGlwbycpLmh0bWwoKVxuICAgICAgKTtcbiAgICAgIGNvbnN0IHN0YXR1cyA9IHRoaXMucGFyc2VyLnJlbW92ZVRhZ3NIdG1sKHBhZ2UuJChjZWxsc1szXSkuaHRtbCgpKTtcbiAgICAgIGxldCBib25kO1xuICAgICAgc3dpdGNoIChib25kVHlwZSkge1xuICAgICAgICBjYXNlICdEaXNjZW50ZSc6IHtcbiAgICAgICAgICBjb25zdCByZWdpc3RyYXRpb24gPSB0aGlzLnBhcnNlci5yZW1vdmVUYWdzSHRtbChcbiAgICAgICAgICAgIHBhZ2UuJChjZWxsc1syXSkuaHRtbCgpXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIGNvbnN0IHVybCA9IHBhZ2UuJChyb3cpLmZpbmQoJ2FbaHJlZl0nKS5hdHRyKCdocmVmJyk7XG4gICAgICAgICAgaWYgKCF1cmwpXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBCb25kIHN3aXRjaCB1cmwgY291bGQgbm90IGJlIGZvdW5kLicpO1xuICAgICAgICAgIGNvbnN0IGJvbmRTd2l0Y2hVcmwgPSBuZXcgVVJMKHVybCwgcGFnZS51cmwpO1xuXG4gICAgICAgICAgY29uc3QgcHJvZ3JhbSA9IHRoaXMucGFyc2VyXG4gICAgICAgICAgICAucmVtb3ZlVGFnc0h0bWwocGFnZS4kKGNlbGxzWzRdKS5odG1sKCkpXG4gICAgICAgICAgICAucmVwbGFjZSgvXkN1cnNvOiAvZywgJycpO1xuICAgICAgICAgIGJvbmQgPSB0aGlzLmJvbmRGYWN0b3J5LmNyZWF0ZVN0dWRlbnRCb25kKFxuICAgICAgICAgICAgcmVnaXN0cmF0aW9uLFxuICAgICAgICAgICAgcHJvZ3JhbSxcbiAgICAgICAgICAgIGJvbmRTd2l0Y2hVcmxcbiAgICAgICAgICApO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgJ0RvY2VudGUnOiB7XG4gICAgICAgICAgYm9uZCA9IHRoaXMuYm9uZEZhY3RvcnkuY3JlYXRlVGVhY2hlckJvbmQoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGJvbmQpXG4gICAgICAgIGlmIChzdGF0dXMgPT09ICdTaW0nKSB7XG4gICAgICAgICAgdGhpcy5hY3RpdmVCb25kcy5wdXNoKGJvbmQpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gJ07Do28nKSB7XG4gICAgICAgICAgdGhpcy5pbmFjdGl2ZUJvbmRzLnB1c2goYm9uZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ1NJR0FBOiBXQVJOSU5HIGludmFsaWQgc3RhdHVzOiAnICsgc3RhdHVzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKi9cbiAgYXN5bmMgZ2V0QWN0aXZlQm9uZHMoKTogUHJvbWlzZTxCb25kVHlwZVtdPiB7XG4gICAgYXdhaXQgdGhpcy5wYWdlaG9tZVBhcnNlUHJvbWlzZTtcbiAgICByZXR1cm4gdGhpcy5hY3RpdmVCb25kcztcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKi9cbiAgYXN5bmMgZ2V0SW5hY3RpdmVCb25kcygpOiBQcm9taXNlPEJvbmRUeXBlW10+IHtcbiAgICBhd2FpdCB0aGlzLnBhZ2Vob21lUGFyc2VQcm9taXNlO1xuICAgIHJldHVybiB0aGlzLmluYWN0aXZlQm9uZHM7XG4gIH1cblxuICAvKipcbiAgICogUGFyc2UgZGVza3RvcCB2ZXJzaW9uIG9mIHN0dWRlbnQgaG9tZSBwYWdlIHBhZ2UuXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHBhcnNlU3R1ZGVudEhvbWVQYWdlKGhvbWVwYWdlOiBQYWdlKSB7XG4gICAgY29uc3Qgcm93cyA9IGhvbWVwYWdlLiQoJyNwZXJmaWwtZG9jZW50ZSB0YWJsZScpLmVxKDApLmZpbmQoJ3RyJykudG9BcnJheSgpO1xuICAgIGxldCByZWdpc3RyYXRpb247XG4gICAgbGV0IHByb2dyYW07XG4gICAgbGV0IHN0YXR1cztcblxuICAgIGNvbnN0IGJ1dHRvblN3aXRjaEJvbmQgPSB0aGlzLnBhcnNlci5yZW1vdmVUYWdzSHRtbChcbiAgICAgIGhvbWVwYWdlLiQoJyNpbmZvLXVzdWFyaW8gcCBpIHNtYWxsIGEnKS5odG1sKClcbiAgICApO1xuICAgIGlmIChidXR0b25Td2l0Y2hCb25kID09PSAnQWx0ZXJhciB2w61uY3VsbycpIHtcbiAgICAgIGNvbnN0IGJvbmRQYWdlID0gYXdhaXQgdGhpcy5odHRwLmdldCgnL3NpZ2FhL3ZpbmN1bG9zLmpzZicpO1xuICAgICAgcmV0dXJuIHRoaXMucGFyc2VCb25kUGFnZShib25kUGFnZSk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCByb3cgb2Ygcm93cykge1xuICAgICAgY29uc3QgY2VsbHMgPSBob21lcGFnZS4kKHJvdykuZmluZCgndGQnKTtcbiAgICAgIGlmIChjZWxscy5sZW5ndGggIT09IDIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogSW52YWxpZCBzdHVkZW50IGRldGFpbHMgcGFnZS4nKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJvd05hbWUgPSB0aGlzLnBhcnNlci5yZW1vdmVUYWdzSHRtbChjZWxscy5lcSgwKS5odG1sKCkpO1xuICAgICAgc3dpdGNoIChyb3dOYW1lKSB7XG4gICAgICAgIGNhc2UgJ01hdHLDrWN1bGE6JzpcbiAgICAgICAgICByZWdpc3RyYXRpb24gPSB0aGlzLnBhcnNlci5yZW1vdmVUYWdzSHRtbChjZWxscy5lcSgxKS5odG1sKCkpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdDdXJzbzonOlxuICAgICAgICAgIHByb2dyYW0gPSB0aGlzLnBhcnNlclxuICAgICAgICAgICAgLnJlbW92ZVRhZ3NIdG1sKGNlbGxzLmVxKDEpLmh0bWwoKSlcbiAgICAgICAgICAgIC5yZXBsYWNlKC8gLSAoTXxUfE4pJC9nLCAnJyk7IC8vIFJlbW92ZSBzY2hlZHVsZSBsZXR0ZXJcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnU3RhdHVzOic6XG4gICAgICAgICAgc3RhdHVzID0gdGhpcy5wYXJzZXIucmVtb3ZlVGFnc0h0bWwoY2VsbHMuZXEoMSkuaHRtbCgpKTtcbiAgICAgIH1cbiAgICAgIGlmIChyZWdpc3RyYXRpb24gJiYgcHJvZ3JhbSAmJiBzdGF0dXMpIGJyZWFrO1xuICAgIH1cblxuICAgIGlmICghcmVnaXN0cmF0aW9uKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogU3R1ZGVudCBib25kIHdpdGhvdXQgcmVnaXN0cmF0aW9uIGNvZGUuJyk7XG5cbiAgICBpZiAoIXByb2dyYW0pIHRocm93IG5ldyBFcnJvcignU0lHQUE6IFN0dWRlbnQgYm9uZCBwcm9ncmFtIG5vdCBmb3VuZC4nKTtcblxuICAgIGlmICghc3RhdHVzKSB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBTdHVkZW50IGJvbmQgc3RhdHVzIG5vdCBmb3VuZC4nKTtcbiAgICBpZiAoc3RhdHVzID09PSAnQ1VSU0FORE8nIHx8IHN0YXR1cyA9PT0gJ0NPTkNMVUlOVEUnKVxuICAgICAgdGhpcy5hY3RpdmVCb25kcy5wdXNoKFxuICAgICAgICB0aGlzLmJvbmRGYWN0b3J5LmNyZWF0ZVN0dWRlbnRCb25kKHJlZ2lzdHJhdGlvbiwgcHJvZ3JhbSwgbnVsbClcbiAgICAgICk7XG4gICAgZWxzZVxuICAgICAgdGhpcy5pbmFjdGl2ZUJvbmRzLnB1c2goXG4gICAgICAgIHRoaXMuYm9uZEZhY3RvcnkuY3JlYXRlU3R1ZGVudEJvbmQocmVnaXN0cmF0aW9uLCBwcm9ncmFtLCBudWxsKVxuICAgICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKi9cbiAgbG9nb2ZmKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5nZXQoJy9zaWdhYS9sb2dhci5kbz9kaXNwYXRjaD1sb2dPZmYnKVxuICAgICAgLnRoZW4oKHBhZ2UpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5mb2xsb3dBbGxSZWRpcmVjdChwYWdlKTtcbiAgICAgIH0pXG4gICAgICAudGhlbigocGFnZSkgPT4ge1xuICAgICAgICBpZiAocGFnZS5zdGF0dXNDb2RlICE9PSAyMDApIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBJbnZhbGlkIHN0YXR1cyBjb2RlIGluIGxvZ29mZiBwYWdlLicpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2Vzc2lvbi5sb2dpblN0YXR1cyA9IExvZ2luU3RhdHVzLlVuYXV0aGVudGljYXRlZDtcbiAgICAgICAgdGhpcy5odHRwLmNsb3NlU2Vzc2lvbigpO1xuICAgICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHByb2ZpbGUgcGljdHVyZSBVUkwuXG4gICAqIEByZXR1bnMgUGljdHVyZSB1cmwgb3IgbnVsbCBpZiB0aGUgdXNlciBoYXMgbm8gcGhvdG8uXG4gICAqL1xuICBhc3luYyBnZXRQcm9maWxlUGljdHVyZVVSTCgpOiBQcm9taXNlPFVSTCB8IG51bGw+IHtcbiAgICBjb25zdCBwYWdlID0gYXdhaXQgdGhpcy5odHRwLmdldCgnL3NpZ2FhL3BvcnRhaXMvZGlzY2VudGUvZGlzY2VudGUuanNmJyk7XG5cbiAgICBjb25zdCBwaWN0dXJlRWxlbWVudCA9IHBhZ2UuJCgnZGl2W2NsYXNzPVwiZm90b1wiXSBpbWcnKTtcbiAgICBpZiAocGljdHVyZUVsZW1lbnQubGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbDtcbiAgICBjb25zdCBwaWN0dXJlU3JjID0gcGljdHVyZUVsZW1lbnQuYXR0cignc3JjJyk7XG4gICAgaWYgKCFwaWN0dXJlU3JjIHx8IHBpY3R1cmVTcmMuaW5jbHVkZXMoJy9zaWdhYS9pbWcvbm9fcGljdHVyZS5wbmcnKSlcbiAgICAgIHJldHVybiBudWxsO1xuICAgIHJldHVybiBuZXcgVVJMKHBpY3R1cmVTcmMsIHBhZ2UudXJsKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEb3dubG9hZCBwcm9maWxlIHVybCBhbmQgc2F2ZSBpbiBiYXNlcGF0aC5cbiAgICogQHBhcmFtIGRlc3RwYXRoIEl0IGNhbiBiZSBhIGZvbGRlciBvciBhIGZpbGUgbmFtZSwgaWYgaXQgaXMgYSBkaXJlY3RvcnkgdGhlbiBpdCB3aWxsIGJlIHNhdmVkIGluc2lkZSB0aGUgZm9sZGVyLCBpZiBpdCBpcyBhIGZpbGUgbmFtZSBpdCB3aWxsIGJlIHNhdmVkIGV4YWN0bHkgaW4gdGhpcyBwbGFjZSwgYnV0IGlmIHRoZSBmb2xkZXIgZG9lcyBub3QgZXhpc3QgaXQgd2lsbCB0aHJvdyBhbiBlcnJvci5cbiAgICogQHBhcmFtIGNhbGxiYWNrIFRvIGtub3cgdGhlIHByb2dyZXNzIG9mIHRoZSBkb3dubG9hZCwgZWFjaCBkb3dubG9hZGVkIHBhcnQgd2lsbCBiZSBjYWxsZWQgaW5mb3JtaW5nIGhvdyBtdWNoIGhhcyBhbHJlYWR5IGJlZW4gZG93bmxvYWRlZC5cbiAgICogQHJldHVucyBGdWxsIHBhdGggb2YgdGhlIGRvd25sb2FkZWQgZmlsZSwgdXNlZnVsIGlmIHRoZSBkZXN0cGF0aCBpcyBhIGRpcmVjdG9yeSwgb3IgbnVsbCBpZiB0aGUgdXNlciBoYXMgbm8gcGhvdG8uXG4gICAqL1xuICBhc3luYyBkb3dubG9hZFByb2ZpbGVQaWN0dXJlKFxuICAgIGRlc3RwYXRoOiBzdHJpbmcsXG4gICAgY2FsbGJhY2s/OiBQcm9ncmVzc0NhbGxiYWNrXG4gICk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICAgIGNvbnN0IHBpY3R1cmVVUkwgPSBhd2FpdCB0aGlzLmdldFByb2ZpbGVQaWN0dXJlVVJMKCk7XG4gICAgaWYgKCFwaWN0dXJlVVJMKSByZXR1cm4gbnVsbDtcbiAgICByZXR1cm4gdGhpcy5odHRwLmRvd25sb2FkRmlsZUJ5R2V0KHBpY3R1cmVVUkwuaHJlZiwgZGVzdHBhdGgsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKi9cbiAgYXN5bmMgZ2V0TmFtZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmICh0aGlzLl9uYW1lKSByZXR1cm4gdGhpcy5fbmFtZTtcbiAgICBjb25zdCBwYWdlID0gYXdhaXQgdGhpcy5odHRwLmdldCgnL3NpZ2FhL3BvcnRhaXMvZGlzY2VudGUvZGlzY2VudGUuanNmJyk7XG4gICAgaWYgKHBhZ2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICBjb25zdCB1c2VybmFtZSA9IHRoaXMucGFyc2VyLnJlbW92ZVRhZ3NIdG1sKFxuICAgICAgICBwYWdlLiQoJ3AudXN1YXJpbyA+IHNwYW4nKS5odG1sKClcbiAgICAgICk7XG4gICAgICB0aGlzLl9uYW1lID0gdXNlcm5hbWU7XG4gICAgICByZXR1cm4gdXNlcm5hbWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignU0lHQUE6IFVuZXhwZWN0ZWQgc3RhdHVzIGNvZGUgYXQgc3R1ZGVudCBwcm9maWxlIHBhZ2UuJyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqL1xuICBhc3luYyBnZXRFbWFpbHMoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGlmICh0aGlzLl9lbWFpbHMpIHJldHVybiB0aGlzLl9lbWFpbHM7XG4gICAgY29uc3QgcGFnZSA9IGF3YWl0IHRoaXMuaHR0cC5nZXQoJy9zaWdhYS9wb3J0YWlzL2Rpc2NlbnRlL2Rpc2NlbnRlLmpzZicpO1xuICAgIGlmIChwYWdlLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgY29uc3QgYnV0dG9ucyA9IHBhZ2VcbiAgICAgICAgLiQoJyNwZXJmaWwtZG9jZW50ZSAucGVzc29hbC1kb2NlbnRlJylcbiAgICAgICAgLmZpbmQoJ2Fbb25jbGlja10nKVxuICAgICAgICAudG9BcnJheSgpO1xuXG4gICAgICBmb3IgKGNvbnN0IGJ1dHRvbiBvZiBidXR0b25zKSB7XG4gICAgICAgIGNvbnN0IGJ1dHRvbk5hbWUgPSB0aGlzLnBhcnNlci5yZW1vdmVUYWdzSHRtbChwYWdlLiQoYnV0dG9uKS5odG1sKCkpO1xuICAgICAgICBpZiAoYnV0dG9uTmFtZSA9PT0gJ01ldXMgRGFkb3MgUGVzc29haXMnKSB7XG4gICAgICAgICAgY29uc3QgYnV0dG9uT25DbGljayA9IHBhZ2UuJChidXR0b24pLmF0dHIoJ29uY2xpY2snKTtcbiAgICAgICAgICBpZiAoYnV0dG9uT25DbGljaykge1xuICAgICAgICAgICAgY29uc3QgZm9ybSA9IHBhZ2UucGFyc2VKU0ZDTEpTKGJ1dHRvbk9uQ2xpY2spO1xuICAgICAgICAgICAgY29uc3QgbXlQZXJzb25hbERhdGFQYWdlID0gYXdhaXQgdGhpcy5odHRwLnBvc3QoXG4gICAgICAgICAgICAgIGZvcm0uYWN0aW9uLmhyZWYsXG4gICAgICAgICAgICAgIGZvcm0ucG9zdFZhbHVlc1xuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGNvbnN0IHJvd3MgPSBteVBlcnNvbmFsRGF0YVBhZ2VcbiAgICAgICAgICAgICAgLiQoJ3RkW2NvbHNwYW49XCIzXCJdIHRhYmxlIHRib2R5IHRyJylcbiAgICAgICAgICAgICAgLnRvQXJyYXkoKTtcbiAgICAgICAgICAgIHRoaXMuX2VtYWlscyA9IFtdO1xuICAgICAgICAgICAgZm9yIChjb25zdCByb3cgb2Ygcm93cykge1xuICAgICAgICAgICAgICBjb25zdCBlbWFpbCA9IHRoaXMucGFyc2VyLnJlbW92ZVRhZ3NIdG1sKHBhZ2UuJChyb3cpLmh0bWwoKSk7XG4gICAgICAgICAgICAgIHRoaXMuX2VtYWlscy5wdXNoKGVtYWlsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX2VtYWlscykgcmV0dXJuIHRoaXMuX2VtYWlscztcbiAgICAgIHJldHVybiBbXTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogVW5leHBlY3RlZCBzdGF0dXMgY29kZSBhdCBzdHVkZW50IHByb2ZpbGUgcGFnZS4nKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2hhbmdlIHRoZSBwYXNzd29yZCBvZiBhY2NvdW50LlxuICAgKiBAcGFyYW0gb2xkUGFzc3dvcmQgY3VycmVudCBwYXNzd29yZC5cbiAgICogQHBhcmFtIG5ld1Bhc3N3b3JkIG5ldyBwYXNzd29yZC5cbiAgICogQHRocm93cyB7ZXJyb3JJbnZhbGlkQ3JlZGVudGlhbHN9IElmIGN1cnJlbnQgcGFzc3dvcmQgaXMgbm90IGNvcnJlY3QuXG4gICAqIEB0aHJvd3Mge2Vycm9ySW5zdWZmaWNpZW50UGFzc3dvcmRDb21wbGV4aXR5fSBJZiB0aGUgbmV3IHBhc3N3b3JkIGRvZXMgbm90IGhhdmUgdGhlIGNvbXBsZXhpdHkgcmVxdWlyZW1lbnQuXG4gICAqL1xuICBhc3luYyBjaGFuZ2VQYXNzd29yZChcbiAgICBvbGRQYXNzd29yZDogc3RyaW5nLFxuICAgIG5ld1Bhc3N3b3JkOiBzdHJpbmdcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZm9ybVBhZ2UgPSBhd2FpdCB0aGlzLmh0dHAuZ2V0KCcvc2lnYWEvYWx0ZXJhcl9kYWRvcy5qc2YnKTtcbiAgICBpZiAoZm9ybVBhZ2Uuc3RhdHVzQ29kZSAhPT0gMzAyKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogVW5leHBlY3RlZCBzdGF0dXMgY29kZSBhdCBjaGFuZ2UgcGFzc3dvcmQgZm9ybS4nKTtcblxuICAgIGNvbnN0IHByZVBhZ2UgPSBhd2FpdCB0aGlzLmh0dHAuZm9sbG93QWxsUmVkaXJlY3QoZm9ybVBhZ2UpO1xuICAgIGlmIChcbiAgICAgIHByZVBhZ2Uuc3RhdHVzQ29kZSAhPT0gMjAwIHx8XG4gICAgICAhcHJlUGFnZS51cmwuaHJlZi5pbmNsdWRlcygndXN1YXJpby9hbHRlcmFyX2RhZG9zLmpzZicpXG4gICAgKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogSW52YWxpZCBwcmUgcGFnZSBhdCBjaGFuZ2UgcGFzc3dvcmQuJyk7XG5cbiAgICBjb25zdCBwcmVGb3JtRWxlbWVudCA9IHByZVBhZ2UuJCgnZm9ybVtuYW1lPVwiZm9ybVwiXScpO1xuXG4gICAgY29uc3QgcHJlQWN0aW9uID0gcHJlRm9ybUVsZW1lbnQuYXR0cignYWN0aW9uJyk7XG4gICAgaWYgKCFwcmVBY3Rpb24pXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdTSUdBQTogRm9ybSB3aXRob3V0IGFjdGlvbiBhdCBjaGFuZ2UgcGFzc3dvcmQgcHJlIHBhZ2UuJ1xuICAgICAgKTtcblxuICAgIGNvbnN0IHByZUFjdGlvblVybCA9IG5ldyBVUkwocHJlQWN0aW9uLCBwcmVQYWdlLnVybC5ocmVmKTtcblxuICAgIGNvbnN0IHByZVBvc3RWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcblxuICAgIGNvbnN0IHByZUlucHV0cyA9IHByZUZvcm1FbGVtZW50XG4gICAgICAuZmluZChcImlucHV0W25hbWVdOm5vdChbdHlwZT0nc3VibWl0J10pXCIpXG4gICAgICAudG9BcnJheSgpO1xuICAgIGZvciAoY29uc3QgaW5wdXQgb2YgcHJlSW5wdXRzKSB7XG4gICAgICBjb25zdCBuYW1lID0gcHJlUGFnZS4kKGlucHV0KS5hdHRyKCduYW1lJyk7XG4gICAgICBpZiAobmFtZSkge1xuICAgICAgICBwcmVQb3N0VmFsdWVzW25hbWVdID0gcHJlUGFnZS4kKGlucHV0KS52YWwoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcHJlUG9zdFZhbHVlc1snZm9ybTphbHRlcmFyU2VuaGEnXSA9ICdmb3JtOmFsdGVyYXJTZW5oYSc7XG4gICAgY29uc3QgcGFnZSA9IGF3YWl0IHRoaXMuaHR0cC5wb3N0KHByZUFjdGlvblVybC5ocmVmLCBwcmVQb3N0VmFsdWVzKTtcbiAgICBjb25zdCBmb3JtRWxlbWVudCA9IHBhZ2UuJCgnZm9ybVtuYW1lPVwiZm9ybVwiXScpO1xuXG4gICAgY29uc3QgYWN0aW9uID0gZm9ybUVsZW1lbnQuYXR0cignYWN0aW9uJyk7XG4gICAgaWYgKCFhY3Rpb24pXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBGb3JtIHdpdGhvdXQgYWN0aW9uIGF0IGNoYW5nZSBwYXNzd29yZCBwYWdlLicpO1xuICAgIGNvbnN0IGZvcm1BY3Rpb24gPSBuZXcgVVJMKGFjdGlvbiwgcGFnZS51cmwuaHJlZik7XG5cbiAgICBjb25zdCBwb3N0VmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG4gICAgY29uc3QgaW5wdXRzID0gZm9ybUVsZW1lbnRcbiAgICAgIC5maW5kKFwiaW5wdXRbbmFtZV06bm90KFt0eXBlPSdzdWJtaXQnXSlcIilcbiAgICAgIC50b0FycmF5KCk7XG4gICAgZm9yIChjb25zdCBpbnB1dCBvZiBpbnB1dHMpIHtcbiAgICAgIGNvbnN0IG5hbWUgPSBwYWdlLiQoaW5wdXQpLmF0dHIoJ25hbWUnKTtcbiAgICAgIGlmIChuYW1lKSB7XG4gICAgICAgIHBvc3RWYWx1ZXNbbmFtZV0gPSBwcmVQYWdlLiQoaW5wdXQpLnZhbCgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHBvc3RWYWx1ZXNbJ2Zvcm06c2VuaGFBdHVhbCddID0gb2xkUGFzc3dvcmQ7XG4gICAgcG9zdFZhbHVlc1snZm9ybTpub3ZhU2VuaGEnXSA9IG5ld1Bhc3N3b3JkO1xuICAgIHBvc3RWYWx1ZXNbJ2Zvcm06cmVwZXRuTm92YVNlbmhhJ10gPSBuZXdQYXNzd29yZDtcbiAgICBwb3N0VmFsdWVzWydmb3JtOmFsdGVyYXJEYWRvcyddID0gJ0FsdGVyYXIgRGFkb3MnO1xuXG4gICAgY29uc3QgcmVzdWx0UGFnZSA9IGF3YWl0IHRoaXMuaHR0cC5wb3N0KGZvcm1BY3Rpb24uaHJlZiwgcG9zdFZhbHVlcyk7XG5cbiAgICBpZiAocmVzdWx0UGFnZS5zdGF0dXNDb2RlID09PSAyMDApIHtcbiAgICAgIGNvbnN0IGVycm9yTXNnID0gdGhpcy5wYXJzZXIucmVtb3ZlVGFnc0h0bWwoXG4gICAgICAgIHJlc3VsdFBhZ2UuJCgnLmVycm9zIGxpJykuaHRtbCgpXG4gICAgICApO1xuICAgICAgaWYgKGVycm9yTXNnLmluY2x1ZGVzKCdBIHNlbmhhIGRpZ2l0YWRhIMOpIG11aXRvIHNpbXBsZXMuJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKHRoaXMuZXJyb3JJbnN1ZmZpY2llbnRQYXNzd29yZENvbXBsZXhpdHkpO1xuICAgICAgfVxuICAgICAgaWYgKGVycm9yTXNnLmluY2x1ZGVzKCdTZW5oYSBBdHVhbCBkaWdpdGFkYSBuw6NvIGNvbmZlcmUnKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IodGhpcy5lcnJvckludmFsaWRDcmVkZW50aWFscyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHJlc3VsdFBhZ2Uuc3RhdHVzQ29kZSAhPT0gMzAyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdTSUdBQTogVGhlIGNoYW5nZSBwYXNzd29yZCBwYWdlIHN0YXR1cyBjb2RlIGlzIGRpZmZlcmVudCB0aGFuIGV4cGVjdGVkLidcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG4iXX0=
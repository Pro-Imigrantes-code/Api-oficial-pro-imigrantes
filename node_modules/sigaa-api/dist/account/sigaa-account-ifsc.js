"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SigaaAccountIFSC = void 0;

require("source-map-support/register");

var _sigaaTypes = require("../sigaa-types");

var _url = require("url");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Responsible for representing the user account.
 * @category Internal
 */
class SigaaAccountIFSC {
  /**
   * @param homepage homepage (page after login) of user.
   */
  constructor(homepage, http, parser, session, bondFactory) {
    this.http = http;
    this.parser = parser;
    this.session = session;
    this.bondFactory = bondFactory;

    _defineProperty(this, "errorInvalidCredentials", 'SIGAA: Invalid credentials.');

    _defineProperty(this, "errorInsufficientPasswordComplexity", 'SIGAA: Insufficent password complexity.');

    _defineProperty(this, "_name", void 0);

    _defineProperty(this, "_emails", void 0);

    _defineProperty(this, "activeBonds", []);

    _defineProperty(this, "inactiveBonds", []);

    _defineProperty(this, "pagehomeParsePromise", void 0);

    this.parseHomepage(homepage);
  }
  /**
   * Error message when the new password chosen does not meet the security requirements of SIGAA.
   * It is thrown by the changePassword() method
   */


  /**
   * Parse login result page to fill the instance.
   *
   * @param homepage home page to parse.
   */
  parseHomepage(homepage) {
    //Since the login page can vary, we should check the type of page.
    if (homepage.bodyDecoded.includes('O sistema comportou-se de forma inesperada')) {
      throw new Error('SIGAA: Invalid homepage, the system behaved unexpectedly.');
    }

    if (homepage.url.href.includes('/portais/discente/discente.jsf')) {
      //If it is home page student of desktop version.
      this.pagehomeParsePromise = this.parseStudentHomePage(homepage);
    } else if (homepage.url.href.includes('/sigaa/vinculos.jsf') || homepage.url.href.includes('/sigaa/escolhaVinculo.do')) {
      //If it is bond page.
      this.pagehomeParsePromise = this.parseBondPage(homepage);
    } else if (homepage.url.href.includes('/sigaa/telasPosSelecaoVinculos.jsf')) {
      this.pagehomeParsePromise = this.http.get(homepage.url.href, {
        noCache: true
      }).then(page => this.parseBondPage(page));
    } else {
      throw new Error('SIGAA: Unknown homepage format.');
    }
  }
  /**
   * Parse bond page.
   * @param page page to parse.
   */


  async parseBondPage(page) {
    const rows = page.$('table.subFormulario tbody tr').toArray();

    for (const row of rows) {
      const cells = page.$(row).find('td').toArray();
      if (cells.length === 0) continue;
      const bondType = this.parser.removeTagsHtml(page.$(row).find('#tdTipo').html());
      const status = this.parser.removeTagsHtml(page.$(cells[3]).html());
      let bond;

      switch (bondType) {
        case 'Discente':
          {
            const registration = this.parser.removeTagsHtml(page.$(cells[2]).html());
            const url = page.$(row).find('a[href]').attr('href');
            if (!url) throw new Error('SIGAA: Bond switch url could not be found.');
            const bondSwitchUrl = new _url.URL(url, page.url);
            const program = this.parser.removeTagsHtml(page.$(cells[4]).html()).replace(/^Curso: /g, '');
            bond = this.bondFactory.createStudentBond(registration, program, bondSwitchUrl);
            break;
          }

        case 'Docente':
          {
            bond = this.bondFactory.createTeacherBond();
            break;
          }
      }

      if (bond) if (status === 'Sim') {
        this.activeBonds.push(bond);
      } else if (status === 'Não') {
        this.inactiveBonds.push(bond);
      } else {
        console.log('SIGAA: WARNING invalid status: ' + status);
      }
    }
  }
  /**
   * @inheritdoc
   */


  async getActiveBonds() {
    await this.pagehomeParsePromise;
    return this.activeBonds;
  }
  /**
   * @inheritdoc
   */


  async getInactiveBonds() {
    await this.pagehomeParsePromise;
    return this.inactiveBonds;
  }
  /**
   * Parse desktop version of student home page page.
   */


  async parseStudentHomePage(homepage) {
    const rows = homepage.$('#perfil-docente table').eq(0).find('tr').toArray();
    let registration;
    let program;
    let status;
    const buttonSwitchBond = this.parser.removeTagsHtml(homepage.$('#info-usuario p i small a').html());

    if (buttonSwitchBond === 'Alterar vínculo') {
      const bondPage = await this.http.get('/sigaa/vinculos.jsf');
      return this.parseBondPage(bondPage);
    }

    for (const row of rows) {
      const cells = homepage.$(row).find('td');

      if (cells.length !== 2) {
        throw new Error('SIGAA: Invalid student details page.');
      }

      const rowName = this.parser.removeTagsHtml(cells.eq(0).html());

      switch (rowName) {
        case 'Matrícula:':
          registration = this.parser.removeTagsHtml(cells.eq(1).html());
          break;

        case 'Curso:':
          program = this.parser.removeTagsHtml(cells.eq(1).html()).replace(/ - (M|T|N)$/g, ''); // Remove schedule letter

          break;

        case 'Status:':
          status = this.parser.removeTagsHtml(cells.eq(1).html());
      }

      if (registration && program && status) break;
    }

    if (!registration) throw new Error('SIGAA: Student bond without registration code.');
    if (!program) throw new Error('SIGAA: Student bond program not found.');
    if (!status) throw new Error('SIGAA: Student bond status not found.');
    if (status === 'CURSANDO' || status === 'CONCLUINTE') this.activeBonds.push(this.bondFactory.createStudentBond(registration, program, null));else this.inactiveBonds.push(this.bondFactory.createStudentBond(registration, program, null));
  }
  /**
   * @inheritdoc
   */


  logoff() {
    return this.http.get('/sigaa/logar.do?dispatch=logOff').then(page => {
      return this.http.followAllRedirect(page);
    }).then(page => {
      if (page.statusCode !== 200) {
        throw new Error('SIGAA: Invalid status code in logoff page.');
      }

      this.session.loginStatus = _sigaaTypes.LoginStatus.Unauthenticated;
      this.http.closeSession();
    });
  }
  /**
   * Get profile picture URL.
   * @retuns Picture url or null if the user has no photo.
   */


  async getProfilePictureURL() {
    const page = await this.http.get('/sigaa/portais/discente/discente.jsf');
    const pictureElement = page.$('div[class="foto"] img');
    if (pictureElement.length === 0) return null;
    const pictureSrc = pictureElement.attr('src');
    if (!pictureSrc || pictureSrc.includes('/sigaa/img/no_picture.png')) return null;
    return new _url.URL(pictureSrc, page.url);
  }
  /**
   * Download profile url and save in basepath.
   * @param destpath It can be a folder or a file name, if it is a directory then it will be saved inside the folder, if it is a file name it will be saved exactly in this place, but if the folder does not exist it will throw an error.
   * @param callback To know the progress of the download, each downloaded part will be called informing how much has already been downloaded.
   * @retuns Full path of the downloaded file, useful if the destpath is a directory, or null if the user has no photo.
   */


  async downloadProfilePicture(destpath, callback) {
    const pictureURL = await this.getProfilePictureURL();
    if (!pictureURL) return null;
    return this.http.downloadFileByGet(pictureURL.href, destpath, callback);
  }
  /**
   * @inheritdoc
   */


  async getName() {
    if (this._name) return this._name;
    const page = await this.http.get('/sigaa/portais/discente/discente.jsf');

    if (page.statusCode === 200) {
      const username = this.parser.removeTagsHtml(page.$('p.usuario > span').html());
      this._name = username;
      return username;
    } else {
      throw new Error('SIGAA: Unexpected status code at student profile page.');
    }
  }
  /**
   * @inheritdoc
   */


  async getEmails() {
    if (this._emails) return this._emails;
    const page = await this.http.get('/sigaa/portais/discente/discente.jsf');

    if (page.statusCode === 200) {
      const buttons = page.$('#perfil-docente .pessoal-docente').find('a[onclick]').toArray();

      for (const button of buttons) {
        const buttonName = this.parser.removeTagsHtml(page.$(button).html());

        if (buttonName === 'Meus Dados Pessoais') {
          const buttonOnClick = page.$(button).attr('onclick');

          if (buttonOnClick) {
            const form = page.parseJSFCLJS(buttonOnClick);
            const myPersonalDataPage = await this.http.post(form.action.href, form.postValues);
            const rows = myPersonalDataPage.$('td[colspan="3"] table tbody tr').toArray();
            this._emails = [];

            for (const row of rows) {
              const email = this.parser.removeTagsHtml(page.$(row).html());

              this._emails.push(email);
            }
          }

          break;
        }
      }

      if (this._emails) return this._emails;
      return [];
    } else {
      throw new Error('SIGAA: Unexpected status code at student profile page.');
    }
  }
  /**
   * Change the password of account.
   * @param oldPassword current password.
   * @param newPassword new password.
   * @throws {errorInvalidCredentials} If current password is not correct.
   * @throws {errorInsufficientPasswordComplexity} If the new password does not have the complexity requirement.
   */


  async changePassword(oldPassword, newPassword) {
    const formPage = await this.http.get('/sigaa/alterar_dados.jsf');
    if (formPage.statusCode !== 302) throw new Error('SIGAA: Unexpected status code at change password form.');
    const prePage = await this.http.followAllRedirect(formPage);
    if (prePage.statusCode !== 200 || !prePage.url.href.includes('usuario/alterar_dados.jsf')) throw new Error('SIGAA: Invalid pre page at change password.');
    const preFormElement = prePage.$('form[name="form"]');
    const preAction = preFormElement.attr('action');
    if (!preAction) throw new Error('SIGAA: Form without action at change password pre page.');
    const preActionUrl = new _url.URL(preAction, prePage.url.href);
    const prePostValues = {};
    const preInputs = preFormElement.find("input[name]:not([type='submit'])").toArray();

    for (const input of preInputs) {
      const name = prePage.$(input).attr('name');

      if (name) {
        prePostValues[name] = prePage.$(input).val();
      }
    }

    prePostValues['form:alterarSenha'] = 'form:alterarSenha';
    const page = await this.http.post(preActionUrl.href, prePostValues);
    const formElement = page.$('form[name="form"]');
    const action = formElement.attr('action');
    if (!action) throw new Error('SIGAA: Form without action at change password page.');
    const formAction = new _url.URL(action, page.url.href);
    const postValues = {};
    const inputs = formElement.find("input[name]:not([type='submit'])").toArray();

    for (const input of inputs) {
      const name = page.$(input).attr('name');

      if (name) {
        postValues[name] = prePage.$(input).val();
      }
    }

    postValues['form:senhaAtual'] = oldPassword;
    postValues['form:novaSenha'] = newPassword;
    postValues['form:repetnNovaSenha'] = newPassword;
    postValues['form:alterarDados'] = 'Alterar Dados';
    const resultPage = await this.http.post(formAction.href, postValues);

    if (resultPage.statusCode === 200) {
      const errorMsg = this.parser.removeTagsHtml(resultPage.$('.erros li').html());

      if (errorMsg.includes('A senha digitada é muito simples.')) {
        throw new Error(this.errorInsufficientPasswordComplexity);
      }

      if (errorMsg.includes('Senha Atual digitada não confere')) {
        throw new Error(this.errorInvalidCredentials);
      }
    }

    if (resultPage.statusCode !== 302) {
      throw new Error('SIGAA: The change password page status code is different than expected.');
    }
  }

}

exports.SigaaAccountIFSC = SigaaAccountIFSC;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hY2NvdW50L3NpZ2FhLWFjY291bnQtaWZzYy50cyJdLCJuYW1lcyI6WyJTaWdhYUFjY291bnRJRlNDIiwiY29uc3RydWN0b3IiLCJob21lcGFnZSIsImh0dHAiLCJwYXJzZXIiLCJzZXNzaW9uIiwiYm9uZEZhY3RvcnkiLCJwYXJzZUhvbWVwYWdlIiwiYm9keURlY29kZWQiLCJpbmNsdWRlcyIsIkVycm9yIiwidXJsIiwiaHJlZiIsInBhZ2Vob21lUGFyc2VQcm9taXNlIiwicGFyc2VTdHVkZW50SG9tZVBhZ2UiLCJwYXJzZUJvbmRQYWdlIiwiZ2V0Iiwibm9DYWNoZSIsInRoZW4iLCJwYWdlIiwicm93cyIsIiQiLCJ0b0FycmF5Iiwicm93IiwiY2VsbHMiLCJmaW5kIiwibGVuZ3RoIiwiYm9uZFR5cGUiLCJyZW1vdmVUYWdzSHRtbCIsImh0bWwiLCJzdGF0dXMiLCJib25kIiwicmVnaXN0cmF0aW9uIiwiYXR0ciIsImJvbmRTd2l0Y2hVcmwiLCJVUkwiLCJwcm9ncmFtIiwicmVwbGFjZSIsImNyZWF0ZVN0dWRlbnRCb25kIiwiY3JlYXRlVGVhY2hlckJvbmQiLCJhY3RpdmVCb25kcyIsInB1c2giLCJpbmFjdGl2ZUJvbmRzIiwiY29uc29sZSIsImxvZyIsImdldEFjdGl2ZUJvbmRzIiwiZ2V0SW5hY3RpdmVCb25kcyIsImVxIiwiYnV0dG9uU3dpdGNoQm9uZCIsImJvbmRQYWdlIiwicm93TmFtZSIsImxvZ29mZiIsImZvbGxvd0FsbFJlZGlyZWN0Iiwic3RhdHVzQ29kZSIsImxvZ2luU3RhdHVzIiwiTG9naW5TdGF0dXMiLCJVbmF1dGhlbnRpY2F0ZWQiLCJjbG9zZVNlc3Npb24iLCJnZXRQcm9maWxlUGljdHVyZVVSTCIsInBpY3R1cmVFbGVtZW50IiwicGljdHVyZVNyYyIsImRvd25sb2FkUHJvZmlsZVBpY3R1cmUiLCJkZXN0cGF0aCIsImNhbGxiYWNrIiwicGljdHVyZVVSTCIsImRvd25sb2FkRmlsZUJ5R2V0IiwiZ2V0TmFtZSIsIl9uYW1lIiwidXNlcm5hbWUiLCJnZXRFbWFpbHMiLCJfZW1haWxzIiwiYnV0dG9ucyIsImJ1dHRvbiIsImJ1dHRvbk5hbWUiLCJidXR0b25PbkNsaWNrIiwiZm9ybSIsInBhcnNlSlNGQ0xKUyIsIm15UGVyc29uYWxEYXRhUGFnZSIsInBvc3QiLCJhY3Rpb24iLCJwb3N0VmFsdWVzIiwiZW1haWwiLCJjaGFuZ2VQYXNzd29yZCIsIm9sZFBhc3N3b3JkIiwibmV3UGFzc3dvcmQiLCJmb3JtUGFnZSIsInByZVBhZ2UiLCJwcmVGb3JtRWxlbWVudCIsInByZUFjdGlvbiIsInByZUFjdGlvblVybCIsInByZVBvc3RWYWx1ZXMiLCJwcmVJbnB1dHMiLCJpbnB1dCIsIm5hbWUiLCJ2YWwiLCJmb3JtRWxlbWVudCIsImZvcm1BY3Rpb24iLCJpbnB1dHMiLCJyZXN1bHRQYWdlIiwiZXJyb3JNc2ciLCJlcnJvckluc3VmZmljaWVudFBhc3N3b3JkQ29tcGxleGl0eSIsImVycm9ySW52YWxpZENyZWRlbnRpYWxzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFHQTs7QUFJQTs7OztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ08sTUFBTUEsZ0JBQU4sQ0FBMEM7QUFDL0M7QUFDRjtBQUNBO0FBQ0VDLEVBQUFBLFdBQVcsQ0FDVEMsUUFEUyxFQUVEQyxJQUZDLEVBR0RDLE1BSEMsRUFJREMsT0FKQyxFQUtEQyxXQUxDLEVBTVQ7QUFBQSxTQUpRSCxJQUlSLEdBSlFBLElBSVI7QUFBQSxTQUhRQyxNQUdSLEdBSFFBLE1BR1I7QUFBQSxTQUZRQyxPQUVSLEdBRlFBLE9BRVI7QUFBQSxTQURRQyxXQUNSLEdBRFFBLFdBQ1I7O0FBQUEscURBUWlDLDZCQVJqQzs7QUFBQSxpRUFlQSx5Q0FmQTs7QUFBQTs7QUFBQTs7QUFBQSx5Q0E4QmdDLEVBOUJoQzs7QUFBQSwyQ0FtQ2tDLEVBbkNsQzs7QUFBQTs7QUFDQSxTQUFLQyxhQUFMLENBQW1CTCxRQUFuQjtBQUNEO0FBRUQ7QUFDRjtBQUNBO0FBQ0E7OztBQW1DRTtBQUNGO0FB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VUFBVSxHQUFHLE1BQU0sS0FBSy9GLElBQUwsQ0FBVTJFLElBQVYsQ0FBZWtCLFVBQVUsQ0FBQ3BGLElBQTFCLEVBQWdDb0UsVUFBaEMsQ0FBekI7O0FBRUEsUUFBSWtCLFVBQVUsQ0FBQzdDLFVBQVgsS0FBMEIsR0FBOUIsRUFBbUM7QUFDakMsWUFBTThDLFFBQVEsR0FBRyxLQUFLL0YsTUFBTCxDQUFZd0IsY0FBWixDQUNmc0UsVUFBVSxDQUFDN0UsQ0FBWCxDQUFhLFdBQWIsRUFBMEJRLElBQTFCLEVBRGUsQ0FBakI7O0FBR0EsVUFBSXNFLFFBQVEsQ0FBQzFGLFFBQVQsQ0FBa0IsbUNBQWxCLENBQUosRUFBNEQ7QUFDMUQsY0FBTSxJQUFJQyxLQUFKLENBQVUsS0FBSzBGLG1DQUFmLENBQU47QUFDRDs7QUFDRCxVQUFJRCxRQUFRLENBQUMxRixRQUFULENBQWtCLGtDQUFsQixDQUFKLEVBQTJEO0FBQ3pELGNBQU0sSUFBSUMsS0FBSixDQUFVLEtBQUsyRix1QkFBZixDQUFOO0FBQ0Q7QUFDRjs7QUFFRCxRQUFJSCxVQUFVLENBQUM3QyxVQUFYLEtBQTBCLEdBQTlCLEVBQW1DO0FBQ2pDLFlBQU0sSUFBSTNDLEtBQUosQ0FDSix5RUFESSxDQUFOO0FBR0Q7QUFDRjs7QUFwWjhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGFyc2VyIH0gZnJvbSAnQGhlbHBlcnMvc2lnYWEtcGFyc2VyJztcbmltcG9ydCB7IEhUVFAsIFByb2dyZXNzQ2FsbGJhY2sgfSBmcm9tICdAc2Vzc2lvbi9zaWdhYS1odHRwJztcbmltcG9ydCB7IFNlc3Npb24gfSBmcm9tICdAc2Vzc2lvbi9zaWdhYS1zZXNzaW9uJztcbmltcG9ydCB7IExvZ2luU3RhdHVzIH0gZnJvbSAnLi4vc2lnYWEtdHlwZXMnO1xuaW1wb3J0IHsgQm9uZEZhY3RvcnksIEJvbmRUeXBlIH0gZnJvbSAnQGJvbmRzL3NpZ2FhLWJvbmQtZmFjdG9yeSc7XG5pbXBvcnQgeyBQYWdlIH0gZnJvbSAnQHNlc3Npb24vc2lnYWEtcGFnZSc7XG5pbXBvcnQgeyBBY2NvdW50IH0gZnJvbSAnLi9zaWdhYS1hY2NvdW50JztcbmltcG9ydCB7IFVSTCB9IGZyb20gJ3VybCc7XG5cbi8qKlxuICogUmVzcG9uc2libGUgZm9yIHJlcHJlc2VudGluZyB0aGUgdXNlciBhY2NvdW50LlxuICogQGNhdGVnb3J5IEludGVybmFsXG4gKi9cbmV4cG9ydCBjbGFzcyBTaWdhYUFjY291bnRJRlNDIGltcGxlbWVudHMgQWNjb3VudCB7XG4gIC8qKlxuICAgKiBAcGFyYW0gaG9tZXBhZ2UgaG9tZXBhZ2UgKHBhZ2UgYWZ0ZXIgbG9naW4pIG9mIHVzZXIuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBob21lcGFnZTogUGFnZSxcbiAgICBwcml2YXRlIGh0dHA6IEhUVFAsXG4gICAgcHJpdmF0ZSBwYXJzZXI6IFBhcnNlcixcbiAgICBwcml2YXRlIHNlc3Npb246IFNlc3Npb24sXG4gICAgcHJpdmF0ZSBib25kRmFjdG9yeTogQm9uZEZhY3RvcnlcbiAgKSB7XG4gICAgdGhpcy5wYXJzZUhvbWVwYWdlKGhvbWVwYWdlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFcnJvciBtZXNzYWdlIHdoZW4gdGhlIG5ldyBwYXNzd29yZCBjaG9zZW4gZG9lcyBub3QgbWVldCB0aGUgc2VjdXJpdHkgcmVxdWlyZW1lbnRzIG9mIFNJR0FBLlxuICAgKiBJdCBpcyB0aHJvd24gYnkgdGhlIGNoYW5nZVBhc3N3b3JkKCkgbWV0aG9kXG4gICAqL1xuICByZWFkb25seSBlcnJvckludmFsaWRDcmVkZW50aWFscyA9ICdTSUdBQTogSW52YWxpZCBjcmVkZW50aWFscy4nO1xuXG4gIC8qKlxuICAgKiBFcnJvciBtZXNzYWdlIHdoZW4gdGhlIG9sZCBwYXNzd29yZCBpcyBub3QgdGhlIGN1cnJlbnQgcGFzc3dvcmQuXG4gICAqIEl0IGlzIHRocm93biBieSB0aGUgY2hhbmdlUGFzc3dvcmQoKSBtZXRob2QuXG4gICAqL1xuICByZWFkb25seSBlcnJvckluc3VmZmljaWVudFBhc3N3b3JkQ29tcGxleGl0eSA9XG4gICAgJ1NJR0FBOiBJbnN1ZmZpY2VudCBwYXNzd29yZCBjb21wbGV4aXR5Lic7XG5cbiAgLyoqXG4gICAqIFN0dWRlbnQgbmFtZSBjYWNoZVxuICAgKi9cbiAgcHJpdmF0ZSBfbmFtZT86IHN0cmluZztcblxuICAvKipcbiAgICogU3R1ZGVudCBlLW1haWwgY2FjaGVcbiAgICovXG4gIHByaXZhdGUgX2VtYWlscz86IHN0cmluZ1tdO1xuXG4gIC8qKlxuICAgKiBBcnJheSBvZiBhY3RpdmUgYm9uZHMuXG4gICAqL1xuICBwcml2YXRlIGFjdGl2ZUJvbmRzOiBCb25kVHlwZVtdID0gW107XG5cbiAgLyoqXG4gICAqIEFycmF5IG9mIGluYWN0aXZlIGJvbmRzLlxuICAgKi9cbiAgcHJpdmF0ZSBpbmFjdGl2ZUJvbmRzOiBCb25kVHlwZVtdID0gW107XG5cbiAgLyoqXG4gICAqIEl0IGlzIGEgcHJvbWlzZSB0aGF0IHN0b3JlcyBpZiB0aGUgcGFnZSBwYXJzZXIgaGFzIGFscmVhZHkgY29tcGxldGVkXG4gICAqL1xuICBwcml2YXRlIHBhZ2Vob21lUGFyc2VQcm9taXNlPzogUHJvbWlzZTx2b2lkPjtcblxuICAvKipcbiAgICogUGFyc2UgbG9naW4gcmVzdWx0IHBhZ2UgdG8gZmlsbCB0aGUgaW5zdGFuY2UuXG4gICAqXG4gICAqIEBwYXJhbSBob21lcGFnZSBob21lIHBhZ2UgdG8gcGFyc2UuXG4gICAqL1xuICBwcml2YXRlIHBhcnNlSG9tZXBhZ2UoaG9tZXBhZ2U6IFBhZ2UpOiB2b2lkIHtcbiAgICAvL1NpbmNlIHRoZSBsb2dpbiBwYWdlIGNhbiB2YXJ5LCB3ZSBzaG91bGQgY2hlY2sgdGhlIHR5cGUgb2YgcGFnZS5cbiAgICBpZiAoXG4gICAgICBob21lcGFnZS5ib2R5RGVjb2RlZC5pbmNsdWRlcyhcbiAgICAgICAgJ08gc2lzdGVtYSBjb21wb3J0b3Utc2UgZGUgZm9ybWEgaW5lc3BlcmFkYSdcbiAgICAgIClcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ1NJR0FBOiBJbnZhbGlkIGhvbWVwYWdlLCB0aGUgc3lzdGVtIGJlaGF2ZWQgdW5leHBlY3RlZGx5LidcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChob21lcGFnZS51cmwuaHJlZi5pbmNsdWRlcygnL3BvcnRhaXMvZGlzY2VudGUvZGlzY2VudGUuanNmJykpIHtcbiAgICAgIC8vSWYgaXQgaXMgaG9tZSBwYWdlIHN0dWRlbnQgb2YgZGVza3RvcCB2ZXJzaW9uLlxuICAgICAgdGhpcy5wYWdlaG9tZVBhcnNlUHJvbWlzZSA9IHRoaXMucGFyc2VTdHVkZW50SG9tZVBhZ2UoaG9tZXBhZ2UpO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICBob21lcGFnZS51cmwuaHJlZi5pbmNsdWRlcygnL3NpZ2FhL3ZpbmN1bG9zLmpzZicpIHx8XG4gICAgICBob21lcGFnZS51cmwuaHJlZi5pbmNsdWRlcygnL3NpZ2FhL2VzY29saGFWaW5jdWxvLmRvJylcbiAgICApIHtcbiAgICAgIC8vSWYgaXQgaXMgYm9uZCBwYWdlLlxuICAgICAgdGhpcy5wYWdlaG9tZVBhcnNlUHJvbWlzZSA9IHRoaXMucGFyc2VCb25kUGFnZShob21lcGFnZSk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIGhvbWVwYWdlLnVybC5ocmVmLmluY2x1ZGVzKCcvc2lnYWEvdGVsYXNQb3NTZWxlY2FvVmluY3Vsb3MuanNmJylcbiAgICApIHtcbiAgICAgIHRoaXMucGFnZWhvbWVQYXJzZVByb21pc2UgPSB0aGlzLmh0dHBcbiAgICAgICAgLmdldChob21lcGFnZS51cmwuaHJlZiwgeyBub0NhY2hlOiB0cnVlIH0pXG4gICAgICAgIC50aGVuKChwYWdlKSA9PiB0aGlzLnBhcnNlQm9uZFBhZ2UocGFnZSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBVbmtub3duIGhvbWVwYWdlIGZvcm1hdC4nKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUGFyc2UgYm9uZCBwYWdlLlxuICAgKiBAcGFyYW0gcGFnZSBwYWdlIHRvIHBhcnNlLlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBwYXJzZUJvbmRQYWdlKHBhZ2U6IFBhZ2UpIHtcbiAgICBjb25zdCByb3dzID0gcGFnZS4kKCd0YWJsZS5zdWJGb3JtdWxhcmlvIHRib2R5IHRyJykudG9BcnJheSgpO1xuICAgIGZvciAoY29uc3Qgcm93IG9mIHJvd3MpIHtcbiAgICAgIGNvbnN0IGNlbGxzID0gcGFnZS4kKHJvdykuZmluZCgndGQnKS50b0FycmF5KCk7XG4gICAgICBpZiAoY2VsbHMubGVuZ3RoID09PSAwKSBjb250aW51ZTtcblxuICAgICAgY29uc3QgYm9uZFR5cGUgPSB0aGlzLnBhcnNlci5yZW1vdmVUYWdzSHRtbChcbiAgICAgICAgcGFnZS4kKHJvdykuZmluZCgnI3RkVGlwbycpLmh0bWwoKVxuICAgICAgKTtcbiAgICAgIGNvbnN0IHN0YXR1cyA9IHRoaXMucGFyc2VyLnJlbW92ZVRhZ3NIdG1sKHBhZ2UuJChjZWxsc1szXSkuaHRtbCgpKTtcbiAgICAgIGxldCBib25kO1xuICAgICAgc3dpdGNoIChib25kVHlwZSkge1xuICAgICAgICBjYXNlICdEaXNjZW50ZSc6IHtcbiAgICAgICAgICBjb25zdCByZWdpc3RyYXRpb24gPSB0aGlzLnBhcnNlci5yZW1vdmVUYWdzSHRtbChcbiAgICAgICAgICAgIHBhZ2UuJChjZWxsc1syXSkuaHRtbCgpXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIGNvbnN0IHVybCA9IHBhZ2UuJChyb3cpLmZpbmQoJ2FbaHJlZl0nKS5hdHRyKCdocmVmJyk7XG4gICAgICAgICAgaWYgKCF1cmwpXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBCb25kIHN3aXRjaCB1cmwgY291bGQgbm90IGJlIGZvdW5kLicpO1xuICAgICAgICAgIGNvbnN0IGJvbmRTd2l0Y2hVcmwgPSBuZXcgVVJMKHVybCwgcGFnZS51cmwpO1xuXG4gICAgICAgICAgY29uc3QgcHJvZ3JhbSA9IHRoaXMucGFyc2VyXG4gICAgICAgICAgICAucmVtb3ZlVGFnc0h0bWwocGFnZS4kKGNlbGxzWzRdKS5odG1sKCkpXG4gICAgICAgICAgICAucmVwbGFjZSgvXkN1cnNvOiAvZywgJycpO1xuICAgICAgICAgIGJvbmQgPSB0aGlzLmJvbmRGYWN0b3J5LmNyZWF0ZVN0dWRlbnRCb25kKFxuICAgICAgICAgICAgcmVnaXN0cmF0aW9uLFxuICAgICAgICAgICAgcHJvZ3JhbSxcbiAgICAgICAgICAgIGJvbmRTd2l0Y2hVcmxcbiAgICAgICAgICApO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgJ0RvY2VudGUnOiB7XG4gICAgICAgICAgYm9uZCA9IHRoaXMuYm9uZEZhY3RvcnkuY3JlYXRlVGVhY2hlckJvbmQoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGJvbmQpXG4gICAgICAgIGlmIChzdGF0dXMgPT09ICdTaW0nKSB7XG4gICAgICAgICAgdGhpcy5hY3RpdmVCb25kcy5wdXNoKGJvbmQpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gJ07Do28nKSB7XG4gICAgICAgICAgdGhpcy5pbmFjdGl2ZUJvbmRzLnB1c2goYm9uZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ1NJR0FBOiBXQVJOSU5HIGludmFsaWQgc3RhdHVzOiAnICsgc3RhdHVzKTtcbiAgICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKi9cbiAgYXN5bmMgZ2V0QWN0aXZlQm9uZHMoKTogUHJvbWlzZTxCb25kVHlwZVtdPiB7XG4gICAgYXdhaXQgdGhpcy5wYWdlaG9tZVBhcnNlUHJvbWlzZTtcbiAgICByZXR1cm4gdGhpcy5hY3RpdmVCb25kcztcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKi9cbiAgYXN5bmMgZ2V0SW5hY3RpdmVCb25kcygpOiBQcm9taXNlPEJvbmRUeXBlW10+IHtcbiAgICBhd2FpdCB0aGlzLnBhZ2Vob21lUGFyc2VQcm9taXNlO1xuICAgIHJldHVybiB0aGlzLmluYWN0aXZlQm9uZHM7XG4gIH1cblxuICAvKipcbiAgICogUGFyc2UgZGVza3RvcCB2ZXJzaW9uIG9mIHN0dWRlbnQgaG9tZSBwYWdlIHBhZ2UuXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIHBhcnNlU3R1ZGVudEhvbWVQYWdlKGhvbWVwYWdlOiBQYWdlKSB7XG4gICAgY29uc3Qgcm93cyA9IGhvbWVwYWdlLiQoJyNwZXJmaWwtZG9jZW50ZSB0YWJsZScpLmVxKDApLmZpbmQoJ3RyJykudG9BcnJheSgpO1xuICAgIGxldCByZWdpc3RyYXRpb247XG4gICAgbGV0IHByb2dyYW07XG4gICAgbGV0IHN0YXR1cztcblxuICAgIGNvbnN0IGJ1dHRvblN3aXRjaEJvbmQgPSB0aGlzLnBhcnNlci5yZW1vdmVUYWdzSHRtbChcbiAgICAgIGhvbWVwYWdlLiQoJyNpbmZvLXVzdWFyaW8gcCBpIHNtYWxsIGEnKS5odG1sKClcbiAgICApO1xuICAgIGlmIChidXR0b25Td2l0Y2hCb25kID09PSAnQWx0ZXJhciB2w61uY3VsbycpIHtcbiAgICAgIGNvbnN0IGJvbmRQYWdlID0gYXdhaXQgdGhpcy5odHRwLmdldCgnL3NpZ2FhL3ZpbmN1bG9zLmpzZicpO1xuICAgICAgcmV0dXJuIHRoaXMucGFyc2VCb25kUGFnZShib25kUGFnZSk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCByb3cgb2Ygcm93cykge1xuICAgICAgY29uc3QgY2VsbHMgPSBob21lcGFnZS4kKHJvdykuZmluZCgndGQnKTtcbiAgICAgIGlmIChjZWxscy5sZW5ndGggIT09IDIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogSW52YWxpZCBzdHVkZW50IGRldGFpbHMgcGFnZS4nKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJvd05hbWUgPSB0aGlzLnBhcnNlci5yZW1vdmVUYWdzSHRtbChjZWxscy5lcSgwKS5odG1sKCkpO1xuICAgICAgc3dpdGNoIChyb3dOYW1lKSB7XG4gICAgICAgIGNhc2UgJ01hdHLDrWN1bGE6JzpcbiAgICAgICAgICByZWdpc3RyYXRpb24gPSB0aGlzLnBhcnNlci5yZW1vdmVUYWdzSHRtbChjZWxscy5lcSgxKS5odG1sKCkpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdDdXJzbzonOlxuICAgICAgICAgIHByb2dyYW0gPSB0aGlzLnBhcnNlclxuICAgICAgICAgICAgLnJlbW92ZVRhZ3NIdG1sKGNlbGxzLmVxKDEpLmh0bWwoKSlcbiAgICAgICAgICAgIC5yZXBsYWNlKC8gLSAoTXxUfE4pJC9nLCAnJyk7IC8vIFJlbW92ZSBzY2hlZHVsZSBsZXR0ZXJcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnU3RhdHVzOic6XG4gICAgICAgICAgc3RhdHVzID0gdGhpcy5wYXJzZXIucmVtb3ZlVGFnc0h0bWwoY2VsbHMuZXEoMSkuaHRtbCgpKTtcbiAgICAgIH1cbiAgICAgIGlmIChyZWdpc3RyYXRpb24gJiYgcHJvZ3JhbSAmJiBzdGF0dXMpIGJyZWFrO1xuICAgIH1cblxuICAgIGlmICghcmVnaXN0cmF0aW9uKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogU3R1ZGVudCBib25kIHdpdGhvdXQgcmVnaXN0cmF0aW9uIGNvZGUuJyk7XG5cbiAgICBpZiAoIXByb2dyYW0pIHRocm93IG5ldyBFcnJvcignU0lHQUE6IFN0dWRlbnQgYm9uZCBwcm9ncmFtIG5vdCBmb3VuZC4nKTtcblxuICAgIGlmICghc3RhdHVzKSB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBTdHVkZW50IGJvbmQgc3RhdHVzIG5vdCBmb3VuZC4nKTtcbiAgICBpZiAoc3RhdHVzID09PSAnQ1VSU0FORE8nIHx8IHN0YXR1cyA9PT0gJ0NPTkNMVUlOVEUnKVxuICAgICAgdGhpcy5hY3RpdmVCb25kcy5wdXNoKFxuICAgICAgICB0aGlzLmJvbmRGYWN0b3J5LmNyZWF0ZVN0dWRlbnRCb25kKHJlZ2lzdHJhdGlvbiwgcHJvZ3JhbSwgbnVsbClcbiAgICAgICk7XG4gICAgZWxzZVxuICAgICAgdGhpcy5pbmFjdGl2ZUJvbmRzLnB1c2goXG4gICAgICAgIHRoaXMuYm9uZEZhY3RvcnkuY3JlYXRlU3R1ZGVudEJvbmQocmVnaXN0cmF0aW9uLCBwcm9ncmFtLCBudWxsKVxuICAgICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKi9cbiAgbG9nb2ZmKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5nZXQoJy9zaWdhYS9sb2dhci5kbz9kaXNwYXRjaD1sb2dPZmYnKVxuICAgICAgLnRoZW4oKHBhZ2UpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5mb2xsb3dBbGxSZWRpcmVjdChwYWdlKTtcbiAgICAgIH0pXG4gICAgICAudGhlbigocGFnZSkgPT4ge1xuICAgICAgICBpZiAocGFnZS5zdGF0dXNDb2RlICE9PSAyMDApIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBJbnZhbGlkIHN0YXR1cyBjb2RlIGluIGxvZ29mZiBwYWdlLicpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2Vzc2lvbi5sb2dpblN0YXR1cyA9IExvZ2luU3RhdHVzLlVuYXV0aGVudGljYXRlZDtcbiAgICAgICAgdGhpcy5odHRwLmNsb3NlU2Vzc2lvbigpO1xuICAgICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHByb2ZpbGUgcGljdHVyZSBVUkwuXG4gICAqIEByZXR1bnMgUGljdHVyZSB1cmwgb3IgbnVsbCBpZiB0aGUgdXNlciBoYXMgbm8gcGhvdG8uXG4gICAqL1xuICBhc3luYyBnZXRQcm9maWxlUGljdHVyZVVSTCgpOiBQcm9taXNlPFVSTCB8IG51bGw+IHtcbiAgICBjb25zdCBwYWdlID0gYXdhaXQgdGhpcy5odHRwLmdldCgnL3NpZ2FhL3BvcnRhaXMvZGlzY2VudGUvZGlzY2VudGUuanNmJyk7XG5cbiAgICBjb25zdCBwaWN0dXJlRWxlbWVudCA9IHBhZ2UuJCgnZGl2W2NsYXNzPVwiZm90b1wiXSBpbWcnKTtcbiAgICBpZiAocGljdHVyZUVsZW1lbnQubGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbDtcbiAgICBjb25zdCBwaWN0dXJlU3JjID0gcGljdHVyZUVsZW1lbnQuYXR0cignc3JjJyk7XG4gICAgaWYgKCFwaWN0dXJlU3JjIHx8IHBpY3R1cmVTcmMuaW5jbHVkZXMoJy9zaWdhYS9pbWcvbm9fcGljdHVyZS5wbmcnKSlcbiAgICAgIHJldHVybiBudWxsO1xuICAgIHJldHVybiBuZXcgVVJMKHBpY3R1cmVTcmMsIHBhZ2UudXJsKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEb3dubG9hZCBwcm9maWxlIHVybCBhbmQgc2F2ZSBpbiBiYXNlcGF0aC5cbiAgICogQHBhcmFtIGRlc3RwYXRoIEl0IGNhbiBiZSBhIGZvbGRlciBvciBhIGZpbGUgbmFtZSwgaWYgaXQgaXMgYSBkaXJlY3RvcnkgdGhlbiBpdCB3aWxsIGJlIHNhdmVkIGluc2lkZSB0aGUgZm9sZGVyLCBpZiBpdCBpcyBhIGZpbGUgbmFtZSBpdCB3aWxsIGJlIHNhdmVkIGV4YWN0bHkgaW4gdGhpcyBwbGFjZSwgYnV0IGlmIHRoZSBmb2xkZXIgZG9lcyBub3QgZXhpc3QgaXQgd2lsbCB0aHJvdyBhbiBlcnJvci5cbiAgICogQHBhcmFtIGNhbGxiYWNrIFRvIGtub3cgdGhlIHByb2dyZXNzIG9mIHRoZSBkb3dubG9hZCwgZWFjaCBkb3dubG9hZGVkIHBhcnQgd2lsbCBiZSBjYWxsZWQgaW5mb3JtaW5nIGhvdyBtdWNoIGhhcyBhbHJlYWR5IGJlZW4gZG93bmxvYWRlZC5cbiAgICogQHJldHVucyBGdWxsIHBhdGggb2YgdGhlIGRvd25sb2FkZWQgZmlsZSwgdXNlZnVsIGlmIHRoZSBkZXN0cGF0aCBpcyBhIGRpcmVjdG9yeSwgb3IgbnVsbCBpZiB0aGUgdXNlciBoYXMgbm8gcGhvdG8uXG4gICAqL1xuICBhc3luYyBkb3dubG9hZFByb2ZpbGVQaWN0dXJlKFxuICAgIGRlc3RwYXRoOiBzdHJpbmcsXG4gICAgY2FsbGJhY2s/OiBQcm9ncmVzc0NhbGxiYWNrXG4gICk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICAgIGNvbnN0IHBpY3R1cmVVUkwgPSBhd2FpdCB0aGlzLmdldFByb2ZpbGVQaWN0dXJlVVJMKCk7XG4gICAgaWYgKCFwaWN0dXJlVVJMKSByZXR1cm4gbnVsbDtcbiAgICByZXR1cm4gdGhpcy5odHRwLmRvd25sb2FkRmlsZUJ5R2V0KHBpY3R1cmVVUkwuaHJlZiwgZGVzdHBhdGgsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKi9cbiAgYXN5bmMgZ2V0TmFtZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmICh0aGlzLl9uYW1lKSByZXR1cm4gdGhpcy5fbmFtZTtcbiAgICBjb25zdCBwYWdlID0gYXdhaXQgdGhpcy5odHRwLmdldCgnL3NpZ2FhL3BvcnRhaXMvZGlzY2VudGUvZGlzY2VudGUuanNmJyk7XG4gICAgaWYgKHBhZ2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICBjb25zdCB1c2VybmFtZSA9IHRoaXMucGFyc2VyLnJlbW92ZVRhZ3NIdG1sKFxuICAgICAgICBwYWdlLiQoJ3AudXN1YXJpbyA+IHNwYW4nKS5odG1sKClcbiAgICAgICk7XG4gICAgICB0aGlzLl9uYW1lID0gdXNlcm5hbWU7XG4gICAgICByZXR1cm4gdXNlcm5hbWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignU0lHQUE6IFVuZXhwZWN0ZWQgc3RhdHVzIGNvZGUgYXQgc3R1ZGVudCBwcm9maWxlIHBhZ2UuJyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqL1xuICBhc3luYyBnZXRFbWFpbHMoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGlmICh0aGlzLl9lbWFpbHMpIHJldHVybiB0aGlzLl9lbWFpbHM7XG4gICAgY29uc3QgcGFnZSA9IGF3YWl0IHRoaXMuaHR0cC5nZXQoJy9zaWdhYS9wb3J0YWlzL2Rpc2NlbnRlL2Rpc2NlbnRlLmpzZicpO1xuICAgIGlmIChwYWdlLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgY29uc3QgYnV0dG9ucyA9IHBhZ2VcbiAgICAgICAgLiQoJyNwZXJmaWwtZG9jZW50ZSAucGVzc29hbC1kb2NlbnRlJylcbiAgICAgICAgLmZpbmQoJ2Fbb25jbGlja10nKVxuICAgICAgICAudG9BcnJheSgpO1xuXG4gICAgICBmb3IgKGNvbnN0IGJ1dHRvbiBvZiBidXR0b25zKSB7XG4gICAgICAgIGNvbnN0IGJ1dHRvbk5hbWUgPSB0aGlzLnBhcnNlci5yZW1vdmVUYWdzSHRtbChwYWdlLiQoYnV0dG9uKS5odG1sKCkpO1xuICAgICAgICBpZiAoYnV0dG9uTmFtZSA9PT0gJ01ldXMgRGFkb3MgUGVzc29haXMnKSB7XG4gICAgICAgICAgY29uc3QgYnV0dG9uT25DbGljayA9IHBhZ2UuJChidXR0b24pLmF0dHIoJ29uY2xpY2snKTtcbiAgICAgICAgICBpZiAoYnV0dG9uT25DbGljaykge1xuICAgICAgICAgICAgY29uc3QgZm9ybSA9IHBhZ2UucGFyc2VKU0ZDTEpTKGJ1dHRvbk9uQ2xpY2spO1xuICAgICAgICAgICAgY29uc3QgbXlQZXJzb25hbERhdGFQYWdlID0gYXdhaXQgdGhpcy5odHRwLnBvc3QoXG4gICAgICAgICAgICAgIGZvcm0uYWN0aW9uLmhyZWYsXG4gICAgICAgICAgICAgIGZvcm0ucG9zdFZhbHVlc1xuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGNvbnN0IHJvd3MgPSBteVBlcnNvbmFsRGF0YVBhZ2VcbiAgICAgICAgICAgICAgLiQoJ3RkW2NvbHNwYW49XCIzXCJdIHRhYmxlIHRib2R5IHRyJylcbiAgICAgICAgICAgICAgLnRvQXJyYXkoKTtcbiAgICAgICAgICAgIHRoaXMuX2VtYWlscyA9IFtdO1xuICAgICAgICAgICAgZm9yIChjb25zdCByb3cgb2Ygcm93cykge1xuICAgICAgICAgICAgICBjb25zdCBlbWFpbCA9IHRoaXMucGFyc2VyLnJlbW92ZVRhZ3NIdG1sKHBhZ2UuJChyb3cpLmh0bWwoKSk7XG4gICAgICAgICAgICAgIHRoaXMuX2VtYWlscy5wdXNoKGVtYWlsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX2VtYWlscykgcmV0dXJuIHRoaXMuX2VtYWlscztcbiAgICAgIHJldHVybiBbXTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogVW5leHBlY3RlZCBzdGF0dXMgY29kZSBhdCBzdHVkZW50IHByb2ZpbGUgcGFnZS4nKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2hhbmdlIHRoZSBwYXNzd29yZCBvZiBhY2NvdW50LlxuICAgKiBAcGFyYW0gb2xkUGFzc3dvcmQgY3VycmVudCBwYXNzd29yZC5cbiAgICogQHBhcmFtIG5ld1Bhc3N3b3JkIG5ldyBwYXNzd29yZC5cbiAgICogQHRocm93cyB7ZXJyb3JJbnZhbGlkQ3JlZGVudGlhbHN9IElmIGN1cnJlbnQgcGFzc3dvcmQgaXMgbm90IGNvcnJlY3QuXG4gICAqIEB0aHJvd3Mge2Vycm9ySW5zdWZmaWNpZW50UGFzc3dvcmRDb21wbGV4aXR5fSBJZiB0aGUgbmV3IHBhc3N3b3JkIGRvZXMgbm90IGhhdmUgdGhlIGNvbXBsZXhpdHkgcmVxdWlyZW1lbnQuXG4gICAqL1xuICBhc3luYyBjaGFuZ2VQYXNzd29yZChcbiAgICBvbGRQYXNzd29yZDogc3RyaW5nLFxuICAgIG5ld1Bhc3N3b3JkOiBzdHJpbmdcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZm9ybVBhZ2UgPSBhd2FpdCB0aGlzLmh0dHAuZ2V0KCcvc2lnYWEvYWx0ZXJhcl9kYWRvcy5qc2YnKTtcbiAgICBpZiAoZm9ybVBhZ2Uuc3RhdHVzQ29kZSAhPT0gMzAyKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogVW5leHBlY3RlZCBzdGF0dXMgY29kZSBhdCBjaGFuZ2UgcGFzc3dvcmQgZm9ybS4nKTtcblxuICAgIGNvbnN0IHByZVBhZ2UgPSBhd2FpdCB0aGlzLmh0dHAuZm9sbG93QWxsUmVkaXJlY3QoZm9ybVBhZ2UpO1xuICAgIGlmIChcbiAgICAgIHByZVBhZ2Uuc3RhdHVzQ29kZSAhPT0gMjAwIHx8XG4gICAgICAhcHJlUGFnZS51cmwuaHJlZi5pbmNsdWRlcygndXN1YXJpby9hbHRlcmFyX2RhZG9zLmpzZicpXG4gICAgKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogSW52YWxpZCBwcmUgcGFnZSBhdCBjaGFuZ2UgcGFzc3dvcmQuJyk7XG5cbiAgICBjb25zdCBwcmVGb3JtRWxlbWVudCA9IHByZVBhZ2UuJCgnZm9ybVtuYW1lPVwiZm9ybVwiXScpO1xuXG4gICAgY29uc3QgcHJlQWN0aW9uID0gcHJlRm9ybUVsZW1lbnQuYXR0cignYWN0aW9uJyk7XG4gICAgaWYgKCFwcmVBY3Rpb24pXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdTSUdBQTogRm9ybSB3aXRob3V0IGFjdGlvbiBhdCBjaGFuZ2UgcGFzc3dvcmQgcHJlIHBhZ2UuJ1xuICAgICAgKTtcblxuICAgIGNvbnN0IHByZUFjdGlvblVybCA9IG5ldyBVUkwocHJlQWN0aW9uLCBwcmVQYWdlLnVybC5ocmVmKTtcblxuICAgIGNvbnN0IHByZVBvc3RWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcblxuICAgIGNvbnN0IHByZUlucHV0cyA9IHByZUZvcm1FbGVtZW50XG4gICAgICAuZmluZChcImlucHV0W25hbWVdOm5vdChbdHlwZT0nc3VibWl0J10pXCIpXG4gICAgICAudG9BcnJheSgpO1xuICAgIGZvciAoY29uc3QgaW5wdXQgb2YgcHJlSW5wdXRzKSB7XG4gICAgICBjb25zdCBuYW1lID0gcHJlUGFnZS4kKGlucHV0KS5hdHRyKCduYW1lJyk7XG4gICAgICBpZiAobmFtZSkge1xuICAgICAgICBwcmVQb3N0VmFsdWVzW25hbWVdID0gcHJlUGFnZS4kKGlucHV0KS52YWwoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcHJlUG9zdFZhbHVlc1snZm9ybTphbHRlcmFyU2VuaGEnXSA9ICdmb3JtOmFsdGVyYXJTZW5oYSc7XG4gICAgY29uc3QgcGFnZSA9IGF3YWl0IHRoaXMuaHR0cC5wb3N0KHByZUFjdGlvblVybC5ocmVmLCBwcmVQb3N0VmFsdWVzKTtcbiAgICBjb25zdCBmb3JtRWxlbWVudCA9IHBhZ2UuJCgnZm9ybVtuYW1lPVwiZm9ybVwiXScpO1xuXG4gICAgY29uc3QgYWN0aW9uID0gZm9ybUVsZW1lbnQuYXR0cignYWN0aW9uJyk7XG4gICAgaWYgKCFhY3Rpb24pXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBGb3JtIHdpdGhvdXQgYWN0aW9uIGF0IGNoYW5nZSBwYXNzd29yZCBwYWdlLicpO1xuICAgIGNvbnN0IGZvcm1BY3Rpb24gPSBuZXcgVVJMKGFjdGlvbiwgcGFnZS51cmwuaHJlZik7XG5cbiAgICBjb25zdCBwb3N0VmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG4gICAgY29uc3QgaW5wdXRzID0gZm9ybUVsZW1lbnRcbiAgICAgIC5maW5kKFwiaW5wdXRbbmFtZV06bm90KFt0eXBlPSdzdWJtaXQnXSlcIilcbiAgICAgIC50b0FycmF5KCk7XG4gICAgZm9yIChjb25zdCBpbnB1dCBvZiBpbnB1dHMpIHtcbiAgICAgIGNvbnN0IG5hbWUgPSBwYWdlLiQoaW5wdXQpLmF0dHIoJ25hbWUnKTtcbiAgICAgIGlmIChuYW1lKSB7XG4gICAgICAgIHBvc3RWYWx1ZXNbbmFtZV0gPSBwcmVQYWdlLiQoaW5wdXQpLnZhbCgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHBvc3RWYWx1ZXNbJ2Zvcm06c2VuaGFBdHVhbCddID0gb2xkUGFzc3dvcmQ7XG4gICAgcG9zdFZhbHVlc1snZm9ybTpub3ZhU2VuaGEnXSA9IG5ld1Bhc3N3b3JkO1xuICAgIHBvc3RWYWx1ZXNbJ2Zvcm06cmVwZXRuTm92YVNlbmhhJ10gPSBuZXdQYXNzd29yZDtcbiAgICBwb3N0VmFsdWVzWydmb3JtOmFsdGVyYXJEYWRvcyddID0gJ0FsdGVyYXIgRGFkb3MnO1xuXG4gICAgY29uc3QgcmVzdWx0UGFnZSA9IGF3YWl0IHRoaXMuaHR0cC5wb3N0KGZvcm1BY3Rpb24uaHJlZiwgcG9zdFZhbHVlcyk7XG5cbiAgICBpZiAocmVzdWx0UGFnZS5zdGF0dXNDb2RlID09PSAyMDApIHtcbiAgICAgIGNvbnN0IGVycm9yTXNnID0gdGhpcy5wYXJzZXIucmVtb3ZlVGFnc0h0bWwoXG4gICAgICAgIHJlc3VsdFBhZ2UuJCgnLmVycm9zIGxpJykuaHRtbCgpXG4gICAgICApO1xuICAgICAgaWYgKGVycm9yTXNnLmluY2x1ZGVzKCdBIHNlbmhhIGRpZ2l0YWRhIMOpIG11aXRvIHNpbXBsZXMuJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKHRoaXMuZXJyb3JJbnN1ZmZpY2llbnRQYXNzd29yZENvbXBsZXhpdHkpO1xuICAgICAgfVxuICAgICAgaWYgKGVycm9yTXNnLmluY2x1ZGVzKCdTZW5oYSBBdHVhbCBkaWdpdGFkYSBuw6NvIGNvbmZlcmUnKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IodGhpcy5lcnJvckludmFsaWRDcmVkZW50aWFscyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHJlc3VsdFBhZ2Uuc3RhdHVzQ29kZSAhPT0gMzAyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdTSUdBQTogVGhlIGNoYW5nZSBwYXNzd29yZCBwYWdlIHN0YXR1cyBjb2RlIGlzIGRpZmZlcmVudCB0aGFuIGV4cGVjdGVkLidcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG4iXX0=
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SigaaFile = void 0;

require("source-map-support/register");

var _updatableResource = require("./updatable-resource");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Class to manager file
 * @category Internal
 */
class SigaaFile extends _updatableResource.AbstractUpdatableResource {
  /**
   * There are two ways to create the class
   * the first is used the file's id and key
   * the second is used the file form
   *
   * @param options
   * @param sigaaSession
   */
  constructor(http, options, updater) {
    super(options.instanceIndentifier, updater);
    this.http = http;

    _defineProperty(this, "type", 'file');

    _defineProperty(this, "form", void 0);

    _defineProperty(this, "_title", void 0);

    _defineProperty(this, "_key", void 0);

    _defineProperty(this, "_id", void 0);

    _defineProperty(this, "_description", void 0);

    this.update(options);
  }

  update(options) {
    this._title = options.title;
    this._description = options.description;

    if (options.form !== undefined) {
      this.form = options.form;
      this._id = this.form.postValues.id;
      this._key = this.form.postValues.key;
    } else if (options.id !== undefined && options.key !== undefined) {
      this._id = options.id;
      this._key = options.key;
    } else {
      throw new Error('SIGAA: Invalid FileData.');
    }

    this.isClosed = false;
  }

  get title() {
    this.checkIfItWasClosed();
    return this._title;
  }

  get key() {
    this.checkIfItWasClosed();
    return this._key;
  }

  get description() {
    this.checkIfItWasClosed();
    return this._description;
  }

  get id() {
    this.checkIfItWasClosed();
    return this._id;
  }

  async download(basepath, callback, retry = true) {
    this.checkIfItWasClosed();

    if (this.form) {
      return this.http.downloadFileByPost(this.form.action.href, this.form.postValues, basepath, callback).catch(async err => {
        this.form = undefined;
        await this.updateInstance();
        if (retry) return this.download(basepath, callback, false);else throw err;
      });
    } else if (this.key != null) {
      const fileDownloadPath = `/sigaa/verFoto?idArquivo=${this.id}&key=${this.key}`;
      return this.http.downloadFileByGet(fileDownloadPath, basepath, callback).catch(err => {
        if (retry) return this.download(basepath, callback, false);else throw err;
      });
    }

    throw new Error('SIGAA: Could not download the file because the key is missing.');
  }

}

exports.SigaaFile = SigaaFile;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZXNvdXJjZXMvc2lnYWEtZmlsZS50cyJdLCJuYW1lcyI6WyJTaWdhYUZpbGUiLCJBYnN0cmFjdFVwZGF0YWJsZVJlc291cmNlIiwiY29uc3RydWN0b3IiLCJodHRwIiwib3B0aW9ucyIsInVwZGF0ZXIiLCJpbnN0YW5jZUluZGVudGlmaWVyIiwidXBkYXRlIiwiX3RpdGxlIiwidGl0bGUiLCJfZGVzY3JpcHRpb24iLCJkZXNjcmlwdGlvbiIsImZvcm0iLCJ1bmRlZmluZWQiLCJfaWQiLCJwb3N0VmFsdWVzIiwiaWQiLCJfa2V5Iiwia2V5IiwiRXJyb3IiLCJpc0Nsb3NlZCIsImNoZWNrSWZJdFdhc0Nsb3NlZCIsImRvd25sb2FkIiwiYmFzZXBhdGgiLCJjYWxsYmFjayIsInJldHJ5IiwiZG93bmxvYWRGaWxlQnlQb3N0IiwiYWN0aW9uIiwiaHJlZiIsImNhdGNoIiwiZXJyIiwidXBkYXRlSW5zdGFuY2UiLCJmaWxlRG93bmxvYWRQYXRoIiwiZG93bmxvYWRGaWxlQnlHZXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUdBOzs7O0FBeURBO0FBQ0E7QUFDQTtBQUNBO0FBQ08sTUFBTUEsU0FBTixTQUF3QkMsNENBQXhCLENBQWtFO0FBQ3ZFO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDRUMsRUFBQUEsV0FBVyxDQUNEQyxJQURDLEVBRVRDLE9BRlMsRUFHVEMsT0FIUyxFQUlUO0FBQ0EsVUFBTUQsT0FBTyxDQUFDRSxtQkFBZCxFQUFtQ0QsT0FBbkM7QUFEQSxTQUhRRixJQUdSLEdBSFFBLElBR1I7O0FBQUEsa0NBS2MsTUFMZDs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFBQTs7QUFFQSxTQUFLSSxNQUFMLENBQVlILE9BQVo7QUFDRDs7QUFXREcsRUFBQUEsTUFBTSxDQUFDSCxPQUFELEVBQTBCO0FBQzlCLFNBQUtJLE1BQUwsR0FBY0osT0FBTyxDQUFDSyxLQUF0QjtBQUNBLFNBQUtDLFlBQUwsR0FBb0JOLE9BQU8sQ0FBQ08sV0FBNUI7O0FBRUEsUUFBS1AsT0FBRCxDQUEwQlEsSUFBMUIsS0FBbUNDLFNBQXZDLEVBQWtEO0FBQ2hELFdBQUtELElBQUwsR0FBYVIsT0FBRCxDQUEwQlEsSUFBdEM7QUFDQSxXQUFLRSxHQUFMLEdBQVcsS0FBS0YsSUFBTCxDQUFVRyxVQUFWLENBQXFCQyxFQUFoQztBQUNBLFdBQUtDLElBQUwsR0FBWSxLQUFLTCxJQUFMLENBQVVHLFVBQVYsQ0FBcUJHLEdBQWpDO0FBQ0QsS0FKRCxNQUlPLElBQ0pkLE9BQUQsQ0FBeUJZLEVBQXpCLEtBQWdDSCxTQUFoQyxJQUNDVCxPQUFELENBQXlCYyxHQUF6QixLQUFpQ0wsU0FGNUIsRUFHTDtBQUNBLFdBQUtDLEdBQUwsR0FBWVYsT0FBRCxDQUF5QlksRUFBcEM7QUFDQSxXQUFLQyxJQUFMLEdBQWFiLE9BQUQsQ0FBeUJjLEdBQXJDO0FBQ0QsS0FOTSxNQU1BO0FBQ0wsWUFBTSxJQUFJQyxLQUFKLENBQVUsMEJBQVYsQ0FBTjtBQUNEOztBQUNELFNBQUtDLFFBQUwsR0FBZ0IsS0FBaEI7QUFDRDs7QUFFUSxNQUFMWCxLQUFLLEdBQXVCO0FBQzlCLFNBQUtZLGtCQUFMO0FBQ0EsV0FBTyxLQUFLYixNQUFaO0FBQ0Q7O0FBRU0sTUFBSFUsR0FBRyxHQUF1QjtBQUM1QixTQUFLRyxrQkFBTDtBQUNBLFdBQU8sS0FBS0osSUFBWjtBQUNEOztBQUVjLE1BQVhOLFdBQVcsR0FBdUI7QUFDcEMsU0FBS1Usa0JBQUw7QUFDQSxXQUFPLEtBQUtYLFlBQVo7QUFDRDs7QUFFSyxNQUFGTSxFQUFFLEdBQVc7QUFDZixTQUFLSyxrQkFBTDtBQUNBLFdBQU8sS0FBS1AsR0FBWjtBQUNEOztBQUVhLFFBQVJRLFFBQVEsQ0FDWkMsUUFEWSxFQUVaQyxRQUZZLEVBR1pDLEtBQUssR0FBRyxJQUhJLEVBSUs7QUFDakIsU0FBS0osa0JBQUw7O0FBQ0EsUUFBSSxLQUFLVCxJQUFULEVBQWU7QUFDYixhQUFPLEtBQUtULElBQUwsQ0FDSnVCLGtCQURJLENBRUgsS0FBS2QsSUFBTCxDQUFVZSxNQUFWLENBQWlCQyxJQUZkLEVBR0gsS0FBS2hCLElBQUwsQ0FBVUcsVUFIUCxFQUlIUSxRQUpHLEVBS0hDLFFBTEcsRUFPSkssS0FQSSxDQU9FLE1BQU9DLEdBQVAsSUFBZTtBQUNwQixhQUFLbEIsSUFBTCxHQUFZQyxTQUFaO0FBQ0EsY0FBTSxLQUFLa0IsY0FBTCxFQUFOO0FBQ0EsWUFBSU4sS0FBSixFQUFXLE9BQU8sS0FBS0gsUUFBTCxDQUFjQyxRQUFkLEVBQXdCQyxRQUF4QixFQUFrQyxLQUFsQyxDQUFQLENBQVgsS0FDSyxNQUFNTSxHQUFOO0FBQ04sT0FaSSxDQUFQO0FBYUQsS0FkRCxNQWNPLElBQUksS0FBS1osR0FBTCxJQUFZLElBQWhCLEVBQXNCO0FBQzNCLFlBQU1jLGdCQUFnQixHQUFJLDRCQUEyQixLQUFLaEIsRUFBRyxRQUFPLEtBQUtFLEdBQUksRUFBN0U7QUFDQSxhQUFPLEtBQUtmLElBQUwsQ0FDSjhCLGlCQURJLENBQ2NELGdCQURkLEVBQ2dDVCxRQURoQyxFQUMwQ0MsUUFEMUMsRUFFSkssS0FGSSxDQUVHQyxHQUFELElBQVM7QUFDZCxZQUFJTCxLQUFKLEVBQVcsT0FBTyxLQUFLSCxRQUFMLENBQWNDLFFBQWQsRUFBd0JDLFFBQXhCLEVBQWtDLEtBQWxDLENBQVAsQ0FBWCxLQUNLLE1BQU1NLEdBQU47QUFDTixPQUxJLENBQVA7QUFNRDs7QUFDRCxVQUFNLElBQUlYLEtBQUosQ0FDSixnRUFESSxDQUFOO0FBR0Q7O0FBbkdzRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEhUVFAsIFByb2dyZXNzQ2FsbGJhY2sgfSBmcm9tICdAc2Vzc2lvbi9zaWdhYS1odHRwJztcbmltcG9ydCB7IFNpZ2FhRm9ybSB9IGZyb20gJ0BzZXNzaW9uL3NpZ2FhLXBhZ2UnO1xuaW1wb3J0IHsgVXBkYXRhYmxlUmVzb3VyY2VEYXRhIH0gZnJvbSAnLi9zaWdhYS1yZXNvdXJjZS1tYW5hZ2VyJztcbmltcG9ydCB7XG4gIEFic3RyYWN0VXBkYXRhYmxlUmVzb3VyY2UsXG4gIFVwZGF0YWJsZVJlc291cmNlLFxuICBVcGRhdGFibGVSZXNvdXJjZUNhbGxiYWNrXG59IGZyb20gJy4vdXBkYXRhYmxlLXJlc291cmNlJztcblxuLyoqXG4gKiBAY2F0ZWdvcnkgSW50ZXJuYWxcbiAqL1xuaW50ZXJmYWNlIEZpbGVEYXRhS2V5IGV4dGVuZHMgVXBkYXRhYmxlUmVzb3VyY2VEYXRhIHtcbiAgaWQ6IHN0cmluZztcbiAga2V5OiBzdHJpbmc7XG4gIHRpdGxlOiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG59XG5cbi8qKlxuICogQGNhdGVnb3J5IEludGVybmFsXG4gKi9cbmludGVyZmFjZSBGaWxlRGF0YUZvcm0gZXh0ZW5kcyBVcGRhdGFibGVSZXNvdXJjZURhdGEge1xuICBmb3JtOiBTaWdhYUZvcm07XG4gIGlkOiBzdHJpbmc7XG4gIHRpdGxlOiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG59XG5cbi8qKlxuICogQGNhdGVnb3J5IEludGVybmFsXG4gKi9cbmV4cG9ydCB0eXBlIEZpbGVEYXRhID0gRmlsZURhdGFGb3JtIHwgRmlsZURhdGFLZXk7XG5cbi8qKlxuICogQGNhdGVnb3J5IFB1YmxpY1xuICovXG5leHBvcnQgaW50ZXJmYWNlIEZpbGUgZXh0ZW5kcyBVcGRhdGFibGVSZXNvdXJjZTxGaWxlRGF0YT4ge1xuICByZWFkb25seSB0eXBlOiAnZmlsZSc7XG4gIC8qKlxuICAgKiBMYWJlbCBpbiBTSUdBQS5cbiAgICovXG4gIHJlYWRvbmx5IHRpdGxlPzogc3RyaW5nO1xuICAvKipcbiAgICogSXMgYSBrZXkgdG8gZG93bmxvYWQgYSBmaWxlLCB0aGlzIGlzIGEgc2VjdXJpdHkgZmVhdHVyZSBvZiBTSUdBQS5cbiAgICovXG4gIHJlYWRvbmx5IGtleT86IHN0cmluZztcbiAgLyoqXG4gICAqRGVzY3JpcHRpb24gaW4gdGhlIHNpZ2FhXG4gICAqL1xuICByZWFkb25seSBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgLyoqXG4gICAqIERvd25sb2FkIHRoZSBmaWxlXG4gICAqIEBwYXJhbSBkZXN0cGF0aCBwYXRoIHRvIHNhdmUgZmlsZVxuICAgKiBAcGFyYW0gY2FsbGJhY2sgY2FsbGJhY2sgdG8gdmlldyBkb3dubG9hZCBwcm9ncmVzc1xuICAgKiBAcmV0dW5zIFByb21pc2Ugd2l0aCB0aGUgcGF0aCB3aGVyZSB0aGUgZmlsZSB3YXMgc2F2ZWQuXG4gICAqL1xuICBkb3dubG9hZChkZXN0cGF0aDogc3RyaW5nLCBjYWxsYmFjaz86IFByb2dyZXNzQ2FsbGJhY2spOiBQcm9taXNlPHN0cmluZz47XG59XG5cbi8qKlxuICogQ2xhc3MgdG8gbWFuYWdlciBmaWxlXG4gKiBAY2F0ZWdvcnkgSW50ZXJuYWxcbiAqL1xuZXhwb3J0IGNsYXNzIFNpZ2FhRmlsZSBleHRlbmRzIEFic3RyYWN0VXBkYXRhYmxlUmVzb3VyY2UgaW1wbGVtZW50cyBGaWxlIHtcbiAgLyoqXG4gICAqIFRoZXJlIGFyZSB0d28gd2F5cyB0byBjcmVhdGUgdGhlIGNsYXNzXG4gICAqIHRoZSBmaXJzdCBpcyB1c2VkIHRoZSBmaWxlJ3MgaWQgYW5kIGtleVxuICAgKiB0aGUgc2Vjb25kIGlzIHVzZWQgdGhlIGZpbGUgZm9ybVxuICAgKlxuICAgKiBAcGFyYW0gb3B0aW9uc1xuICAgKiBAcGFyYW0gc2lnYWFTZXNzaW9uXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGh0dHA6IEhUVFAsXG4gICAgb3B0aW9uczogRmlsZURhdGEsXG4gICAgdXBkYXRlcj86IFVwZGF0YWJsZVJlc291cmNlQ2FsbGJhY2tcbiAgKSB7XG4gICAgc3VwZXIob3B0aW9ucy5pbnN0YW5jZUluZGVudGlmaWVyLCB1cGRhdGVyKTtcbiAgICB0aGlzLnVwZGF0ZShvcHRpb25zKTtcbiAgfVxuXG4gIHJlYWRvbmx5IHR5cGUgPSAnZmlsZSc7XG5cbiAgcHJpdmF0ZSBmb3JtPzogU2lnYWFGb3JtO1xuXG4gIHByaXZhdGUgX3RpdGxlPzogc3RyaW5nO1xuICBwcml2YXRlIF9rZXk/OiBzdHJpbmc7XG4gIHByaXZhdGUgX2lkITogc3RyaW5nO1xuICBwcml2YXRlIF9kZXNjcmlwdGlvbj86IHN0cmluZztcblxuICB1cGRhdGUob3B0aW9uczogRmlsZURhdGEpOiB2b2lkIHtcbiAgICB0aGlzLl90aXRsZSA9IG9wdGlvbnMudGl0bGU7XG4gICAgdGhpcy5fZGVzY3JpcHRpb24gPSBvcHRpb25zLmRlc2NyaXB0aW9uO1xuXG4gICAgaWYgKChvcHRpb25zIGFzIEZpbGVEYXRhRm9ybSkuZm9ybSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLmZvcm0gPSAob3B0aW9ucyBhcyBGaWxlRGF0YUZvcm0pLmZvcm07XG4gICAgICB0aGlzLl9pZCA9IHRoaXMuZm9ybS5wb3N0VmFsdWVzLmlkO1xuICAgICAgdGhpcy5fa2V5ID0gdGhpcy5mb3JtLnBvc3RWYWx1ZXMua2V5O1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICAob3B0aW9ucyBhcyBGaWxlRGF0YUtleSkuaWQgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgKG9wdGlvbnMgYXMgRmlsZURhdGFLZXkpLmtleSAhPT0gdW5kZWZpbmVkXG4gICAgKSB7XG4gICAgICB0aGlzLl9pZCA9IChvcHRpb25zIGFzIEZpbGVEYXRhS2V5KS5pZDtcbiAgICAgIHRoaXMuX2tleSA9IChvcHRpb25zIGFzIEZpbGVEYXRhS2V5KS5rZXk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignU0lHQUE6IEludmFsaWQgRmlsZURhdGEuJyk7XG4gICAgfVxuICAgIHRoaXMuaXNDbG9zZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGdldCB0aXRsZSgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIHRoaXMuY2hlY2tJZkl0V2FzQ2xvc2VkKCk7XG4gICAgcmV0dXJuIHRoaXMuX3RpdGxlO1xuICB9XG5cbiAgZ2V0IGtleSgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIHRoaXMuY2hlY2tJZkl0V2FzQ2xvc2VkKCk7XG4gICAgcmV0dXJuIHRoaXMuX2tleTtcbiAgfVxuXG4gIGdldCBkZXNjcmlwdGlvbigpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIHRoaXMuY2hlY2tJZkl0V2FzQ2xvc2VkKCk7XG4gICAgcmV0dXJuIHRoaXMuX2Rlc2NyaXB0aW9uO1xuICB9XG5cbiAgZ2V0IGlkKCk6IHN0cmluZyB7XG4gICAgdGhpcy5jaGVja0lmSXRXYXNDbG9zZWQoKTtcbiAgICByZXR1cm4gdGhpcy5faWQ7XG4gIH1cblxuICBhc3luYyBkb3dubG9hZChcbiAgICBiYXNlcGF0aDogc3RyaW5nLFxuICAgIGNhbGxiYWNrPzogUHJvZ3Jlc3NDYWxsYmFjayxcbiAgICByZXRyeSA9IHRydWVcbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICB0aGlzLmNoZWNrSWZJdFdhc0Nsb3NlZCgpO1xuICAgIGlmICh0aGlzLmZvcm0pIHtcbiAgICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgICAgLmRvd25sb2FkRmlsZUJ5UG9zdChcbiAgICAgICAgICB0aGlzLmZvcm0uYWN0aW9uLmhyZWYsXG4gICAgICAgICAgdGhpcy5mb3JtLnBvc3RWYWx1ZXMsXG4gICAgICAgICAgYmFzZXBhdGgsXG4gICAgICAgICAgY2FsbGJhY2tcbiAgICAgICAgKVxuICAgICAgICAuY2F0Y2goYXN5bmMgKGVycikgPT4ge1xuICAgICAgICAgIHRoaXMuZm9ybSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluc3RhbmNlKCk7XG4gICAgICAgICAgaWYgKHJldHJ5KSByZXR1cm4gdGhpcy5kb3dubG9hZChiYXNlcGF0aCwgY2FsbGJhY2ssIGZhbHNlKTtcbiAgICAgICAgICBlbHNlIHRocm93IGVycjtcbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIGlmICh0aGlzLmtleSAhPSBudWxsKSB7XG4gICAgICBjb25zdCBmaWxlRG93bmxvYWRQYXRoID0gYC9zaWdhYS92ZXJGb3RvP2lkQXJxdWl2bz0ke3RoaXMuaWR9JmtleT0ke3RoaXMua2V5fWA7XG4gICAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAgIC5kb3dubG9hZEZpbGVCeUdldChmaWxlRG93bmxvYWRQYXRoLCBiYXNlcGF0aCwgY2FsbGJhY2spXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgaWYgKHJldHJ5KSByZXR1cm4gdGhpcy5kb3dubG9hZChiYXNlcGF0aCwgY2FsbGJhY2ssIGZhbHNlKTtcbiAgICAgICAgICBlbHNlIHRocm93IGVycjtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICdTSUdBQTogQ291bGQgbm90IGRvd25sb2FkIHRoZSBmaWxlIGJlY2F1c2UgdGhlIGtleSBpcyBtaXNzaW5nLidcbiAgICApO1xuICB9XG59XG4iXX0=
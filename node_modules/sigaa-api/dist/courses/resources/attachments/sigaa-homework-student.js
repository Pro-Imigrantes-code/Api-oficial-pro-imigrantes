"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SigaaHomework = void 0;

require("source-map-support/register");

var _url = require("url");

var _updatableResource = require("../../../resources/updatable-resource");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * @category Internal
 */
class SigaaHomework extends _updatableResource.AbstractUpdatableResource {
  constructor(http, courseResourcesFactory, options, updater) {
    super(options.instanceIndentifier, updater);
    this.http = http;
    this.courseResourcesFactory = courseResourcesFactory;

    _defineProperty(this, "type", 'homework');

    _defineProperty(this, "_title", void 0);

    _defineProperty(this, "_startDate", void 0);

    _defineProperty(this, "_endDate", void 0);

    _defineProperty(this, "_id", void 0);

    _defineProperty(this, "_formSendHomework", void 0);

    _defineProperty(this, "_formViewHomeworkSubmitted", void 0);

    _defineProperty(this, "_description", void 0);

    _defineProperty(this, "_haveGrade", void 0);

    _defineProperty(this, "_isGroupHomework", void 0);

    _defineProperty(this, "_file", void 0);

    this.update(options);
  }

  update(options) {
    this._title = options.title;
    this._startDate = options.startDate;
    this._endDate = options.endDate;
    this._id = options.id;
    this._formSendHomework = options.formSendHomework;
    this._formViewHomeworkSubmitted = options.formViewHomeworkSubmitted;
    this._description = options.description;
    this._haveGrade = options.haveGrade;
    this._isGroupHomework = options.isGroupHomework;
    this.isClosed = false;
  }

  get title() {
    this.checkIfItWasClosed();
    return this._title;
  }

  get id() {
    this.checkIfItWasClosed();
    return this._id || null;
  }

  async getFlagHaveGrade() {
    if (this._haveGrade === undefined) {
      await this.updateInstance();
    }

    this.checkIfItWasClosed();
    if (this._haveGrade === undefined) throw new Error('SIGAA: Homework have grade could not be loaded.');
    return this._haveGrade;
  }

  async getFlagIsGroupHomework() {
    if (this._isGroupHomework === undefined) {
      await this.updateInstance();
    }

    this.checkIfItWasClosed();
    if (this._isGroupHomework === undefined) throw new Error('SIGAA: Homework group flag could not be loaded.');
    return this._isGroupHomework;
  }

  async getDescription() {
    if (!this._description) {
      await this.updateInstance();
    }

    this.checkIfItWasClosed();
    if (!this._description) throw new Error('SIGAA: Homework description could not be loaded.');
    return this._description;
  }

  get endDate() {
    this.checkIfItWasClosed();
    return this._endDate;
  }

  get startDate() {
    this.checkIfItWasClosed();
    return this._startDate;
  }
  /**
   * @inheritdoc
   */


  async getAttachmentFile() {
    if (this._formSendHomework === undefined && this._formViewHomeworkSubmitted === undefined) await this.updateInstance();
    if (!this._formSendHomework) throw new Error('SIGAA: Homework has been submitted.');
    const page = await this.http.post(this._formSendHomework.action.href, this._formSendHomework.postValues);
    const path = page.$('ul.form > li > div > a').attr('href');
    if (!path) throw new Error('SIGAA: Homework has no file.');
    const url = new _url.URL(path, page.url);
    const fileKey = url.searchParams.get('key');
    const fileId = url.searchParams.get('idArquivo');
    if (fileId == null || fileKey == null) throw new Error('SIGAA: File URL is invalid.');
    const file = {
      title: '',
      description: '',
      key: fileKey,
      id: fileId,
      instanceIndentifier: fileId
    };

    if (!this._file) {
      this._file = this.courseResourcesFactory.createFileFromFileData(file, this.http, async () => {
        throw new Error('SIGAA: Invalid file in Homework.');
      });
    } else {
      this._file.update(file);
    }

    return this._file;
  }

}

exports.SigaaHomework = SigaaHomework;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb3Vyc2VzL3Jlc291cmNlcy9hdHRhY2htZW50cy9zaWdhYS1ob21ld29yay1zdHVkZW50LnRzIl0sIm5hbWVzIjpbIlNpZ2FhSG9tZXdvcmsiLCJBYnN0cmFjdFVwZGF0YWJsZVJlc291cmNlIiwiY29uc3RydWN0b3IiLCJodHRwIiwiY291cnNlUmVzb3VyY2VzRmFjdG9yeSIsIm9wdGlvbnMiLCJ1cGRhdGVyIiwiaW5zdGFuY2VJbmRlbnRpZmllciIsInVwZGF0ZSIsIl90aXRsZSIsInRpdGxlIiwiX3N0YXJ0RGF0ZSIsInN0YXJ0RGF0ZSIsIl9lbmREYXRlIiwiZW5kRGF0ZSIsIl9pZCIsImlkIiwiX2Zvcm1TZW5kSG9tZXdvcmsiLCJmb3JtU2VuZEhvbWV3b3JrIiwiX2Zvcm1WaWV3SG9tZXdvcmtTdWJtaXR0ZWQiLCJmb3JtVmlld0hvbWV3b3JrU3VibWl0dGVkIiwiX2Rlc2NyaXB0aW9uIiwiZGVzY3JpcHRpb24iLCJfaGF2ZUdyYWRlIiwiaGF2ZUdyYWRlIiwiX2lzR3JvdXBIb21ld29yayIsImlzR3JvdXBIb21ld29yayIsImlzQ2xvc2VkIiwiY2hlY2tJZkl0V2FzQ2xvc2VkIiwiZ2V0RmxhZ0hhdmVHcmFkZSIsInVuZGVmaW5lZCIsInVwZGF0ZUluc3RhbmNlIiwiRXJyb3IiLCJnZXRGbGFnSXNHcm91cEhvbWV3b3JrIiwiZ2V0RGVzY3JpcHRpb24iLCJnZXRBdHRhY2htZW50RmlsZSIsInBhZ2UiLCJwb3N0IiwiYWN0aW9uIiwiaHJlZiIsInBvc3RWYWx1ZXMiLCJwYXRoIiwiJCIsImF0dHIiLCJ1cmwiLCJVUkwiLCJmaWxlS2V5Iiwic2VhcmNoUGFyYW1zIiwiZ2V0IiwiZmlsZUlkIiwiZmlsZSIsImtleSIsIl9maWxlIiwiY3JlYXRlRmlsZUZyb21GaWxlRGF0YSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBT0E7Ozs7QUF3Q0E7QUFDQTtBQUNBO0FBQ08sTUFBTUEsYUFBTixTQUNHQyw0Q0FESCxD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QUFNLElBQUk2QixLQUFKLENBQVUsa0NBQVYsQ0FBTjtBQUNELE9BTFUsQ0FBYjtBQU9ELEtBUkQsTUFRTztBQUNMLFdBQUtvQixLQUFMLENBQVc1QyxNQUFYLENBQWtCMEMsSUFBbEI7QUFDRDs7QUFDRCxXQUFPLEtBQUtFLEtBQVo7QUFDRDs7QUF4SUgiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBVUkwgfSBmcm9tICd1cmwnO1xuaW1wb3J0IHsgRmlsZURhdGEgfSBmcm9tICdAcmVzb3VyY2VzL3NpZ2FhLWZpbGUnO1xuaW1wb3J0IHsgSFRUUCB9IGZyb20gJ0BzZXNzaW9uL3NpZ2FhLWh0dHAnO1xuaW1wb3J0IHsgU2lnYWFGb3JtIH0gZnJvbSAnQHNlc3Npb24vc2lnYWEtcGFnZSc7XG5pbXBvcnQgeyBGaWxlIH0gZnJvbSAnQHJlc291cmNlcy9zaWdhYS1maWxlJztcbmltcG9ydCB7IENvdXJzZVJlc291cmNlc0ZhY3RvcnkgfSBmcm9tICdAY291cnNlcy9zaWdhYS1jb3Vyc2UtcmVzb3VyY2VzLWZhY3RvcnknO1xuXG5pbXBvcnQge1xuICBBYnN0cmFjdFVwZGF0YWJsZVJlc291cmNlLFxuICBVcGRhdGFibGVSZXNvdXJjZSxcbiAgVXBkYXRhYmxlUmVzb3VyY2VDYWxsYmFja1xufSBmcm9tICdAcmVzb3VyY2VzL3VwZGF0YWJsZS1yZXNvdXJjZSc7XG5pbXBvcnQgeyBVcGRhdGFibGVSZXNvdXJjZURhdGEgfSBmcm9tICdAcmVzb3VyY2VzL3NpZ2FhLXJlc291cmNlLW1hbmFnZXInO1xuXG4vKipcbiAqIEBjYXRlZ29yeSBJbnRlcm5hbFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEhvbWV3b3JrRGF0YSBleHRlbmRzIFVwZGF0YWJsZVJlc291cmNlRGF0YSB7XG4gIHRpdGxlOiBzdHJpbmc7XG4gIHN0YXJ0RGF0ZTogRGF0ZTtcbiAgZW5kRGF0ZTogRGF0ZTtcbiAgaWQ/OiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICBoYXZlR3JhZGU/OiBib29sZWFuO1xuICBpc0dyb3VwSG9tZXdvcms/OiBib29sZWFuO1xuICBmb3JtU2VuZEhvbWV3b3JrPzogU2lnYWFGb3JtO1xuICBmb3JtVmlld0hvbWV3b3JrU3VibWl0dGVkPzogU2lnYWFGb3JtO1xufVxuXG4vKipcbiAqIEBjYXRlZ29yeSBJbnRlcm5hbFxuICovXG5leHBvcnQgaW50ZXJmYWNlIEhvbWV3b3JrIGV4dGVuZHMgVXBkYXRhYmxlUmVzb3VyY2U8SG9tZXdvcmtEYXRhPiB7XG4gIHJlYWRvbmx5IHR5cGU6ICdob21ld29yayc7XG4gIHJlYWRvbmx5IHRpdGxlOiBzdHJpbmc7XG4gIHJlYWRvbmx5IGlkOiBzdHJpbmcgfCBudWxsO1xuICBnZXRGbGFnSGF2ZUdyYWRlKCk6IFByb21pc2U8Ym9vbGVhbj47XG4gIGdldEZsYWdJc0dyb3VwSG9tZXdvcmsoKTogUHJvbWlzZTxib29sZWFuPjtcblxuICByZWFkb25seSBzdGFydERhdGU6IERhdGU7XG4gIHJlYWRvbmx5IGVuZERhdGU6IERhdGU7XG4gIC8qKlxuICAgKiBHZXQgYXR0YWNobWVudCBmaWxlLlxuICAgKi9cbiAgZ2V0QXR0YWNobWVudEZpbGUoKTogUHJvbWlzZTxGaWxlPjtcbn1cblxuLyoqXG4gKiBAY2F0ZWdvcnkgSW50ZXJuYWxcbiAqL1xuZXhwb3J0IGNsYXNzIFNpZ2FhSG9tZXdvcmtcbiAgZXh0ZW5kcyBBYnN0cmFjdFVwZGF0YWJsZVJlc291cmNlXG4gIGltcGxlbWVudHMgSG9tZXdvcmtcbntcbiAgcmVhZG9ubHkgdHlwZSA9ICdob21ld29yayc7XG5cbiAgcHJpdmF0ZSBfdGl0bGUhOiBzdHJpbmc7XG4gIHByaXZhdGUgX3N0YXJ0RGF0ZSE6IERhdGU7XG4gIHByaXZhdGUgX2VuZERhdGUhOiBEYXRlO1xuICBwcml2YXRlIF9pZD86IHN0cmluZztcbiAgcHJpdmF0ZSBfZm9ybVNlbmRIb21ld29yaz86IFNpZ2FhRm9ybTtcbiAgcHJpdmF0ZSBfZm9ybVZpZXdIb21ld29ya1N1Ym1pdHRlZD86IFNpZ2FhRm9ybTtcbiAgcHJpdmF0ZSBfZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gIHByaXZhdGUgX2hhdmVHcmFkZT86IGJvb2xlYW47XG4gIHByaXZhdGUgX2lzR3JvdXBIb21ld29yaz86IGJvb2xlYW47XG4gIHByaXZhdGUgX2ZpbGU/OiBGaWxlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaHR0cDogSFRUUCxcbiAgICBwcml2YXRlIGNvdXJzZVJlc291cmNlc0ZhY3Rvcnk6IENvdXJzZVJlc291cmNlc0ZhY3RvcnksXG4gICAgb3B0aW9uczogSG9tZXdvcmtEYXRhLFxuICAgIHVwZGF0ZXI6IFVwZGF0YWJsZVJlc291cmNlQ2FsbGJhY2tcbiAgKSB7XG4gICAgc3VwZXIob3B0aW9ucy5pbnN0YW5jZUluZGVudGlmaWVyLCB1cGRhdGVyKTtcbiAgICB0aGlzLnVwZGF0ZShvcHRpb25zKTtcbiAgfVxuXG4gIHVwZGF0ZShvcHRpb25zOiBIb21ld29ya0RhdGEpOiB2b2lkIHtcbiAgICB0aGlzLl90aXRsZSA9IG9wdGlvbnMudGl0bGU7XG4gICAgdGhpcy5fc3RhcnREYXRlID0gb3B0aW9ucy5zdGFydERhdGU7XG4gICAgdGhpcy5fZW5kRGF0ZSA9IG9wdGlvbnMuZW5kRGF0ZTtcbiAgICB0aGlzLl9pZCA9IG9wdGlvbnMuaWQ7XG5cbiAgICB0aGlzLl9mb3JtU2VuZEhvbWV3b3JrID0gb3B0aW9ucy5mb3JtU2VuZEhvbWV3b3JrO1xuICAgIHRoaXMuX2Zvcm1WaWV3SG9tZXdvcmtTdWJtaXR0ZWQgPSBvcHRpb25zLmZvcm1WaWV3SG9tZXdvcmtTdWJtaXR0ZWQ7XG4gICAgdGhpcy5fZGVzY3JpcHRpb24gPSBvcHRpb25zLmRlc2NyaXB0aW9uO1xuICAgIHRoaXMuX2hhdmVHcmFkZSA9IG9wdGlvbnMuaGF2ZUdyYWRlO1xuICAgIHRoaXMuX2lzR3JvdXBIb21ld29yayA9IG9wdGlvbnMuaXNHcm91cEhvbWV3b3JrO1xuXG4gICAgdGhpcy5pc0Nsb3NlZCA9IGZhbHNlO1xuICB9XG5cbiAgZ2V0IHRpdGxlKCk6IHN0cmluZyB7XG4gICAgdGhpcy5jaGVja0lmSXRXYXNDbG9zZWQoKTtcbiAgICByZXR1cm4gdGhpcy5fdGl0bGU7XG4gIH1cblxuICBnZXQgaWQoKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgdGhpcy5jaGVja0lmSXRXYXNDbG9zZWQoKTtcbiAgICByZXR1cm4gdGhpcy5faWQgfHwgbnVsbDtcbiAgfVxuXG4gIGFzeW5jIGdldEZsYWdIYXZlR3JhZGUoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKHRoaXMuX2hhdmVHcmFkZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluc3RhbmNlKCk7XG4gICAgfVxuICAgIHRoaXMuY2hlY2tJZkl0V2FzQ2xvc2VkKCk7XG4gICAgaWYgKHRoaXMuX2hhdmVHcmFkZSA9PT0gdW5kZWZpbmVkKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogSG9tZXdvcmsgaGF2ZSBncmFkZSBjb3VsZCBub3QgYmUgbG9hZGVkLicpO1xuXG4gICAgcmV0dXJuIHRoaXMuX2hhdmVHcmFkZTtcbiAgfVxuXG4gIGFzeW5jIGdldEZsYWdJc0dyb3VwSG9tZXdvcmsoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKHRoaXMuX2lzR3JvdXBIb21ld29yayA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluc3RhbmNlKCk7XG4gICAgfVxuICAgIHRoaXMuY2hlY2tJZkl0V2FzQ2xvc2VkKCk7XG5cbiAgICBpZiAodGhpcy5faXNHcm91cEhvbWV3b3JrID09PSB1bmRlZmluZWQpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBIb21ld29yayBncm91cCBmbGFnIGNvdWxkIG5vdCBiZSBsb2FkZWQuJyk7XG5cbiAgICByZXR1cm4gdGhpcy5faXNHcm91cEhvbWV3b3JrO1xuICB9XG5cbiAgYXN5bmMgZ2V0RGVzY3JpcHRpb24oKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBpZiAoIXRoaXMuX2Rlc2NyaXB0aW9uKSB7XG4gICAgICBhd2FpdCB0aGlzLnVwZGF0ZUluc3RhbmNlKCk7XG4gICAgfVxuICAgIHRoaXMuY2hlY2tJZkl0V2FzQ2xvc2VkKCk7XG4gICAgaWYgKCF0aGlzLl9kZXNjcmlwdGlvbilcbiAgICAgIHRocm93IG5ldyBFcnJvcignU0lHQUE6IEhvbWV3b3JrIGRlc2NyaXB0aW9uIGNvdWxkIG5vdCBiZSBsb2FkZWQuJyk7XG4gICAgcmV0dXJuIHRoaXMuX2Rlc2NyaXB0aW9uO1xuICB9XG5cbiAgZ2V0IGVuZERhdGUoKTogRGF0ZSB7XG4gICAgdGhpcy5jaGVja0lmSXRXYXNDbG9zZWQoKTtcbiAgICByZXR1cm4gdGhpcy5fZW5kRGF0ZTtcbiAgfVxuXG4gIGdldCBzdGFydERhdGUoKTogRGF0ZSB7XG4gICAgdGhpcy5jaGVja0lmSXRXYXNDbG9zZWQoKTtcbiAgICByZXR1cm4gdGhpcy5fc3RhcnREYXRlO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqL1xuICBhc3luYyBnZXRBdHRhY2htZW50RmlsZSgpOiBQcm9taXNlPEZpbGU+IHtcbiAgICBpZiAoXG4gICAgICB0aGlzLl9mb3JtU2VuZEhvbWV3b3JrID09PSB1bmRlZmluZWQgJiZcbiAgICAgIHRoaXMuX2Zvcm1WaWV3SG9tZXdvcmtTdWJtaXR0ZWQgPT09IHVuZGVmaW5lZFxuICAgIClcbiAgICAgIGF3YWl0IHRoaXMudXBkYXRlSW5zdGFuY2UoKTtcbiAgICBpZiAoIXRoaXMuX2Zvcm1TZW5kSG9tZXdvcmspXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NJR0FBOiBIb21ld29yayBoYXMgYmVlbiBzdWJtaXR0ZWQuJyk7XG4gICAgY29uc3QgcGFnZSA9IGF3YWl0IHRoaXMuaHR0cC5wb3N0KFxuICAgICAgdGhpcy5fZm9ybVNlbmRIb21ld29yay5hY3Rpb24uaHJlZixcbiAgICAgIHRoaXMuX2Zvcm1TZW5kSG9tZXdvcmsucG9zdFZhbHVlc1xuICAgICk7XG5cbiAgICBjb25zdCBwYXRoID0gcGFnZS4kKCd1bC5mb3JtID4gbGkgPiBkaXYgPiBhJykuYXR0cignaHJlZicpO1xuICAgIGlmICghcGF0aCkgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogSG9tZXdvcmsgaGFzIG5vIGZpbGUuJyk7XG4gICAgY29uc3QgdXJsID0gbmV3IFVSTChwYXRoLCBwYWdlLnVybCk7XG4gICAgY29uc3QgZmlsZUtleSA9IHVybC5zZWFyY2hQYXJhbXMuZ2V0KCdrZXknKTtcbiAgICBjb25zdCBmaWxlSWQgPSB1cmwuc2VhcmNoUGFyYW1zLmdldCgnaWRBcnF1aXZvJyk7XG4gICAgaWYgKGZpbGVJZCA9PSBudWxsIHx8IGZpbGVLZXkgPT0gbnVsbClcbiAgICAgIHRocm93IG5ldyBFcnJvcignU0lHQUE6IEZpbGUgVVJMIGlzIGludmFsaWQuJyk7XG5cbiAgICBjb25zdCBmaWxlOiBGaWxlRGF0YSA9IHtcbiAgICAgIHRpdGxlOiAnJyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnJyxcbiAgICAgIGtleTogZmlsZUtleSxcbiAgICAgIGlkOiBmaWxlSWQsXG4gICAgICBpbnN0YW5jZUluZGVudGlmaWVyOiBmaWxlSWRcbiAgICB9O1xuXG4gICAgaWYgKCF0aGlzLl9maWxlKSB7XG4gICAgICB0aGlzLl9maWxlID0gdGhpcy5jb3Vyc2VSZXNvdXJjZXNGYWN0b3J5LmNyZWF0ZUZpbGVGcm9tRmlsZURhdGEoXG4gICAgICAgIGZpbGUsXG4gICAgICAgIHRoaXMuaHR0cCxcbiAgICAgICAgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignU0lHQUE6IEludmFsaWQgZmlsZSBpbiBIb21ld29yay4nKTtcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fZmlsZS51cGRhdGUoZmlsZSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9maWxlO1xuICB9XG59XG4iXX0=
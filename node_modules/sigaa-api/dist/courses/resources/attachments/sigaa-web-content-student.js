"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SigaaWebContent = void 0;

require("source-map-support/register");

var _updatableResource = require("../../../resources/updatable-resource");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * @category Internal
 */
class SigaaWebContent extends _updatableResource.AbstractUpdatableResource {
  constructor(http, parser, options, updater) {
    super(options.instanceIndentifier, updater);
    this.http = http;
    this.parser = parser;

    _defineProperty(this, "type", 'webcontent');

    _defineProperty(this, "_title", void 0);

    _defineProperty(this, "form", void 0);

    _defineProperty(this, "_content", void 0);

    _defineProperty(this, "_date", void 0);

    this.update(options);
  }

  update(options) {
    this._title = options.title;
    if (options.date) this._date = options.date;
    this.form = options.form;
    this.isClosed = false;
  }

  async getDate() {
    if (!this._date) {
      await this.loadWebContentPage();
    }

    return this._date;
  }

  get title() {
    this.checkIfItWasClosed();
    return this._title;
  }

  async getContent() {
    if (!this._content) {
      await this.loadWebContentPage();
    }

    return this._content;
  }

  async loadWebContentPage(retry = true) {
    this.checkIfItWasClosed();

    try {
      const page = await this.http.post(this.form.action.href, this.form.postValues);

      if (page.statusCode === 200) {
        const rows = page.$('table.formAva tr').toArray();

        for (const row of rows) {
          const rowLabel = this.parser.removeTagsHtml(page.$(row).find('th').html());
          const rowContent = this.parser.removeTagsHtml(page.$(row).find('td').html());

          switch (rowLabel) {
            case 'Título:':
              {
                this._title = rowContent;
                break;
              }

            case 'Conteúdo:':
              {
                this._content = rowContent;
                break;
              }

            case 'Data Cadastro:':
              {
                const date = this.parser.parseDates(rowContent, 1);
                this._date = date[0];
                break;
              }
          }
        }
      } else if (page.statusCode === 302) {
        throw new Error('SIGAA: Webcontent expired.');
      } else {
        throw new Error('SIGAA: Unexpected webcontent page status code.');
      }
    } catch (err) {
      if (retry) {
        await this.updateInstance();
        return this.loadWebContentPage(false);
      } else {
        throw err;
      }
    }
  }

  get id() {
    this.checkIfItWasClosed();
    return this.form.postValues.id;
  }

}

exports.SigaaWebContent = SigaaWebContent;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb3Vyc2VzL3Jlc291cmNlcy9hdHRhY2htZW50cy9zaWdhYS13ZWItY29udGVudC1zdHVkZW50LnRzIl0sIm5hbWVzIjpbIlNpZ2FhV2ViQ29udGVudCIsIkFic3RyYWN0VXBkYXRhYmxlUmVzb3VyY2UiLCJjb25zdHJ1Y3RvciIsImh0dHAiLCJwYXJzZXIiLCJvcHRpb25zIiwidXBkYXRlciIsImluc3RhbmNlSW5kZW50aWZpZXIiLCJ1cGRhdGUiLCJfdGl0bGUiLCJ0aXRsZSIsImRhdGUiLCJfZGF0ZSIsImZvcm0iLCJpc0Nsb3NlZCIsImdldERhdGUiLCJsb2FkV2ViQ29udGVudFBhZ2UiLCJjaGVja0lmSXRXYXNDbG9zZWQiLCJnZXRDb250ZW50IiwiX2NvbnRlbnQiLCJyZXRyeSIsInBhZ2UiLCJwb3N0IiwiYWN0aW9uIiwiaHJlZiIsInBvc3RWYWx1ZXMiLCJzdGF0dXNDb2RlIiwicm93cyIsIiQiLCJ0b0FycmF5Iiwicm93Iiwicm93TGFiZWwiLCJyZW1vdmVUYWdzSHRtbCIsImZpbmQiLCJodG1sIiwicm93Q29udGVudCIsInBhcnNlRGF0ZXMiLCJFcnJvciIsImVyciIsInVwZGF0ZUluc3RhbmNlIiwiaWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUtBOzs7O0FBMEJBO0FBQ0E7QUFDQTtBQUNPLE1BQU1BLGVBQU4sU0FDR0MsNENBREgsQ0FHUDtBQVFFQyxFQUFBQSxXQUFXLENBQ0RDLElBREMsRUFFREMsTUFGQyxFQUdUQyxPQUhTLEVBSVRDLE9BSlMsRUFLVDtBQUNBLFVBQU1ELE9BQU8sQ0FBQ0UsbUJBQWQsRUFBbUNELE9BQW5DO0FBREEsU0FKUUgsSUFJUixHQUpRQSxJQUlSO0FBQUEsU0FIUUMsTUFHUixHQUhRQSxNQUdSOztBQUFBLGtDQVpjLFlBWWQ7O0FBQUE7O0FBQUE7O0FBQUE7O0FBQUE7O0FBRUEsU0FBS0ksTUFBTCxDQUFZSCxPQUFaO0FBQ0Q7O0FBRURHLEVBQUFBLE1BQU0sQ0FBQ0gsT0FB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VixDQUFxQmUsRUFBNUI7QUFDRDs7QUFoR0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYXJzZXIgfSBmcm9tICdAaGVscGVycy9zaWdhYS1wYXJzZXInO1xuaW1wb3J0IHsgVXBkYXRhYmxlUmVzb3VyY2VEYXRhIH0gZnJvbSAnQHJlc291cmNlcy9zaWdhYS1yZXNvdXJjZS1tYW5hZ2VyJztcbmltcG9ydCB7IEhUVFAgfSBmcm9tICdAc2Vzc2lvbi9zaWdhYS1odHRwJztcbmltcG9ydCB7IFNpZ2FhRm9ybSB9IGZyb20gJ0BzZXNzaW9uL3NpZ2FhLXBhZ2UnO1xuXG5pbXBvcnQge1xuICBBYnN0cmFjdFVwZGF0YWJsZVJlc291cmNlLFxuICBVcGRhdGFibGVSZXNvdXJjZSxcbiAgVXBkYXRhYmxlUmVzb3VyY2VDYWxsYmFja1xufSBmcm9tICdAcmVzb3VyY2VzL3VwZGF0YWJsZS1yZXNvdXJjZSc7XG5cbi8qKlxuICogQGNhdGVnb3J5IEludGVybmFsXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgV2ViQ29udGVudERhdGEgZXh0ZW5kcyBVcGRhdGFibGVSZXNvdXJjZURhdGEge1xuICB0aXRsZTogc3RyaW5nO1xuICBpZDogc3RyaW5nO1xuICBmb3JtOiBTaWdhYUZvcm07XG4gIGRhdGU/OiBEYXRlO1xufVxuXG4vKipcbiAqIEBjYXRlZ29yeSBJbnRlcm5hbFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFdlYkNvbnRlbnQgZXh0ZW5kcyBVcGRhdGFibGVSZXNvdXJjZTxXZWJDb250ZW50RGF0YT4ge1xuICByZWFkb25seSB0eXBlOiAnd2ViY29udGVudCc7XG5cbiAgZ2V0RGF0ZSgpOiBQcm9taXNlPERhdGU+O1xuICBnZXRDb250ZW50KCk6IFByb21pc2U8c3RyaW5nPjtcbiAgcmVhZG9ubHkgdGl0bGU6IHN0cmluZztcbn1cbi8qKlxuICogQGNhdGVnb3J5IEludGVybmFsXG4gKi9cbmV4cG9ydCBjbGFzcyBTaWdhYVdlYkNvbnRlbnRcbiAgZXh0ZW5kcyBBYnN0cmFjdFVwZGF0YWJsZVJlc291cmNlXG4gIGltcGxlbWVudHMgV2ViQ29udGVudFxue1xuICByZWFkb25seSB0eXBlID0gJ3dlYmNvbnRlbnQnO1xuXG4gIHByaXZhdGUgX3RpdGxlITogc3RyaW5nO1xuICBwcml2YXRlIGZvcm0hOiBTaWdhYUZvcm07XG4gIHByaXZhdGUgX2NvbnRlbnQhOiBzdHJpbmc7XG4gIHByaXZhdGUgX2RhdGUhOiBEYXRlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaHR0cDogSFRUUCxcbiAgICBwcml2YXRlIHBhcnNlcjogUGFyc2VyLFxuICAgIG9wdGlvbnM6IFdlYkNvbnRlbnREYXRhLFxuICAgIHVwZGF0ZXI6IFVwZGF0YWJsZVJlc291cmNlQ2FsbGJhY2tcbiAgKSB7XG4gICAgc3VwZXIob3B0aW9ucy5pbnN0YW5jZUluZGVudGlmaWVyLCB1cGRhdGVyKTtcbiAgICB0aGlzLnVwZGF0ZShvcHRpb25zKTtcbiAgfVxuXG4gIHVwZGF0ZShvcHRpb25zOiBXZWJDb250ZW50RGF0YSk6IHZvaWQge1xuICAgIHRoaXMuX3RpdGxlID0gb3B0aW9ucy50aXRsZTtcbiAgICBpZiAob3B0aW9ucy5kYXRlKSB0aGlzLl9kYXRlID0gb3B0aW9ucy5kYXRlO1xuICAgIHRoaXMuZm9ybSA9IG9wdGlvbnMuZm9ybTtcbiAgICB0aGlzLmlzQ2xvc2VkID0gZmFsc2U7XG4gIH1cblxuICBhc3luYyBnZXREYXRlKCk6IFByb21pc2U8RGF0ZT4ge1xuICAgIGlmICghdGhpcy5fZGF0ZSkge1xuICAgICAgYXdhaXQgdGhpcy5sb2FkV2ViQ29udGVudFBhZ2UoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2RhdGU7XG4gIH1cblxuICBnZXQgdGl0bGUoKTogc3RyaW5nIHtcbiAgICB0aGlzLmNoZWNrSWZJdFdhc0Nsb3NlZCgpO1xuICAgIHJldHVybiB0aGlzLl90aXRsZTtcbiAgfVxuXG4gIGFzeW5jIGdldENvbnRlbnQoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBpZiAoIXRoaXMuX2NvbnRlbnQpIHtcbiAgICAgIGF3YWl0IHRoaXMubG9hZFdlYkNvbnRlbnRQYWdlKCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9jb250ZW50O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkV2ViQ29udGVudFBhZ2UocmV0cnkgPSB0cnVlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5jaGVja0lmSXRXYXNDbG9zZWQoKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcGFnZSA9IGF3YWl0IHRoaXMuaHR0cC5wb3N0KFxuICAgICAgICB0aGlzLmZvcm0uYWN0aW9uLmhyZWYsXG4gICAgICAgIHRoaXMuZm9ybS5wb3N0VmFsdWVzXG4gICAgICApO1xuICAgICAgaWYgKHBhZ2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IHJvd3MgPSBwYWdlLiQoJ3RhYmxlLmZvcm1BdmEgdHInKS50b0FycmF5KCk7XG4gICAgICAgIGZvciAoY29uc3Qgcm93IG9mIHJvd3MpIHtcbiAgICAgICAgICBjb25zdCByb3dMYWJlbCA9IHRoaXMucGFyc2VyLnJlbW92ZVRhZ3NIdG1sKFxuICAgICAgICAgICAgcGFnZS4kKHJvdykuZmluZCgndGgnKS5odG1sKClcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnN0IHJvd0NvbnRlbnQgPSB0aGlzLnBhcnNlci5yZW1vdmVUYWdzSHRtbChcbiAgICAgICAgICAgIHBhZ2UuJChyb3cpLmZpbmQoJ3RkJykuaHRtbCgpXG4gICAgICAgICAgKTtcbiAgICAgICAgICBzd2l0Y2ggKHJvd0xhYmVsKSB7XG4gICAgICAgICAgICBjYXNlICdUw610dWxvOic6IHtcbiAgICAgICAgICAgICAgdGhpcy5fdGl0bGUgPSByb3dDb250ZW50O1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhc2UgJ0NvbnRlw7pkbzonOiB7XG4gICAgICAgICAgICAgIHRoaXMuX2NvbnRlbnQgPSByb3dDb250ZW50O1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhc2UgJ0RhdGEgQ2FkYXN0cm86Jzoge1xuICAgICAgICAgICAgICBjb25zdCBkYXRlID0gdGhpcy5wYXJzZXIucGFyc2VEYXRlcyhyb3dDb250ZW50LCAxKTtcblxuICAgICAgICAgICAgICB0aGlzLl9kYXRlID0gZGF0ZVswXTtcblxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAocGFnZS5zdGF0dXNDb2RlID09PSAzMDIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogV2ViY29udGVudCBleHBpcmVkLicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTSUdBQTogVW5leHBlY3RlZCB3ZWJjb250ZW50IHBhZ2Ugc3RhdHVzIGNvZGUuJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAocmV0cnkpIHtcbiAgICAgICAgYXdhaXQgdGhpcy51cGRhdGVJbnN0YW5jZSgpO1xuICAgICAgICByZXR1cm4gdGhpcy5sb2FkV2ViQ29udGVudFBhZ2UoZmFsc2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGdldCBpZCgpOiBzdHJpbmcge1xuICAgIHRoaXMuY2hlY2tJZkl0V2FzQ2xvc2VkKCk7XG4gICAgcmV0dXJuIHRoaXMuZm9ybS5wb3N0VmFsdWVzLmlkO1xuICB9XG59XG4iXX0=